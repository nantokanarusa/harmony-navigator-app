# app.py (v7.0.47 - Final Cache Invalidation Fix & Complete Code)
import streamlit as st
import pandas as pd
import numpy as np
from scipy.spatial.distance import jensenshannon
from datetime import datetime, date, timedelta
import re
import hashlib
import time
import uuid
import itertools
import bcrypt
import base64
import gspread
from google.oauth2.service_account import Credentials
import plotly.graph_objects as go
import plotly.express as px
import pytz

# --- A. å®šæ•°ã¨åŸºæœ¬è¨­å®š ---
st.set_page_config(layout="wide", page_title="Harmony Navigator")
JST = pytz.timezone('Asia/Tokyo')

DOMAINS = ['health', 'relationships', 'meaning', 'autonomy', 'finance', 'leisure', 'competition']
DOMAIN_NAMES_JP_DICT = {
    'health': '1. å¥åº·', 'relationships': '2. äººé–“é–¢ä¿‚', 'meaning': '3. æ„å‘³ãƒ»è²¢çŒ®',
    'autonomy': '4. è‡ªå¾‹ãƒ»æˆé•·', 'finance': '5. çµŒæ¸ˆ', 'leisure': '6. ä½™æš‡ãƒ»å¿ƒç†', 'competition': '7. ç«¶äº‰'
}
DOMAIN_NAMES_JP_VALUES = [DOMAIN_NAMES_JP_DICT[d] for d in DOMAINS]

LONG_ELEMENTS = {
    'health': ['ç¡çœ ', 'é£Ÿäº‹', 'é‹å‹•', 'èº«ä½“çš„å¿«é©ã•', 'æ„Ÿè¦šçš„å¿«æ¥½', 'æ€§çš„æº€è¶³'],
    'relationships': ['å®¶æ—', 'ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ãƒ»æ‹æ„›', 'å‹äºº', 'ç¤¾ä¼šçš„æ‰¿èª', 'åˆ©ä»–æ€§ãƒ»è²¢çŒ®', 'å…±æ„Ÿãƒ»ç¹‹ãŒã‚Š'],
    'meaning': ['ã‚„ã‚ŠãŒã„', 'é”æˆæ„Ÿ', 'ä¿¡å¿µã¨ã®ä¸€è‡´', 'ã‚­ãƒ£ãƒªã‚¢ã®å±•æœ›', 'ç¤¾ä¼šã¸ã®è²¢çŒ®', 'æœ‰èƒ½æ„Ÿ'],
    'autonomy': ['è‡ªç”±ãƒ»è‡ªå·±æ±ºå®š', 'æŒ‘æˆ¦ãƒ»å†’é™º', 'è‡ªå·±æˆé•·ã®å®Ÿæ„Ÿ', 'å¤‰åŒ–ã®äº«å—', 'ç‹¬ç«‹ãƒ»è‡ªå·±ä¿¡é ¼', 'å¥½å¥‡å¿ƒ'],
    'finance': ['çµŒæ¸ˆçš„å®‰å®š', 'çµŒæ¸ˆçš„ä½™è£•', 'åŠ´åƒç’°å¢ƒ', 'ãƒ¯ãƒ¼ã‚¯ãƒ©ã‚¤ãƒ•ãƒãƒ©ãƒ³ã‚¹', 'å…¬æ­£ãªè©•ä¾¡', 'è·æ¥­çš„å®‰å®šæ€§'],
    'leisure': ['å¿ƒã®å¹³ç©', 'è‡ªå·±è‚¯å®šæ„Ÿ', 'å‰µé€ æ€§ã®ç™ºæ®', 'æ„Ÿè¬', 'å¨¯æ¥½ãƒ»æ¥½ã—ã•', 'èŠ¸è¡“ãƒ»è‡ªç„¶'],
    'competition': ['å„ªè¶Šæ„Ÿãƒ»å‹åˆ©']
}
ALL_ELEMENT_COLS = sorted([f's_element_{e}' for d in LONG_ELEMENTS.values() for e in d])
Q_COLS = ['q_' + d for d in DOMAINS]
S_COLS = ['s_' + d for d in DOMAINS]

ELEMENT_DEFINITIONS = {
    'ç¡çœ ': 'è³ªã®è‰¯ã„ç¡çœ ãŒã¨ã‚Œã€æœã€ã™ã£ãã‚Šã¨ç›®è¦šã‚ã‚‰ã‚ŒãŸåº¦åˆã„ã€‚',
    'é£Ÿäº‹': 'æ „é¤Šãƒãƒ©ãƒ³ã‚¹ã®å–ã‚ŒãŸã€ç¾å‘³ã—ã„é£Ÿäº‹ã«æº€è¶³ã§ããŸåº¦åˆã„ã€‚',
    'é‹å‹•': 'ä½“ã‚’å‹•ã‹ã™ç¿’æ…£ãŒã‚ã‚Šã€ãã‚ŒãŒå¿ƒèº«ã®å¿«èª¿ã•ã«ç¹‹ãŒã£ã¦ã„ãŸåº¦åˆã„ã€‚',
    'èº«ä½“çš„å¿«é©ã•': 'æ…¢æ€§çš„ãªç—›ã¿ã‚„ã€æ°—ã«ãªã‚‹ä¸èª¿ãŒãªãã€å¿«é©ã«éã”ã›ãŸåº¦åˆã„ã€‚',
    'æ„Ÿè¦šçš„å¿«æ¥½': 'äº”æ„Ÿã‚’é€šã˜ã¦ã€å¿ƒåœ°ã‚ˆã„ã¨æ„Ÿã˜ã‚‹ç¬é–“ãŒã‚ã£ãŸåº¦åˆã„ã€‚ä¾‹ï¼šæ¸©ã‹ã„ãŠé¢¨å‘‚ã€å¿ƒåœ°ã‚ˆã„éŸ³æ¥½ã€‚',
    'æ€§çš„æº€è¶³': 'è‡ªèº«ã®æ€§çš„ãªæ¬²æ±‚ã‚„ã€ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã¨ã®è¦ªå¯†ã•ã«å¯¾ã—ã¦ã€æº€è¶³æ„ŸãŒã‚ã£ãŸåº¦åˆã„ã€‚',
    'å®¶æ—': 'å®¶æ—ã¨ã®é–“ã«ã€å®‰å®šã—ãŸã€ã‚ã‚‹ã„ã¯æ¸©ã‹ã„é–¢ä¿‚ãŒã‚ã£ãŸåº¦åˆã„ã€‚',
    'ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ãƒ»æ‹æ„›': 'ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã¨ã®é–“ã«ã€æ„›æƒ…ã‚„æ·±ã„ç†è§£ã€ä¿¡é ¼ãŒã‚ã£ãŸåº¦åˆã„ã€‚',
    'å‹äºº': 'æ°—è»½ã«è©±ã›ãŸã‚Šã€æ”¯ãˆåˆãˆãŸã‚Šã™ã‚‹å‹äººãŒãŠã‚Šã€è‰¯ã„é–¢ä¿‚ã‚’ç¯‰ã‘ã¦ã„ãŸåº¦åˆã„ã€‚',
    'ç¤¾ä¼šçš„æ‰¿èª': 'å‘¨å›²ã®äººã€…ï¼ˆè·å ´ã€åœ°åŸŸãªã©ï¼‰ã‹ã‚‰ã€ä¸€å“¡ã¨ã—ã¦èªã‚ã‚‰ã‚Œã€å°Šé‡ã•ã‚Œã¦ã„ã‚‹ã¨æ„Ÿã˜ãŸåº¦åˆã„ã€‚',
    'åˆ©ä»–æ€§ãƒ»è²¢çŒ®': 'è‡ªåˆ†ã®è¡Œå‹•ãŒã€èª°ã‹ã®å½¹ã«ç«‹ã£ãŸã€ã‚ã‚‹ã„ã¯å–œã°ã‚ŒãŸã¨æ„Ÿã˜ãŸåº¦åˆã„ã€‚ä¾‹ï¼šã€Œã‚ã‚ŠãŒã¨ã†ã€ã¨è¨€ã‚ã‚ŒãŸã€‚',
    'å…±æ„Ÿãƒ»ç¹‹ãŒã‚Š': 'ä»–è€…ã®æ°—æŒã¡ã«å¯„ã‚Šæ·»ã£ãŸã‚Šã€é€†ã«å¯„ã‚Šæ·»ã£ã¦ã‚‚ã‚‰ã£ãŸã‚Šã—ã¦ã€äººã¨ã®æ·±ã„ç¹‹ãŒã‚Šã‚’æ„Ÿã˜ãŸåº¦åˆã„ã€‚',
    'ã‚„ã‚ŠãŒã„': 'è‡ªåˆ†ã®ä»•äº‹ã‚„æ´»å‹•ï¼ˆå­¦æ¥­ã€å®¶äº‹ã€è¶£å‘³ãªã©ï¼‰ã«ã€æ„ç¾©ã‚„ç›®çš„ã‚’æ„Ÿã˜ã€å¤¢ä¸­ã«ãªã‚ŒãŸåº¦åˆã„ã€‚',
    'é”æˆæ„Ÿ': 'ä½•ã‹å…·ä½“çš„ãªç›®æ¨™ã‚’é”æˆã—ãŸã‚Šã€ç‰©äº‹ã‚’æœ€å¾Œã¾ã§ã‚„ã‚Šé‚ã’ãŸã‚Šã™ã‚‹çµŒé¨“ãŒã‚ã£ãŸåº¦åˆã„ã€‚',
    'ä¿¡å¿µã¨ã®ä¸€è‡´': 'è‡ªåˆ†ã®ã€Œã“ã†ã‚ã‚ŠãŸã„ã€ã¨ã„ã†ä¾¡å€¤è¦³ã‚„ã€å€«ç†è¦³ã«æ²¿ã£ãŸè¡Œå‹•ãŒã§ããŸåº¦åˆã„ã€‚',
    'ã‚­ãƒ£ãƒªã‚¢ã®å±•æœ›': 'è‡ªåˆ†ã®å°†æ¥ã®ã‚­ãƒ£ãƒªã‚¢ã«å¯¾ã—ã¦ã€å¸Œæœ›ã‚„å‰å‘ããªè¦‹é€šã—ã‚’æŒã¦ã¦ã„ãŸåº¦åˆã„ã€‚',
    'ç¤¾ä¼šã¸ã®è²¢çŒ®': 'è‡ªåˆ†ã®æ´»å‹•ãŒã€æ‰€å±ã™ã‚‹ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã‚„ã€ã‚ˆã‚Šå¤§ããªç¤¾ä¼šã«å¯¾ã—ã¦ã€è‰¯ã„å½±éŸ¿ã‚’ä¸ãˆã¦ã„ã‚‹ã¨æ„Ÿã˜ã‚‰ã‚ŒãŸåº¦åˆã„ã€‚',
    'æœ‰èƒ½æ„Ÿ': 'è‡ªåˆ†ã®ã‚¹ã‚­ãƒ«ã‚„èƒ½åŠ›ã‚’ã€ã†ã¾ãç™ºæ®ã§ãã¦ã„ã‚‹ã¨ã„ã†æ„Ÿè¦šãŒã‚ã£ãŸåº¦åˆã„ã€‚',
    'è‡ªç”±ãƒ»è‡ªå·±æ±ºå®š': 'è‡ªåˆ†ã®äººç”Ÿã«ãŠã‘ã‚‹é‡è¦ãªäº‹æŸ„ã‚’ã€ä»–è€…ã®åœ§åŠ›ã§ã¯ãªãã€è‡ªåˆ†è‡ªèº«ã®æ„å¿—ã§é¸æŠãƒ»æ±ºå®šã§ãã¦ã„ã‚‹ã¨æ„Ÿã˜ãŸåº¦åˆã„ã€‚',
    'æŒ‘æˆ¦ãƒ»å†’é™º': 'æ–°ã—ã„ã“ã¨ã«æŒ‘æˆ¦ã—ãŸã‚Šã€æœªçŸ¥ã®çµŒé¨“ã‚’ã—ãŸã‚Šã—ã¦ã€åˆºæ¿€ã‚„èˆˆå¥®ã‚’æ„Ÿã˜ãŸåº¦åˆã„ã€‚',
    'è‡ªå·±æˆé•·ã®å®Ÿæ„Ÿ': 'ä½•ã‹ã‚’ä¹—ã‚Šè¶ŠãˆãŸã‚Šã€æ–°ã—ã„ã“ã¨ã‚’å­¦ã‚“ã ã‚Šã—ã¦ã€è‡ªåˆ†ãŒæˆé•·ã—ã¦ã„ã‚‹ã¨æ„Ÿã˜ã‚‰ã‚ŒãŸåº¦åˆã„ã€‚',
    'å¤‰åŒ–ã®äº«å—': 'ç’°å¢ƒã®å¤‰åŒ–ã‚„ã€æ–°ã—ã„è€ƒãˆæ–¹ã‚’ã€ãƒã‚¸ãƒ†ã‚£ãƒ–ã«å—ã‘å…¥ã‚Œã€æ¥½ã—ã‚€ã“ã¨ãŒã§ããŸåº¦åˆã„ã€‚',
    'ç‹¬ç«‹ãƒ»è‡ªå·±ä¿¡é ¼': 'è‡ªåˆ†ã®åŠ›ã§ç‰©äº‹ã«å¯¾å‡¦ã§ãã‚‹ã¨ã„ã†ã€è‡ªåˆ†è‡ªèº«ã¸ã®ä¿¡é ¼æ„ŸãŒã‚ã£ãŸåº¦åˆã„ã€‚',
    'å¥½å¥‡å¿ƒ': 'æ§˜ã€…ãªç‰©äº‹ã«å¯¾ã—ã¦ã€çŸ¥çš„ãªå¥½å¥‡å¿ƒã‚’æŒã¡ã€æ¢æ±‚ã™ã‚‹ã“ã¨ã«å–œã³ã‚’æ„Ÿã˜ãŸåº¦åˆã„ã€‚',
    'çµŒæ¸ˆçš„å®‰å®š': 'ã€Œæ¥æœˆã®æ”¯æ‰•ã„ã¯å¤§ä¸ˆå¤«ã‹ãªâ€¦ã€ã¨ã„ã£ãŸã€çŸ­æœŸçš„ãªãŠé‡‘ã®å¿ƒé…ãŒãªã„çŠ¶æ…‹ã€‚',
    'çµŒæ¸ˆçš„ä½™è£•': 'ç”Ÿæ´»å¿…éœ€å“ã ã‘ã§ãªãã€è¶£å‘³ã‚„è‡ªå·±æŠ•è³‡ãªã©ã€äººç”Ÿã‚’è±Šã‹ã«ã™ã‚‹ã“ã¨ã«ã‚‚ãŠé‡‘ã‚’ä½¿ãˆã‚‹çŠ¶æ…‹ã€‚',
    'åŠ´åƒç’°å¢ƒ': 'ç‰©ç†çš„ã«ã‚‚ã€ç²¾ç¥çš„ã«ã‚‚ã€å®‰å…¨ã§ã€å¥åº·çš„ã«åƒã‘ã‚‹ç’°å¢ƒãŒã‚ã£ãŸåº¦åˆã„ã€‚',
    'ãƒ¯ãƒ¼ã‚¯ãƒ©ã‚¤ãƒ•ãƒãƒ©ãƒ³ã‚¹': 'ä»•äº‹ï¼ˆã‚ã‚‹ã„ã¯å­¦æ¥­ï¼‰ã¨ã€ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãªç”Ÿæ´»ã¨ã®é–“ã§ã€è‡ªåˆ†ãŒæœ›ã‚€ãƒãƒ©ãƒ³ã‚¹ãŒå–ã‚Œã¦ã„ãŸåº¦åˆã„ã€‚',
    'å…¬æ­£ãªè©•ä¾¡': 'è‡ªåˆ†ã®åƒãã‚„æˆæœãŒã€æ­£å½“ã«è©•ä¾¡ã•ã‚Œã€å ±é…¬ã«åæ˜ ã•ã‚Œã¦ã„ã‚‹ã¨æ„Ÿã˜ã‚‰ã‚ŒãŸåº¦åˆã„ã€‚',
    'è·æ¥­çš„å®‰å®šæ€§': 'ã€Œã“ã®å…ˆã‚‚ã€ã“ã®ä»•äº‹ã‚’ç¶šã‘ã¦ã„ã‘ã‚‹ã ã‚ã†ã‹ã€ã¨ã„ã£ãŸã€é•·æœŸçš„ãªã‚­ãƒ£ãƒªã‚¢ã‚„åå…¥ã«å¯¾ã™ã‚‹ä¸å®‰ãŒãªã„çŠ¶æ…‹ã€‚',
    'å¿ƒã®å¹³ç©': 'éåº¦ãªä¸å®‰ã‚„ã‚¹ãƒˆãƒ¬ã‚¹ãªãã€ç²¾ç¥çš„ã«å®‰å®šã—ã¦ã„ãŸåº¦åˆã„ã€‚',
    'è‡ªå·±è‚¯å®šæ„Ÿ': 'è‡ªåˆ†ã®é•·æ‰€ã‚‚çŸ­æ‰€ã‚‚å«ã‚ã¦ã€ã‚ã‚Šã®ã¾ã¾ã®è‡ªåˆ†ã‚’ã€è‚¯å®šçš„ã«å—ã‘å…¥ã‚Œã‚‹ã“ã¨ãŒã§ããŸåº¦åˆã„ã€‚',
    'å‰µé€ æ€§ã®ç™ºæ®': 'ä½•ã‹ã‚’å‰µä½œã—ãŸã‚Šã€æ–°ã—ã„ã‚¢ã‚¤ãƒ‡ã‚¢ã‚’æ€ã„ã¤ã„ãŸã‚Šã—ã¦ã€å‰µé€ çš„ãªå–œã³ã‚’æ„Ÿã˜ãŸåº¦åˆã„ã€‚',
    'æ„Ÿè¬': 'æ—¥å¸¸ã®å°ã•ãªå‡ºæ¥äº‹ã‚„ã€å‘¨ã‚Šã®äººã€…ã«å¯¾ã—ã¦ã€è‡ªç„¶ã¨ã€Œã‚ã‚ŠãŒãŸã„ã€ã¨ã„ã†æ°—æŒã¡ãŒæ¹§ã„ãŸåº¦åˆã„ã€‚',
    'å¨¯æ¥½ãƒ»æ¥½ã—ã•': 'è¶£å‘³ã«æ²¡é ­ã—ãŸã‚Šã€å‹äººã¨ç¬‘ã„åˆã£ãŸã‚Šã€ç´”ç²‹ã«ã€Œæ¥½ã—ã„ã€ã¨æ„Ÿã˜ã‚‹æ™‚é–“ãŒã‚ã£ãŸåº¦åˆã„ã€‚',
    'èŠ¸è¡“ãƒ»è‡ªç„¶': 'ç¾ã—ã„éŸ³æ¥½ã‚„èŠ¸è¡“ã€ã‚ã‚‹ã„ã¯é›„å¤§ãªè‡ªç„¶ã«è§¦ã‚Œã¦ã€å¿ƒãŒå‹•ã‹ã•ã‚ŒãŸã‚Šã€è±Šã‹ã«ãªã£ãŸã‚Šã™ã‚‹çµŒé¨“ãŒã‚ã£ãŸåº¦åˆã„ã€‚',
    'å„ªè¶Šæ„Ÿãƒ»å‹åˆ©': 'ä»–è€…ã¨ã®æ¯”è¼ƒã‚„ç«¶äº‰ã«ãŠã„ã¦ã€å„ªä½ã«ç«‹ã¦ãŸã¨æ„Ÿã˜ã€æº€è¶³æ„Ÿã‚’å¾—ãŸã€‚'
}
EXPANDER_TEXTS = {
    'q_t': """
        #### â–¼ ã“ã‚Œã¯ã€ä½•ã®ãŸã‚ã«è¨­å®šã™ã‚‹ã®ï¼Ÿ
        ã“ã‚Œã¯ã€ã‚ãªãŸã®äººç”Ÿã¨ã„ã†èˆªæµ·ã§ã€**ã€Œã©ã®å®å³¶ã‚’ç›®æŒ‡ã™ã‹ã€**ã‚’æ±ºã‚ã‚‹ã€æœ€ã‚‚é‡è¦ãªç¾…é‡ç›¤ã§ã™ã€‚ã‚ãªãŸãŒã€Œä½•ã‚’å¤§åˆ‡ã«ã—ãŸã„ã‹ã€ã¨ã„ã†**ã‚ãªãŸè‡ªèº«ã®ä¾¡å€¤è¦³ï¼ˆæƒ…å ±ç§©åºï¼‰**ã‚’ã€æ•°å€¤ã§è¡¨ç¾ã—ã¾ã™ã€‚
        ã“ã®è¨­å®šãŒã€ã‚ãªãŸã®æ—¥ã€…ã®çµŒé¨“ã‚’è©•ä¾¡ã™ã‚‹ãŸã‚ã®**å€‹äººçš„ãªã€ã‚‚ã®ã•ã—ã€**ã¨ãªã‚Šã¾ã™ã€‚ã“ã®ã€Œã‚‚ã®ã•ã—ã€ãŒãªã‘ã‚Œã°ã€è‡ªåˆ†ã®èˆªæµ·ãŒé †èª¿ãªã®ã‹ã€èˆªè·¯ã‹ã‚‰å¤–ã‚Œã¦ã„ã‚‹ã®ã‹ã‚’çŸ¥ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚
        ï¼ˆé€±ã«ä¸€åº¦ãªã©ã€å®šæœŸçš„ã«è¦‹ç›´ã™ã®ãŒãŠã™ã™ã‚ã§ã™ï¼‰
        """,
    's_t': """
        #### â–¼ ã“ã‚Œã¯ã€ä½•ã®ãŸã‚ã«è¨˜éŒ²ã™ã‚‹ã®ï¼Ÿ
        ã“ã“ã§ã¯ã€ã‚ãªãŸã®**å®Ÿéš›ã®çµŒé¨“ï¼ˆå®Ÿè·µç§©åºï¼‰**ã‚’è¨˜éŒ²ã—ã¾ã™ã€‚
        é ­ã§è€ƒãˆã‚‹ç†æƒ³ã§ã¯ãªãã€**ä»Šæ—¥ä¸€æ—¥ã‚’æŒ¯ã‚Šè¿”ã£ã¦ã€å®Ÿéš›ã«ã©ã†æ„Ÿã˜ãŸã‹**ã‚’ã€å„é …ç›®ã®ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã§ç›´æ„Ÿçš„ã«è©•ä¾¡ã—ã¦ãã ã•ã„ã€‚
        ã“ã®ã€Œå®Ÿéš›ã®çµŒé¨“ã€ã®è¨˜éŒ²ã¨ã€å…ˆã»ã©è¨­å®šã—ãŸã€Œã‚ãªãŸã®ä¾¡å€¤è¦³ã€ã¨ã„ã†ç¾…é‡ç›¤ã¨ã‚’æ¯”ã¹ã‚‹ã“ã¨ã§ã€ä¸¡è€…ã®é–“ã«å­˜åœ¨ã™ã‚‹**ã€ã‚ºãƒ¬ã€**ã‚’åˆã‚ã¦ç™ºè¦‹ã§ãã¾ã™ã€‚ã“ã®ã€ã‚ºãƒ¬ã€ã«æ°—ã¥ãã“ã¨ã“ããŒã€è‡ªå·±ç†è§£ã¨æˆé•·ã®ç¬¬ä¸€æ­©ã§ã™ã€‚
        """,
    'g_t': """
        #### â–¼ ã“ã‚Œã¯ã€ãªãœå¿…è¦ãªã®ï¼Ÿ
        ã“ã®é …ç›®ã¯ã€**ã‚ãªãŸã®ç›´æ„Ÿçš„ãªå…¨ä½“è©•ä¾¡**ã§ã™ã€‚
        ç´°ã‹ã„ã“ã¨ã¯ä¸€åº¦å¿˜ã‚Œã¦ã€ã€Œã§ã€è‰²ã€…ã‚ã£ãŸã‘ã©ã€ä»Šæ—¥ã®è‡ªåˆ†ã€å…¨ä½“ã¨ã—ã¦ã¯ä½•ç‚¹ã ã£ãŸã‹ãªï¼Ÿã€ã¨ã„ã†æ„Ÿè¦šã‚’ã€ä¸€ã¤ã®ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã§è¡¨ç¾ã—ã¦ãã ã•ã„ã€‚
        ã‚¢ãƒ—ãƒªãŒè¨ˆç®—ã—ãŸã‚¹ã‚³ã‚¢ï¼ˆHï¼‰ã¨ã€ã‚ãªãŸã®ç›´æ„Ÿï¼ˆGï¼‰ãŒã©ã‚Œã ã‘ä¸€è‡´ã—ã¦ã„ã‚‹ã‹ã€ã‚ã‚‹ã„ã¯**ã‚ºãƒ¬ã¦ã„ã‚‹ã‹**ã‚’çŸ¥ã‚‹ãŸã‚ã®ã€éå¸¸ã«é‡è¦ãªæ‰‹ãŒã‹ã‚Šã¨ãªã‚Šã¾ã™ã€‚
        **ã€è¨ˆç®—ä¸Šã¯è‰¯ã„ã¯ãšãªã®ã«ã€ãªãœã‹æ°—åˆ†ãŒæ™´ã‚Œãªã„ã€**ã¨ã„ã£ãŸã€è¨€è‘‰ã«ãªã‚‰ãªã„é•å’Œæ„Ÿã‚„ã€**ã€äºˆæƒ³å¤–ã«æ¥½ã—ã‹ã£ãŸï¼ã€**ã¨ã„ã†å¬‰ã—ã„ç™ºè¦‹ãªã©ã€è²´é‡ãªè‡ªå·±ç™ºè¦‹ã®ãã£ã‹ã‘ã«ãªã‚Šã¾ã™ã€‚
        """,
    'event_log': """
        #### â–¼ ãªãœæ›¸ãã®ãŒãŠã™ã™ã‚ï¼Ÿ
        ã“ã‚Œã¯ã€ã‚ãªãŸã®èˆªæµ·ã®**ç‰©èª**ã‚’è¨˜éŒ²ã™ã‚‹å ´æ‰€ã§ã™ã€‚
        **ã€èª°ã¨ä¼šã£ãŸã€ã€ä½•ã‚’ã—ãŸã€ã€ä½•ã‚’æ„Ÿã˜ãŸã€**ã¨ã„ã£ãŸå…·ä½“çš„ãªå‡ºæ¥äº‹ã‚„æ„Ÿæƒ…ã‚’ã€ä¸€è¨€ã§ã‚‚è‰¯ã„ã®ã§æ›¸ãç•™ã‚ã¦ã¿ã¾ã—ã‚‡ã†ã€‚
        å¾Œã§ã‚°ãƒ©ãƒ•ã‚’è¦‹ãŸã¨ãã«ã€æ•°å€¤ã ã‘ã§ã¯åˆ†ã‹ã‚‰ãªã„ã€**å¹¸ç¦åº¦ã®æµ®ãæ²ˆã¿ã®ã€ãªãœï¼Ÿã€**ã‚’è§£ãæ˜ã‹ã™éµã¨ãªã‚Šã¾ã™ã€‚ã‚°ãƒ©ãƒ•ã®ã€Œå±±ã€ã‚„ã€Œè°·ã€ã¨ã€ã“ã®è¨˜éŒ²ã‚’çµã³ã¤ã‘ã‚‹ã“ã¨ã§ã€ã‚ãªãŸã®å¹¸ç¦ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒã‚ˆã‚Šé®®æ˜ã«è¦‹ãˆã¦ãã¾ã™ã€‚
        """,
    'dashboard': """
        **ã€èˆªæµ·ãƒãƒ£ãƒ¼ãƒˆã§ã€ä½•ãŒã‚ã‹ã‚‹ã®ï¼Ÿã€‘**

        ã“ã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã¯ã€ã‚ãªãŸã®äººç”Ÿã¨ã„ã†èˆªæµ·ã®**ã€Œç¾åœ¨åœ°ã€**ã¨**ã€Œèˆªè·¡ã€**ã€ãã—ã¦**ã€Œç¾…é‡ç›¤ã®å‘ãã€**ã‚’ã€å¤šè§’çš„ã«å¯è¦–åŒ–ã™ã‚‹è¨ˆå™¨ç›¤ã§ã™ã€‚

        ---
        
        #### 1. **èª¿å’Œåº¦(H)ã®æ¨ç§»** - ã‚ãªãŸã®å¿ƒã®å¤©æ°—å›³
        - **ã“ã‚Œã¯ä½•ï¼Ÿ**: ã‚ãªãŸã®æ—¥ã€…ã®å¹¸ç¦åº¦ã®**æ™‚é–“çš„ãªã€Œå¤‰å‹•ã®ç‰©èªã€**ã§ã™ã€‚
        - **èª­ã¿æ–¹**: ã‚°ãƒ©ãƒ•ã®ç·šãŒä¸Šã«ã‚ã‚Œã°ã€Œèª¿å’ŒãŒå–ã‚Œã¦ã„ãŸæ—¥ã€ã€ä¸‹ã«ã‚ã‚Œã°ã€Œã‚ºãƒ¬ãŒå¤§ãã‹ã£ãŸæ—¥ã€ã§ã™ã€‚ã‚¤ãƒ™ãƒ³ãƒˆãƒ­ã‚°ã¨ç…§ã‚‰ã—åˆã‚ã›ã‚‹ã“ã¨ã§ã€ã€Œä½•ãŒã€ã‚ãªãŸã®å¹¸ç¦åº¦ã‚’å·¦å³ã™ã‚‹ã®ã‹ï¼Ÿã€ã¨ã„ã†ã€ã‚ãªãŸã ã‘ã®å› æœé–¢ä¿‚ã‚’ç™ºè¦‹ã§ãã¾ã™ã€‚

        ---

        #### 2. **æ§‹é€ åˆ†æï¼šã‚ãªãŸã®ä¾¡å€¤è¦³ã¨çµŒé¨“** - å¿ƒã®ãƒ¬ãƒ³ãƒˆã‚²ãƒ³å†™çœŸ
        ã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¯ã€æœŸé–“ä¸­ã®ã‚ãªãŸã®å¹³å‡çš„ãªå¿ƒã®ã®çŠ¶æ…‹ã‚’ã€**æ§‹é€ çš„**ã«åˆ†æã—ã¾ã™ã€‚
        
        - **ä¾¡å€¤è¦³ vs çµŒé¨“ ãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒãƒ£ãƒ¼ãƒˆ**:
            - **ã“ã‚Œã¯ä½•ï¼Ÿ**: ã‚ãªãŸãŒ**ã€Œä½•ã‚’å¤§åˆ‡ã«ã—ãŸã„ã‹ï¼ˆé’ã„ç·šï¼‰ã€**ã¨ã„ã†ä¾¡å€¤è¦³ã®å½¢ã¨ã€**ã€Œå®Ÿéš›ã«ä½•ã‚’çµŒé¨“ã—ãŸã‹ï¼ˆç·‘ã®ã‚¨ãƒªã‚¢ï¼‰ã€**ã¨ã„ã†æ—¥ã€…ã®å……è¶³ã®å½¢ã‚’é‡ã­åˆã‚ã›ãŸã‚‚ã®ã§ã™ã€‚
            - **èª­ã¿æ–¹**:
                - **é’ã„ç·š (ã‚ãªãŸã®ä¾¡å€¤è¦³)**: ã‚ãªãŸãŒã€Œä½•ã‚’å¤§åˆ‡ã«ã—ãŸã„ã‹ã€ã¨ã„ã†ä¾¡å€¤è¦³($q_t$)ã®å½¢ã§ã™ã€‚å°–ã£ã¦ã„ã‚‹æ–¹å‘ã»ã©ã€ã‚ãªãŸãŒå¼·ãä¾¡å€¤ã‚’ç½®ã„ã¦ã„ã‚‹é ˜åŸŸã§ã™ã€‚
                - **ç·‘ã®ã‚¨ãƒªã‚¢ (ã‚ãªãŸã®çµŒé¨“)**: ãã®ä¾¡å€¤è¦³ã«å¯¾ã—ã¦ã€**ã€Œå®Ÿéš›ã«çµŒé¨“ã—ãŸå……è¶³ã€**($s_t$)ã®å½¢ã§ã™ã€‚
                - **å½¢ã®ã‚ºãƒ¬**: ã“ã®äºŒã¤ã®å½¢ã®**ä¸ä¸€è‡´**ã“ããŒã€ã‚ãªãŸã®äººç”Ÿã«ãŠã‘ã‚‹æ§‹é€ çš„ãª**ã€ã‚ºãƒ¬ã€**ã§ã™ã€‚ã€Œä¾¡å€¤è¦³ã§ã¯äººé–“é–¢ä¿‚ã‚’é‡è¦–ã—ã¦ã„ã‚‹ã®ã«ã€çµŒé¨“ãŒè¿½ã„ã¤ã„ã¦ã„ãªã„â€¦ã€ã¨ã„ã£ãŸçŠ¶æ³ãŒä¸€ç›®ã§ã‚ã‹ã‚Šã¾ã™ã€‚

        - **ä¾¡å€¤è¦³-çµŒé¨“ ã‚®ãƒ£ãƒƒãƒ—åˆ†æ (æ£’ã‚°ãƒ©ãƒ•)**:
            - **ã“ã‚Œã¯ä½•ï¼Ÿ**: å„é ˜åŸŸã§ã€ã€Œã‚ãªãŸã®ä¾¡å€¤è¦³ã®æ§‹æˆæ¯”ã€ã‹ã‚‰ã€Œã‚ãªãŸã®çµŒé¨“ã®æ§‹æˆæ¯”ã€ã‚’å·®ã—å¼•ã„ãŸ**ã€ã‚ºãƒ¬ã®é‡ã€**ã‚’å¯è¦–åŒ–ã—ãŸã‚‚ã®ã§ã™ã€‚
            - **èª­ã¿æ–¹**:
                - **ãƒ—ãƒ©ã‚¹ã®æ£’ (èµ¤è‰²ç³»)**: **ã€Œä¾¡å€¤è¦³ > çµŒé¨“ã€**ã€‚ã‚ãªãŸãŒã€Œå¤§åˆ‡ã«ã—ãŸã„ã¨æ€ã£ã¦ã„ã‚‹ã®ã«ã€çµŒé¨“ãŒè¿½ã„ã¤ã„ã¦ã„ãªã„ã€é ˜åŸŸã§ã™ã€‚ã“ã“ãŒã€ã‚ãªãŸã®**æœ€å¤§ã®èª²é¡Œã§ã‚ã‚Šã€æˆé•·ã®ãƒãƒ£ãƒ³ã‚¹**ãŒçœ ã‚‹å ´æ‰€ã§ã™ã€‚
                - **ãƒã‚¤ãƒŠã‚¹ã®æ£’ (é’è‰²ç³»)**: **ã€ŒçµŒé¨“ > ä¾¡å€¤è¦³ã€**ã€‚ã‚ãªãŸãŒã€Œã•ã»ã©é‡è¦–ã—ã¦ã„ãªã„ã®ã«ã€å¤šãã®æ™‚é–“ã‚„ã‚¨ãƒãƒ«ã‚®ãƒ¼ã‚’è²»ã‚„ã—ã¦ã„ã‚‹ã€å¯èƒ½æ€§ã®ã‚ã‚‹é ˜åŸŸã§ã™ã€‚è¦‹ç›´ã—ã®ãƒ’ãƒ³ãƒˆã«ãªã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

        ---

        #### 3. **æœŸé–“åˆ†æã¨RHI** - èˆªæµ·ã®ç·åˆè©•ä¾¡
        - **ã“ã‚Œã¯ä½•ï¼Ÿ**: ã‚ãªãŸã®èˆªæµ·ã®**ç·åˆçš„ãªãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹**ã‚’è©•ä¾¡ã—ã¾ã™ã€‚
        - **èª­ã¿æ–¹**:
            - **å¹³å‡èª¿å’Œåº¦ (HÌ„)**: ã“ã®æœŸé–“ã®ã€ã‚ãªãŸã®å¹¸ç¦ã®**å¹³å‡ç‚¹**ã§ã™ã€‚
            - **RHI (ãƒªã‚¹ã‚¯èª¿æ•´æ¸ˆãƒ»å¹¸ç¦æŒ‡æ•°)**: å¹³å‡ç‚¹ã‹ã‚‰ã€**å¤‰å‹•ã¨ä¸èª¿ã®ãƒªã‚¹ã‚¯**ã‚’å·®ã—å¼•ã„ãŸã€çœŸã®ã€å¹¸ç¦ã®å®ŸåŠ›å€¤ã€ã§ã™ã€‚ã“ã®å€¤ãŒé«˜ã„ã»ã©ã€ã‚ãªãŸã®å¹¸ç¦ãŒ**æŒç¶šå¯èƒ½**ã§ã€é€†å¢ƒã«å¼·ã„ï¼ˆãƒ­ãƒã‚¹ãƒˆãªï¼‰çŠ¶æ…‹ã§ã‚ã‚‹ã“ã¨ã‚’ç¤ºã—ã¾ã™ã€‚
        """
}
DEMOGRAPHIC_OPTIONS = {
    'age_group': ['æœªé¸æŠ', '19æ­³ä»¥ä¸‹', '20-29æ­³', '30-39æ­³', '40-49æ­³', '50-59æ­³', '60æ­³ä»¥ä¸Š'],
    'gender': ['æœªé¸æŠ', 'ç”·æ€§', 'å¥³æ€§', 'ãã®ä»–', 'å›ç­”ã—ãªã„'],
    'occupation_category': ['æœªé¸æŠ', 'çµŒå–¶è€…ãƒ»å½¹å“¡', 'ä¼šç¤¾å“¡ï¼ˆç·åˆè·ï¼‰', 'ä¼šç¤¾å“¡ï¼ˆä¸€èˆ¬è·ï¼‰', 'å…¬å‹™å“¡', 'å°‚é–€è·ï¼ˆåŒ»å¸«ã€å¼è­·å£«ãªã©ï¼‰', 'è‡ªå–¶æ¥­ãƒ»ãƒ•ãƒªãƒ¼ãƒ©ãƒ³ã‚¹', 'å­¦ç”Ÿ', 'ä¸»å©¦ãƒ»ä¸»å¤«', 'é€€è·ãƒ»ç„¡è·', 'ãã®ä»–'],
    'income_range': ['æœªé¸æŠ', '200ä¸‡å††æœªæº€', '200-400ä¸‡å††æœªæº€', '400-600ä¸‡å††æœªæº€', '600-800ä¸‡å††æœªæº€', '800-1000ä¸‡å††æœªæº€', '1000ä¸‡å††ä»¥ä¸Š', 'å›ç­”ã—ãªã„'],
    'marital_status': ['æœªé¸æŠ', 'æœªå©š', 'æ—¢å©š', 'é›¢å©šãƒ»æ­»åˆ¥', 'ãã®ä»–'],
    'has_children': ['æœªé¸æŠ', 'ã„ãªã„', 'ã„ã‚‹'],
    'living_situation': ['æœªé¸æŠ', 'ä¸€äººæš®ã‚‰ã—', 'ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã¨åŒå±…', 'å®¶æ—ï¼ˆè¦ªãƒ»å­ãƒ»å…„å¼Ÿãªã©ï¼‰ã¨åŒå±…', 'å‹äººãƒ»ãã®ä»–ã¨ã‚·ã‚§ã‚¢', 'ãã®ä»–'],
    'chronic_illness': ['æœªé¸æŠ', 'ãªã„', 'ã‚ã‚‹'],
    'country': ['æœªé¸æŠ', 'æ—¥æœ¬', 'ã‚¢ãƒ¡ãƒªã‚«åˆè¡†å›½', 'ãã®ä»–']
}


# --- B. æš—å·åŒ–ã‚¨ãƒ³ã‚¸ãƒ³ ---
class EncryptionManager:
    def __init__(self, password: str):
        self.password_bytes = password.encode('utf-8')
        self.key = hashlib.sha256(self.password_bytes).digest()

    @staticmethod
    def hash_password(password: str) -> str:
        password_bytes = password.encode('utf-8')
        salt = bcrypt.gensalt()
        hashed_bytes = bcrypt.hashpw(password_bytes, salt)
        return hashed_bytes.decode('utf-8')

    @staticmethod
    def check_password(password: str, hashed_password: str) -> bool:
        password_bytes = password.encode('utf-8')
        hashed_bytes = hashed_password.encode('utf-8')
        try:
            return bcrypt.checkpw(password_bytes, hashed_bytes)
        except (ValueError, TypeError):
            return False

    def encrypt_log(self, log_text: str) -> str:
        if not log_text:
            return ""
        encrypted_bytes = bytes([b ^ self.key[i % len(self.key)] for i, b in enumerate(log_text.encode('utf-8'))])
        return base64.b64encode(encrypted_bytes).decode('utf-8')

    def decrypt_log(self, encrypted_log: str) -> str:
        if not encrypted_log or pd.isna(encrypted_log):
            return ""
        try:
            encrypted_bytes = base64.b64decode(encrypted_log.encode('utf-8'))
            decrypted_bytes = bytes([b ^ self.key[i % len(self.key)] for i, b in enumerate(encrypted_bytes)])
            return decrypted_bytes.decode('utf-8')
        except Exception:
            return "[å¾©å·ã«å¤±æ•—ã—ã¾ã—ãŸ]"

# --- C. ã‚³ã‚¢è¨ˆç®— & ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•° ---
def calculate_s_domains_from_row(row: pd.Series) -> pd.Series:
    s_domain_scores = {}
    
    for domain, elements in LONG_ELEMENTS.items():
        domain_scores_list = []
        for e in elements:
            col = f's_element_{e}'
            if col in row and pd.notna(row[col]):
                domain_scores_list.append(row[col])
        
        if domain_scores_list:
            s_domain_scores['s_' + domain] = int(round(np.mean(domain_scores_list)))
        else:
            s_domain_scores['s_' + domain] = row.get('s_' + domain, np.nan)
            
    return pd.Series(s_domain_scores)

@st.cache_data
def calculate_metrics(df: pd.DataFrame, alpha: float = 0.6) -> pd.DataFrame:
    df_copy = df.copy()
    if df_copy.empty:
        return df_copy

    def get_s_domains_based_on_mode(row):
        if row.get('mode') == 'deep':
            return calculate_s_domains_from_row(row)
        else:
            return row[S_COLS]

    s_domain_updates = df_copy.apply(get_s_domains_based_on_mode, axis=1)
    df_copy[S_COLS] = s_domain_updates

    for col in Q_COLS + S_COLS:
         if col in df_copy.columns:
            df_copy[col] = df_copy[col].fillna(0)
    
    s_vectors_normalized = df_copy[S_COLS].values / 100.0
    q_vectors = df_copy[Q_COLS].values / 100.0
    
    df_copy['S'] = np.nansum(q_vectors * s_vectors_normalized, axis=1)
    
    def calculate_unity(row):
        q_vec = row[Q_COLS].values.astype(float)
        s_vec_raw = row[S_COLS].values.astype(float)
        
        if np.sum(q_vec) == 0: return 0.0
        q_vec_norm = q_vec / np.sum(q_vec)
        
        if np.sum(s_vec_raw) == 0: return 0.0
        s_tilde = s_vec_raw / np.sum(s_vec_raw)
        
        jsd_sqrt = jensenshannon(q_vec_norm, s_tilde)
        jsd = float(jsd_sqrt) ** 2
        return 1.0 - jsd

    df_copy['U'] = df_copy.apply(calculate_unity, axis=1)
    df_copy['H'] = alpha * df_copy['S'] + (1 - alpha) * df_copy['U']
    
    return df_copy

def calculate_ahp_weights(comparisons: dict, items: list) -> np.ndarray:
    n = len(items)
    matrix = np.ones((n, n), dtype=float)
    item_map = {item: i for i, item in enumerate(items)}

    for (item1, item2), winner in comparisons.items():
        i, j = item_map[item1], item_map[item2]
        if winner == item1:
            matrix[i, j] = 3.0
            matrix[j, i] = 1.0 / 3.0
        elif winner == item2:
            matrix[i, j] = 1.0 / 3.0
            matrix[j, i] = 3.0

    eigenvalues, eigenvectors = np.linalg.eig(matrix)
    max_eigenvalue_index = np.argmax(np.real(eigenvalues))
    principal_eigenvector = np.real(eigenvectors[:, max_eigenvalue_index])
    weights = principal_eigenvector / np.sum(principal_eigenvector)
    weights = np.clip(weights, 0, None)
    if weights.sum() == 0:
        weights = np.ones_like(weights) / len(weights)
    
    int_weights = (weights * 100).round().astype(int)
    diff = 100 - np.sum(int_weights)
    if diff != 0:
        int_weights[np.argmax(int_weights)] += diff
        
    return int_weights

def analyze_discrepancy(df_processed: pd.DataFrame):
    df_analysis = df_processed.dropna(subset=['H', 'g_happiness']).copy()
    
    if df_analysis.empty:
        return

    latest_record = df_analysis.iloc[-1]
    latest_h = float(latest_record['H']) * 100.0
    latest_g = float(latest_record['g_happiness'])
    latest_gap = latest_g - latest_h

    st.subheader("ğŸ’¡ ã‚¤ãƒ³ã‚µã‚¤ãƒˆãƒ»ã‚¨ãƒ³ã‚¸ãƒ³")
    
    if len(df_analysis) < 2:
        with st.expander("â–¼ ã“ã‚Œã¯ã€åˆæ—¥å°‚ç”¨ã®ç°¡æ˜“è¨ºæ–­ã§ã™", expanded=True):
            st.info("ğŸ“Š 2æ—¥ä»¥ä¸Šè¨˜éŒ²ã‚’ç¶šã‘ã‚‹ã¨ã€ã‚ãªãŸã®éå»ãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ã„ãŸã€ã‚ˆã‚Šå€‹äººåŒ–ã•ã‚ŒãŸçµ±è¨ˆçš„è¨ºæ–­ãŒæœ‰åŠ¹ã«ãªã‚Šã¾ã™ã€‚")
            
            fixed_threshold = 20 
            if latest_gap > fixed_threshold:
                st.info(f"""
                    **ã€å¹¸ç¦ãªã‚µãƒ—ãƒ©ã‚¤ã‚ºã®äºˆæ„Ÿï¼ğŸ‰ã€‘**
                    ã‚ãªãŸã®**å®Ÿæ„Ÿï¼ˆG = {int(latest_g)}ç‚¹ï¼‰**ã¯ã€ãƒ¢ãƒ‡ãƒ«ãŒç®—å‡ºã—ãŸ**èª¿å’Œåº¦æŒ‡æ•°ï¼ˆH = {int(latest_h)}ç‚¹ / 100ç‚¹æº€ç‚¹æ›ç®—ï¼‰**ã‚’ä¸Šå›ã£ã¦ã„ã¾ã™ã€‚
                    ã‚‚ã—ã‹ã—ãŸã‚‰ã€ã‚ãªãŸãŒã¾ã æ„è­˜ã—ã¦ã„ãªã„ã€ç´ æ™´ã‚‰ã—ã„å–œã³ã®æºæ³‰ãŒã‚ã£ãŸã®ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã­ã€‚
                    """)
            elif latest_gap < -fixed_threshold:
                st.warning(f"""
                    **ã€éš ã‚ŒãŸä¸æº€ã®ã‚µã‚¤ãƒ³ï¼ŸğŸ¤”ã€‘**
                    ã‚ãªãŸã®**å®Ÿæ„Ÿï¼ˆG = {int(latest_g)}ç‚¹ï¼‰**ã¯ã€ãƒ¢ãƒ‡ãƒ«ãŒç®—å‡ºã—ãŸ**èª¿å’Œåº¦æŒ‡æ•°ï¼ˆH = {int(latest_h)}ç‚¹ / 100ç‚¹æº€ç‚¹æ›ç®—ï¼‰**ã‚’ä¸‹å›ã£ã¦ã„ã¾ã™ã€‚
                    ä½•ã‹è¦‹éã”ã—ã¦ã„ã‚‹ã‚¹ãƒˆãƒ¬ã‚¹è¦å› ã‚„ã€ã‚ãªãŸã®ä¾¡å€¤è¦³ã¨çµŒé¨“ã®é–“ã«å°ã•ãªã‚ºãƒ¬ãŒã‚ã‚‹ã®ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚
                    """)
            else:
                st.success(f"""
                    **ã€é †èª¿ãªåˆæ—¥ã§ã™ï¼âœ¨ã€‘**
                    ã‚ãªãŸã®**å®Ÿæ„Ÿï¼ˆG = {int(latest_g)}ç‚¹ï¼‰**ã¨ã€ãƒ¢ãƒ‡ãƒ«ãŒç®—å‡ºã—ãŸ**èª¿å’Œåº¦æŒ‡æ•°ï¼ˆH = {int(latest_h)}ç‚¹ / 100ç‚¹æº€ç‚¹æ›ç®—ï¼‰**ã¯ã€ã‚ˆãä¸€è‡´ã—ã¦ã„ã¾ã™ã€‚
                    ç´ æ™´ã‚‰ã—ã„ã‚¹ã‚¿ãƒ¼ãƒˆã§ã™ï¼
                    """)
    else:
        df_analysis['gap'] = df_analysis['g_happiness'] - (df_analysis['H'] * 100.0)
        std_gap = df_analysis['gap'].std()
        dynamic_threshold = max(15, 1.0 * std_gap) 

        with st.expander("â–¼ ã“ã‚Œã¯ã€ã‚ãªãŸã®éå»ãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ã„ãŸçµ±è¨ˆçš„è¨ºæ–­ã§ã™", expanded=True):
            if latest_gap > dynamic_threshold:
                st.info(f"""
                    **ã€å¹¸ç¦ãªã‚µãƒ—ãƒ©ã‚¤ã‚ºï¼ğŸ‰ã€‘**
                    ã‚ãªãŸã®**å®Ÿæ„Ÿï¼ˆG = {int(latest_g)}ç‚¹ï¼‰**ã¯ã€ãƒ¢ãƒ‡ãƒ«ãŒç®—å‡ºã—ãŸ**èª¿å’Œåº¦æŒ‡æ•°ï¼ˆH = {int(latest_h)}ç‚¹ / 100ç‚¹æº€ç‚¹æ›ç®—ï¼‰**ã‚’ã€ã‚ãªãŸã®**æ™®æ®µã®ãƒ–ãƒ¬å¹…ï¼ˆ{dynamic_threshold:.1f}ç‚¹ï¼‰**ä»¥ä¸Šã«å¤§ããä¸Šå›ã‚Šã¾ã—ãŸã€‚
                    ã“ã‚Œã¯ã€ã‚ãªãŸãŒ**ã¾ã è¨€è‘‰ã«ã§ãã¦ã„ãªã„ã€æ–°ã—ã„ä¾¡å€¤è¦³**ã‚’ç™ºè¦‹ã—ãŸã‚µã‚¤ãƒ³ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚
                    **å•ã„ï¼š** ä»Šæ—¥ã®è¨˜éŒ²ã‚’æŒ¯ã‚Šè¿”ã‚Šã€ã‚ãªãŸãŒè¨­å®šã—ãŸä¾¡å€¤è¦³ï¼ˆq_tï¼‰ã§ã¯æ‰ãˆãã‚Œã¦ã„ãªã„ã€äºˆæœŸã›ã¬å–œã³ã®æºæ³‰ã¯ä½•ã ã£ãŸã§ã—ã‚‡ã†ã‹ï¼Ÿ
                    """)
            elif latest_gap < -dynamic_threshold:
                st.warning(f"""
                    **ã€éš ã‚ŒãŸä¸æº€ï¼ŸğŸ¤”ã€‘**
                    ã‚ãªãŸã®**å®Ÿæ„Ÿï¼ˆG = {int(latest_g)}ç‚¹ï¼‰**ã¯ã€ãƒ¢ãƒ‡ãƒ«ãŒç®—å‡ºã—ãŸ**èª¿å’Œåº¦æŒ‡æ•°ï¼ˆH = {int(latest_h)}ç‚¹ / 100ç‚¹æº€ç‚¹æ›ç®—ï¼‰**ã‚’ã€ã‚ãªãŸã®**æ™®æ®µã®ãƒ–ãƒ¬å¹…ï¼ˆ{dynamic_threshold:.1f}ç‚¹ï¼‰**ä»¥ä¸Šã«å¤§ããä¸‹å›ã‚Šã¾ã—ãŸã€‚
                    ä¾¡å€¤è¦³ã«æ²¿ã£ãŸç”Ÿæ´»ã®ã¯ãšãªã®ã«ã€ä½•ã‹ãŒæº€ãŸã•ã‚Œã¦ã„ãªã„ã‚ˆã†ã§ã™ã€‚è¦‹éã”ã—ã¦ã„ã‚‹**ã‚¹ãƒˆãƒ¬ã‚¹è¦å› ã‚„ã€ã‚ãªãŸã®ä¾¡å€¤è¦³ã¨çµŒé¨“ã®é–“ã«å°ã•ãªã‚ºãƒ¬**ãŒã‚ã‚‹ã®ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚
                    **å•ã„ï¼š** ä»Šæ—¥ã®è¨˜éŒ²ã‚’æŒ¯ã‚Šè¿”ã‚Šã€ã‚ãªãŸã®å¹¸ç¦æ„Ÿã‚’é™ã‹ã«è•ã‚“ã§ã„ãŸã€Œè¦‹ãˆãªã„é‡ã‚Šã€ã¯ä½•ã ã£ãŸã§ã—ã‚‡ã†ã‹ï¼Ÿ
                    """)
            else:
                st.success(f"""
                    **ã€é †èª¿ãªèˆªæµ·ã§ã™ï¼âœ¨ã€‘**
                    ã‚ãªãŸã®**å®Ÿæ„Ÿï¼ˆG = {int(latest_g)}ç‚¹ï¼‰**ã¨ã€ãƒ¢ãƒ‡ãƒ«ãŒç®—å‡ºã—ãŸ**èª¿å’Œåº¦æŒ‡æ•°ï¼ˆH = {int(latest_h)}ç‚¹ / 100ç‚¹æº€ç‚¹æ›ç®—ï¼‰**ã¯ã€ã‚ˆãä¸€è‡´ã—ã¦ã„ã¾ã™ã€‚
                    ã‚ãªãŸã®è‡ªå·±èªè­˜ã¨ã€å®Ÿéš›ã®çµŒé¨“ãŒã€ã†ã¾ãèª¿å’Œã—ã¦ã„ã‚‹çŠ¶æ…‹ã§ã™ã€‚ç´ æ™´ã‚‰ã—ã„ï¼
                    """)

def calculate_rhi_metrics(df_period: pd.DataFrame, lambda_rhi: float, gamma_rhi: float, tau_rhi: float) -> dict:
    if df_period.empty or 'H' not in df_period.columns:
        return {'mean_H': 0, 'std_H': 0, 'frac_below': 0, 'RHI': 0}
    mean_H = df_period['H'].mean()
    std_H = df_period['H'].std(ddof=0) if len(df_period) > 1 else 0
    frac_below = (df_period['H'] < tau_rhi).mean()
    rhi = mean_H - (lambda_rhi * std_H) - (gamma_rhi * frac_below)
    return {'mean_H': mean_H, 'std_H': std_H, 'frac_below': frac_below, 'RHI': rhi}

# --- D. ãƒ‡ãƒ¼ã‚¿æ°¸ç¶šåŒ–å±¤ ---
@st.cache_resource(ttl=3600)
def get_gspread_client():
    try:
        scopes = [
            "https://www.googleapis.com/auth/spreadsheets",
            "https://www.googleapis.com/auth/drive"
        ]
        creds = Credentials.from_service_account_info(st.secrets["gcp_service_account"], scopes=scopes)
        return gspread.authorize(creds)
    except Exception as e:
        st.error("Google Sheetsã¸ã®èªè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚Secretsã®è¨­å®šã¨GCPã®APIè¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚")
        return None

@st.cache_data(ttl=60)
def read_data(sheet_name: str, spreadsheet_id: str) -> pd.DataFrame:
    gc = get_gspread_client()
    if gc is None: return pd.DataFrame()
    try:
        sh = gc.open_by_key(spreadsheet_id)
        worksheet = sh.worksheet(sheet_name)
        df = pd.DataFrame(worksheet.get_all_records())

        if df.empty:
            return df

        if 'date' in df.columns:
            df['date'] = pd.to_datetime(df['date'], errors='coerce').dt.date
            
        demographic_cols = list(DEMOGRAPHIC_OPTIONS.keys())
        all_cols_to_process = Q_COLS + S_COLS + ALL_ELEMENT_COLS + ['g_happiness', 'record_timestamp'] + demographic_cols
        
        for col in [c for c in all_cols_to_process if c in df.columns]:
            if col not in demographic_cols and col not in ['record_timestamp']:
                 df[col] = pd.to_numeric(df[col], errors='coerce')
            
        return df
    except (gspread.exceptions.SpreadsheetNotFound, gspread.exceptions.WorksheetNotFound):
        st.error(f"ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã¾ãŸã¯ãƒ¯ãƒ¼ã‚¯ã‚·ãƒ¼ãƒˆ'{sheet_name}'ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚")
    except Exception as e:
        st.error(f"ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼: {e}")
    return pd.DataFrame()

def write_data(sheet_name: str, spreadsheet_id: str, df: pd.DataFrame) -> bool:
    gc = get_gspread_client()
    if gc is None:
        st.error("ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒåˆæœŸåŒ–ã•ã‚Œã¦ãŠã‚‰ãšã€æ›¸ãè¾¼ã¿ã§ãã¾ã›ã‚“ã€‚")
        return False
    try:
        sh = gc.open_by_key(spreadsheet_id)
        worksheet = sh.worksheet(sheet_name)
        
        df_copy = df.copy()
        if 'date' in df_copy.columns:
            df_copy['date'] = pd.to_datetime(df_copy['date']).dt.strftime('%Y-%m-%d')
        
        if 'record_timestamp' in df_copy.columns:
            df_copy['record_timestamp'] = pd.to_datetime(df_copy['record_timestamp'], errors='coerce').dt.tz_localize(None).dt.isoformat()
        
        db_schema_cols = ['user_id', 'password_hash', 'consent'] + list(DEMOGRAPHIC_OPTIONS.keys())
        if sheet_name == 'data':
            element_cols_ordered = [f's_element_{e}' for domain_key in DOMAINS for e in LONG_ELEMENTS[domain_key]]
            db_schema_cols = (
                ['user_id', 'date', 'record_timestamp', 'consent', 'mode'] + 
                Q_COLS + S_COLS + 
                ['g_happiness', 'event_log'] +
                element_cols_ordered
            )
        
        for col in db_schema_cols:
            if col not in df_copy.columns:
                df_copy[col] = '' 

        df_to_write = df_copy[db_schema_cols]
        df_to_write = df_to_write.astype(str).replace({'nan': '', 'NaT': '', '<NA>': ''})
        
        worksheet.clear()
        worksheet.update([df_to_write.columns.values.tolist()] + df_to_write.values.tolist(), value_input_option='USER_ENTERED')
        
        st.cache_data.clear()
        st.cache_resource.clear()
        
        return True
    except Exception as e:
        st.error(f"ãƒ‡ãƒ¼ã‚¿ã®æ›¸ãè¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼: {e}")
        return False

# --- E. UIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ ---
def show_welcome_and_guide():
    st.header("ã‚ˆã†ã“ãã€æœ€åˆã®èˆªæµ·å£«ã¸ï¼")
    st.subheader("ã€ŒHarmony Navigatorã€å–æ‰±èª¬æ˜æ›¸")
    st.markdown("---")
    st.subheader("1. ã“ã®ã‚¢ãƒ—ãƒªã¯ã€ã‚ãªãŸã®äººç”Ÿã®ã€Œèˆªæµ·æ—¥èªŒã€ã§ã™")
    st.markdown("""ã€Œã‚‚ã£ã¨å¹¸ã›ã«ãªã‚ŠãŸã„ã€ã¨é¡˜ã„ãªãŒã‚‰ã‚‚ã€æ¼ ç„¶ã¨ã—ãŸä¸å®‰ã‚„ã€**ã‚ãªãŸè‡ªèº«ã®ä¾¡å€¤è¦³ï¼ˆã“ã†ã‚ã‚ŠãŸã„è‡ªåˆ†ï¼‰ã€**ã¨**ã€Œå®Ÿéš›ã®çµŒé¨“ï¼ˆå®Ÿéš›ã«çµŒé¨“ã—ãŸä¸€æ—¥ï¼‰ã€**ã®é–“ã®ã€è¨€è‘‰ã«ãªã‚‰ãªã„ã€ã‚ºãƒ¬ã€ã«ã€ç§ãŸã¡ã¯ã—ã°ã—ã°æ‚©ã¾ã•ã‚Œã¾ã™ã€‚
    ã“ã®ã‚¢ãƒ—ãƒªã¯ã€ãã®ã€ã‚ºãƒ¬ã€ã®æ­£ä½“ã‚’å¯è¦–åŒ–ã—ã€ã‚ãªãŸè‡ªèº«ãŒäººç”Ÿã®èˆµã‚’å–ã‚‹ãŸã‚ã®ã€**å®Ÿè·µçš„ãªã€Œèˆªæµ·è¡“ã€**ã‚’æä¾›ã™ã‚‹ç›®çš„ã§é–‹ç™ºã•ã‚Œã¾ã—ãŸã€‚
    ã“ã‚Œã¯ã€ã‚ãªãŸã ã‘ã®**ã€Œæµ·å›³ï¼ˆãƒãƒ£ãƒ¼ãƒˆï¼‰ã€**ã§ã™ã€‚ã“ã®æµ·å›³ã‚’ä½¿ãˆã°ã€
    - **è‡ªåˆ†ã®ç¾åœ¨åœ°**ï¼ˆä»Šã®å¿ƒã®çŠ¶æ…‹ã€ã¤ã¾ã‚Šã€å®Ÿè·µç§©åºã€ï¼‰ã‚’å®¢è¦³çš„ã«çŸ¥ã‚Šã€
    - **ç›®çš„åœ°**ï¼ˆè‡ªåˆ†ãŒæœ¬å½“ã«å¤§åˆ‡ã«ã—ãŸã„ã“ã¨ã€ã¤ã¾ã‚Šã€æƒ…å ±ç§©åºã€ï¼‰ã‚’æ˜ç¢ºã«ã—ã€
    - **èˆªè·¯**ï¼ˆæ—¥ã€…ã®é¸æŠï¼‰ã‚’ã€ã‚ãªãŸè‡ªèº«ã§è³¢æ˜ã«èª¿æ•´ã—ã¦ã„ãã“ã¨ãŒã§ãã¾ã™ã€‚
    ã‚ãªãŸã®äººç”Ÿã¨ã„ã†ã€å”¯ä¸€ç„¡äºŒã®èˆªæµ·ã€‚ãã®å†’é™ºã®ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã¨ã—ã¦ã€ã“ã®ã‚¢ãƒ—ãƒªã¯ç”Ÿã¾ã‚Œã¾ã—ãŸã€‚""")
    st.markdown("---")
    st.subheader("ğŸ›¡ï¸ã€æœ€é‡è¦ã€‘ã‚ãªãŸã®ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ã¯ã€ã€ŒäºŒé‡ã®ä»®é¢ã€ã«ã‚ˆã£ã¦ã€è¨­è¨ˆä¸Šä¿è­·ã•ã‚Œã¾ã™")
    with st.expander("â–¼ è§£èª¬ï¼šç©¶æ¥µã®ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ä¿è­·ã€ãã®äºŒã¤ã®ç§˜å¯†"):
        st.markdown("""
        ã“ã®ã‚¢ãƒ—ãƒªã®æœ€ã‚‚é‡è¦ãªç´„æŸã¯ã€ã‚ãªãŸã®ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ã‚’å®ˆã‚‹ã“ã¨ã§ã™ã€‚ãã®ãŸã‚ã«ã€ç§ãŸã¡ã¯**ã€ŒäºŒé‡ã®ä»®é¢ã€**ã¨ã„ã†ã€äºŒæ®µéšã®å¼·åŠ›ãªåŒ¿ååŒ–ãƒ»æš—å·åŒ–æŠ€è¡“ã‚’ã€è¨­è¨ˆã®ä¸­å¿ƒã«æ®ãˆã¦ã„ã¾ã™ã€‚
        #### **ç¬¬ä¸€ã®ä»®é¢ï¼šã‚ãªãŸãŒèª°ã ã‹ã€ã‚·ã‚¹ãƒ†ãƒ ã•ãˆã‚‚çŸ¥ã‚‰ãªã„ã€Œç§˜å¯†ã®åˆã„è¨€è‘‰ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼IDï¼‰ã€**
        ã“ã®ã‚¢ãƒ—ãƒªã§ã¯ã€ã‚ãªãŸã¯ã€æœ¬åã‚„ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã€ã•ã‚‰ã«ã¯ã”è‡ªèº«ã§ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’æ±ºã‚ã¦ã„ãŸã ãã“ã¨ã•ãˆã‚‚ã€ä¸€åˆ‡ã‚ã‚Šã¾ã›ã‚“ã€‚**å€‹äººã‚’ç‰¹å®šã§ãã‚‹æƒ…å ±ã‚’ã€ã‚ãªãŸãŒå…¥åŠ›ã™ã‚‹ãƒ—ãƒ­ã‚»ã‚¹ã¯ã€å­˜åœ¨ã—ãªã„ã®ã§ã™ã€‚**
        ã‚ãªãŸãŒåˆã‚ã¦ã€Œæ–°ã—ã„èˆ¹ã§æ—…ã‚’å§‹ã‚ã‚‹ã€ã‚’é¸æŠã—ãŸç¬é–“ã€**ã‚·ã‚¹ãƒ†ãƒ ãŒã€ã‚ãªãŸã®ãŸã‚ã ã‘ã«ã€å®Œå…¨ã«ãƒ©ãƒ³ãƒ€ãƒ ã§ã€äºˆæ¸¬ä¸å¯èƒ½ãªã€Œç§˜å¯†ã®åˆã„è¨€è‘‰ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼IDï¼‰ã€ã‚’è‡ªå‹•ã§ç”Ÿæˆã—ã¾ã™ã€‚**
        ã“ã‚Œã«ã‚ˆã‚Šã€ç§ãŒãã®ç•ªå·ã®æŒã¡ä¸»ãŒç¾å®Ÿä¸–ç•Œã®èª°ãªã®ã‹ã‚’çŸ¥ã‚‹æ‰‹æ®µã¯ã€ä¸€åˆ‡ã‚ã‚Šã¾ã›ã‚“ã€‚ã“ã‚Œã“ããŒã€**ã€Œè¨­è¨ˆã«ã‚ˆã‚‹åŒ¿åæ€§ã€**ã‚’ä¿è¨¼ã™ã‚‹ã€ç¬¬ä¸€ã®ä»®é¢ã§ã™ã€‚
        #### **ç¬¬äºŒã®ä»®é¢ï¼šã‚ãªãŸã«ã—ã‹èª­ã‚ãªã„ã€Œé­”æ³•ã®è‡ªå·±ç ´å£Šã‚¤ãƒ³ã‚¯ï¼ˆã‚¤ãƒ™ãƒ³ãƒˆãƒ­ã‚°ã®æš—å·åŒ–ï¼‰ã€**
        ã•ã‚‰ã«ã€ã‚ãªãŸã®æœ€ã‚‚ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãªè¨˜éŒ²ã§ã‚ã‚‹**ã€Œã‚¤ãƒ™ãƒ³ãƒˆãƒ­ã‚°ï¼ˆæ—¥ã€…ã®å‡ºæ¥äº‹ã‚„æ°—ã¥ãï¼‰ã€**ã«ã¯ã€ã‚ˆã‚Šå¼·åŠ›ãªã€ç¬¬äºŒã®ä»®é¢ãŒç”¨æ„ã•ã‚Œã¦ã„ã¾ã™ã€‚
        ã‚ãªãŸãŒæ—¥è¨˜ã‚’æ›¸ãçµ‚ãˆã€ã€Œä¿å­˜ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸç¬é–“ã€ãã®æ–‡å­—ã¯ã€ã‚ãªãŸã®**PCã‚„ã‚¹ãƒãƒ›ã®ãƒ–ãƒ©ã‚¦ã‚¶ã®ä¸­ã ã‘ã§**ã€ã‚ãªãŸã ã‘ãŒçŸ¥ã£ã¦ã„ã‚‹**ã€Œãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã€**ã‚’éµã¨ã—ã¦ã€èª°ã«ã‚‚èª­ã‚ãªã„ã€å…¨ãæ„å‘³ä¸æ˜ãªè¨˜å·ã®ç¾…åˆ—ã«ã€å®Œå…¨ã«**æš—å·åŒ–**ã•ã‚Œã¾ã™ã€‚
        ãƒ‡ãƒ¼ã‚¿ä¿ç®¡åº«ã«è¨˜éŒ²ã•ã‚Œã‚‹ã®ã¯ã€ã“ã®**ã€Œèª°ã«ã‚‚èª­ã‚ãªã„ã€æš—å·åŒ–ã•ã‚ŒãŸè¨˜å·ã®ç¾…åˆ—ã€ã ã‘**ã§ã™ã€‚
        ã—ãŸãŒã£ã¦ã€ãŸã¨ãˆç§ãŒã‚ãªãŸã®ã€Œç§˜å¯†ã®åˆã„è¨€è‘‰ã€ã‚’çŸ¥ã£ã¦ã„ãŸã¨ã—ã¦ã‚‚ã€ã‚ãªãŸã®ã‚¤ãƒ™ãƒ³ãƒˆãƒ­ã‚°ã®ä¸­èº«ã‚’èª­ã‚€ã“ã¨ã¯ã€**ç‰©ç†çš„ã«ã€ãã—ã¦æ°¸é ã«ã€ä¸å¯èƒ½ã§ã™ã€‚**
        ã“ã®æ—¥è¨˜ã‚’å†ã³èª­ã‚ã‚‹ã®ã¯ã€ä¸–ç•Œã§ãŸã ä¸€äººã€æ­£ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¨ã„ã†ã€Œé­”æ³•ã®éµã€ã‚’æŒã¤ã€**ã‚ãªãŸã ã‘**ã§ã™ã€‚
        **ã“ã®ã€ŒäºŒé‡ã®ä»®é¢ã€ã®ä»•çµ„ã¿ã«ã‚ˆã‚Šã€ã‚ãªãŸã®ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ã¯ã€é–‹ç™ºè€…ã®å–„æ„ã«ä¾å­˜ã™ã‚‹ã®ã§ã¯ãªãã€ã€Œè¨­è¨ˆã€ãã®ã‚‚ã®ã«ã‚ˆã£ã¦ã€æ§‹é€ çš„ã«ä¿è­·ã•ã‚Œã‚‹ã®ã§ã™ã€‚**
        """)
    st.markdown("---")
    st.subheader("ğŸ§‘â€ğŸ”¬ ã‚ãªãŸã¯ã€ãŸã ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã˜ã‚ƒãªã„ã€‚ã€Œç§‘å­¦ã®å†’é™ºè€…ã€ã§ã™ï¼")
    st.info("""
    **ã€ç ”ç©¶å”åŠ›ã¸ã®ãŠé¡˜ã„ï¼ˆã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ ãƒ‰ãƒ»ã‚³ãƒ³ã‚»ãƒ³ãƒˆï¼‰ã€‘**
    ã‚‚ã—ã€ã”å”åŠ›ã„ãŸã ã‘ã‚‹ã®ã§ã‚ã‚Œã°ã€ã‚ãªãŸãŒè¨˜éŒ²ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’ã€**å€‹äººãŒç‰¹å®šã§ããªã„å½¢ã«å®Œå…¨ã«åŒ¿ååŒ–ã—ãŸä¸Šã§**ã€ã“ã®ç†è«–ã®ç§‘å­¦çš„æ¤œè¨¼ã®ãŸã‚ã®ç ”ç©¶ã«åˆ©ç”¨ã•ã›ã¦ã„ãŸã ãã“ã¨ã«ã”åŒæ„ã„ãŸã ã‘ã¾ã™ã§ã—ã‚‡ã†ã‹ã€‚
    **ã€ç§ãŸã¡ã®ç´„æŸï¼šã‚¼ãƒ­çŸ¥è­˜åˆ†æã€‘**
    ã‚ãªãŸã®ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ã¯ã€ä½•ã‚ˆã‚Šã‚‚å„ªå…ˆã•ã‚Œã¾ã™ã€‚ãã®ãŸã‚ã€ç§ãŸã¡ã¯ã€ã‚ãªãŸã®ã‚¤ãƒ™ãƒ³ãƒˆãƒ­ã‚°ã®ã‚ˆã†ãªã€ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãªè¨˜è¿°ãƒ‡ãƒ¼ã‚¿ã‚’ã€**ç›´æ¥åé›†ã™ã‚‹ã“ã¨ã¯ä¸€åˆ‡ã‚ã‚Šã¾ã›ã‚“ã€‚**
    ã“ã“ã®ã€ŒåŒæ„ã€ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã¯ã€ç§ãŸã¡ãŒã€ã‚ãªãŸã®**ã€Œæ—¥ã€…ã®æ•°å€¤ãƒ‡ãƒ¼ã‚¿ï¼ˆå¹¸ç¦åº¦ã®ã‚¹ã‚³ã‚¢ãªã©ï¼‰ã€**ã‚’ã€ç ”ç©¶åˆ†æã«åˆ©ç”¨ã•ã›ã¦ã„ãŸã ãã“ã¨ã¸ã®è¨±å¯ã‚’ã„ãŸã ããŸã‚ã®ã‚‚ã®ã§ã™ã€‚
    """)

def show_legal_documents():
    with st.expander("ğŸ“œ **åˆ©ç”¨è¦ç´„**ã‚’èª­ã‚€"):
        st.markdown("""
        **æœ€çµ‚æ›´æ–°æ—¥ï¼š2025å¹´9æœˆ11æ—¥**
        
        æœ¬åˆ©ç”¨è¦ç´„ï¼ˆä»¥ä¸‹ã€Œæœ¬è¦ç´„ã€ã¨ã„ã„ã¾ã™ï¼‰ã¯ã€[ã‚ãªãŸã®æ°åã¾ãŸã¯äº‹æ¥­å]ï¼ˆä»¥ä¸‹ã€Œå½“æ–¹ã€ã¨ã„ã„ã¾ã™ï¼‰ãŒæä¾›ã™ã‚‹ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã€ŒHarmony Navigatorã€ï¼ˆä»¥ä¸‹ã€Œæœ¬ã‚¢ãƒ—ãƒªã€ã¨ã„ã„ã¾ã™ï¼‰ã®åˆ©ç”¨æ¡ä»¶ã‚’å®šã‚ã‚‹ã‚‚ã®ã§ã™ã€‚æœ¬ã‚¢ãƒ—ãƒªã‚’åˆ©ç”¨ã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®çš†æ§˜ï¼ˆä»¥ä¸‹ã€Œãƒ¦ãƒ¼ã‚¶ãƒ¼ã€ã¨ã„ã„ã¾ã™ï¼‰ã«ã¯ã€æœ¬è¦ç´„ã«å¾“ã£ã¦æœ¬ã‚¢ãƒ—ãƒªã‚’ã”åˆ©ç”¨ã„ãŸã ãã¾ã™ã€‚
        
        **ç¬¬1æ¡ï¼ˆé©ç”¨ï¼‰**
        æœ¬è¦ç´„ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨å½“æ–¹ã¨ã®é–“ã®æœ¬ã‚¢ãƒ—ãƒªã®åˆ©ç”¨ã«é–¢ã‚ã‚‹ä¸€åˆ‡ã®é–¢ä¿‚ã«é©ç”¨ã•ã‚Œã‚‹ã‚‚ã®ã¨ã—ã¾ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã€æœ¬ã‚¢ãƒ—ãƒªã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã«ã‚ˆã‚Šã€æœ¬è¦ç´„ã®å…¨ã¦ã®å†…å®¹ã«åŒæ„ã—ãŸã‚‚ã®ã¨ã¿ãªã•ã‚Œã¾ã™ã€‚
        
        **ç¬¬2æ¡ï¼ˆåˆ©ç”¨è€…ç™»éŒ²ï¼‰**
        1. æœ¬ã‚¢ãƒ—ãƒªã®åˆ©ç”¨ã‚’å¸Œæœ›ã™ã‚‹è€…ã¯ã€æœ¬è¦ç´„ã«åŒæ„ã®ä¸Šã€å½“æ–¹ã®å®šã‚ã‚‹æ–¹æ³•ã«ã‚ˆã£ã¦åˆ©ç”¨è€…ç™»éŒ²ã‚’ç”³è«‹ã—ã€å½“æ–¹ãŒã“ã‚Œã‚’æ‰¿èªã™ã‚‹ã“ã¨ã«ã‚ˆã£ã¦ã€åˆ©ç”¨è€…ç™»éŒ²ãŒå®Œäº†ã™ã‚‹ã‚‚ã®ã¨ã—ã¾ã™ã€‚
        2. å½“æ–¹ã¯ã€åˆ©ç”¨è€…ç™»éŒ²ã®ç”³è«‹è€…ã«ä»¥ä¸‹ã®äº‹ç”±ãŒã‚ã‚‹ã¨åˆ¤æ–­ã—ãŸå ´åˆã€ç™»éŒ²ã‚’æ‰¿èªã—ãªã„ã“ã¨ãŒã‚ã‚Šã€ãã®ç†ç”±ã«ã¤ã„ã¦ã¯ä¸€åˆ‡ã®é–‹ç¤ºç¾©å‹™ã‚’è² ã‚ãªã„ã‚‚ã®ã¨ã—ã¾ã™ã€‚
           (1) ç™»éŒ²ç”³è«‹ã«éš›ã—ã¦è™šå½ã®äº‹é …ã‚’å±Šã‘å‡ºãŸå ´åˆ
           (2) ãã®ä»–ã€å½“æ–¹ãŒåˆ©ç”¨è€…ç™»éŒ²ã‚’ç›¸å½“ã§ãªã„ã¨åˆ¤æ–­ã—ãŸå ´åˆ
        
        **ç¬¬3æ¡ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼IDãŠã‚ˆã³ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®ç®¡ç†ï¼‰**
        1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã€è‡ªå·±ã®è²¬ä»»ã«ãŠã„ã¦ã€æœ¬ã‚¢ãƒ—ãƒªã®ãƒ¦ãƒ¼ã‚¶ãƒ¼IDï¼ˆç§˜å¯†ã®åˆã„è¨€è‘‰ï¼‰ãŠã‚ˆã³ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’é©åˆ‡ã«ç®¡ç†ã™ã‚‹ã‚‚ã®ã¨ã—ã¾ã™ã€‚
        2. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã€ã„ã‹ãªã‚‹å ´åˆã«ã‚‚ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãŠã‚ˆã³ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ç¬¬ä¸‰è€…ã«è­²æ¸¡ã¾ãŸã¯è²¸ä¸ã—ã€ã‚‚ã—ãã¯ç¬¬ä¸‰è€…ã¨å…±ç”¨ã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚
        3. **ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ç´›å¤±ã—ãŸå ´åˆã€æš—å·åŒ–ã•ã‚ŒãŸã‚¤ãƒ™ãƒ³ãƒˆãƒ­ã‚°ã¯å¾©å…ƒã§ãã¾ã›ã‚“ã€‚** å½“æ–¹ã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ä¿æŒã—ã¦ãŠã‚‰ãšã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆæ©Ÿèƒ½ã¯æä¾›ã—ã¾ã›ã‚“ã€‚ã“ã®ä»•æ§˜ã‚’ç†è§£ã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯è‡ªã‚‰ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å®‰å…¨ã«ä¿ç®¡ã™ã‚‹è²¬ä»»ã‚’è² ã†ã‚‚ã®ã¨ã—ã¾ã™ã€‚
        4. ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãŠã‚ˆã³ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®ç®¡ç†ä¸ååˆ†ã€ä½¿ç”¨ä¸Šã®éèª¤ã€ç¬¬ä¸‰è€…ã®ä½¿ç”¨ç­‰ã«ã‚ˆã£ã¦ç”Ÿã˜ãŸæå®³ã®è²¬ä»»ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè² ã†ã‚‚ã®ã¨ã—ã€å½“æ–¹ã¯ä¸€åˆ‡ã®è²¬ä»»ã‚’è² ã„ã¾ã›ã‚“ã€‚
        
        **ç¬¬4æ¡ï¼ˆç¦æ­¢äº‹é …ï¼‰**
        ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã€æœ¬ã‚¢ãƒ—ãƒªã®åˆ©ç”¨ã«ã‚ãŸã‚Šã€ä»¥ä¸‹ã®è¡Œç‚ºã‚’ã—ã¦ã¯ãªã‚Šã¾ã›ã‚“ã€‚
        1. æ³•ä»¤ã¾ãŸã¯å…¬åºè‰¯ä¿—ã«é•åã™ã‚‹è¡Œç‚º
        2. çŠ¯ç½ªè¡Œç‚ºã«é–¢é€£ã™ã‚‹è¡Œç‚º
        3. æœ¬ã‚¢ãƒ—ãƒªã®ã‚µãƒ¼ãƒãƒ¼ã¾ãŸã¯ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã®æ©Ÿèƒ½ã‚’ç ´å£Šã—ãŸã‚Šã€å¦¨å®³ã—ãŸã‚Šã™ã‚‹è¡Œç‚º
        4. æœ¬ã‚¢ãƒ—ãƒªã®é‹å–¶ã‚’å¦¨å®³ã™ã‚‹ãŠãã‚Œã®ã‚ã‚‹è¡Œç‚º
        5. ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é–¢ã™ã‚‹å€‹äººæƒ…å ±ç­‰ã‚’åé›†ã¾ãŸã¯è“„ç©ã™ã‚‹è¡Œç‚º
        6. ä¸æ­£ã‚¢ã‚¯ã‚»ã‚¹ã‚’ã—ã€ã¾ãŸã¯ã“ã‚Œã‚’è©¦ã¿ã‚‹è¡Œç‚º
        7. ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«æˆã‚Šã™ã¾ã™è¡Œç‚º
        8. å½“æ–¹ã®ã‚µãƒ¼ãƒ“ã‚¹ã«é–¢é€£ã—ã¦ã€åç¤¾ä¼šçš„å‹¢åŠ›ã«å¯¾ã—ã¦ç›´æ¥ã¾ãŸã¯é–“æ¥ã«åˆ©ç›Šã‚’ä¾›ä¸ã™ã‚‹è¡Œç‚º
        9. ãã®ä»–ã€å½“æ–¹ãŒä¸é©åˆ‡ã¨åˆ¤æ–­ã™ã‚‹è¡Œç‚º
        
        **ç¬¬5æ¡ï¼ˆæœ¬ã‚µãƒ¼ãƒ“ã‚¹ã®æä¾›ã®åœæ­¢ç­‰ï¼‰**
        å½“æ–¹ã¯ã€ä»¥ä¸‹ã®ã„ãšã‚Œã‹ã®äº‹ç”±ãŒã‚ã‚‹ã¨åˆ¤æ–­ã—ãŸå ´åˆã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«äº‹å‰ã«é€šçŸ¥ã™ã‚‹ã“ã¨ãªãæœ¬ã‚¢ãƒ—ãƒªã®å…¨éƒ¨ã¾ãŸã¯ä¸€éƒ¨ã®æä¾›ã‚’åœæ­¢ã¾ãŸã¯ä¸­æ–­ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã‚‚ã®ã¨ã—ã¾ã™ã€‚
        1. æœ¬ã‚¢ãƒ—ãƒªã«ã‹ã‹ã‚‹ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ã‚·ã‚¹ãƒ†ãƒ ã®ä¿å®ˆç‚¹æ¤œã¾ãŸã¯æ›´æ–°ã‚’è¡Œã†å ´åˆ
        2. åœ°éœ‡ã€è½é›·ã€ç«ç½ã€åœé›»ã¾ãŸã¯å¤©ç½ãªã©ã®ä¸å¯æŠ—åŠ›ã«ã‚ˆã‚Šã€æœ¬ã‚¢ãƒ—ãƒªã®æä¾›ãŒå›°é›£ã¨ãªã£ãŸå ´åˆ
        3. ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ã¾ãŸã¯é€šä¿¡å›ç·šç­‰ãŒäº‹æ•…ã«ã‚ˆã‚Šåœæ­¢ã—ãŸå ´åˆ
        4. ãã®ä»–ã€å½“æ–¹ãŒæœ¬ã‚¢ãƒ—ãƒªã®æä¾›ãŒå›°é›£ã¨åˆ¤æ–­ã—ãŸå ´åˆ
        
        **ç¬¬6æ¡ï¼ˆçŸ¥çš„è²¡ç”£æ¨©ï¼‰**
        æœ¬ã‚¢ãƒ—ãƒªã«ã‚ˆã£ã¦æä¾›ã•ã‚Œã‚‹ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã€æ–‡ç« ã€ç”»åƒã€ãã®ä»–ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã«é–¢ã™ã‚‹è‘—ä½œæ¨©ãã®ä»–ã®çŸ¥çš„è²¡ç”£æ¨©ã¯ã€å½“æ–¹ã¾ãŸã¯æ­£å½“ãªæ¨©åˆ©ã‚’æœ‰ã™ã‚‹ç¬¬ä¸‰è€…ã«å¸°å±ã—ã¾ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæœ¬ã‚¢ãƒ—ãƒªã«å…¥åŠ›ã—ãŸãƒ‡ãƒ¼ã‚¿ï¼ˆã‚¤ãƒ™ãƒ³ãƒˆãƒ­ã‚°ã‚’é™¤ãã€åŒ¿ååŒ–ã•ã‚ŒãŸæ•°å€¤ãƒ‡ãƒ¼ã‚¿ã§ã€ç ”ç©¶å”åŠ›ã«åŒæ„ã•ã‚ŒãŸã‚‚ã®ï¼‰ã®è‘—ä½œæ¨©ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ç•™ä¿ã•ã‚Œã¾ã™ãŒã€å½“æ–¹ã¯ã“ã‚Œã‚’çµ±è¨ˆçš„ãªç ”ç©¶ç›®çš„ã§åˆ©ç”¨ã§ãã‚‹ã‚‚ã®ã¨ã—ã¾ã™ã€‚
        
        **ç¬¬7æ¡ï¼ˆå…è²¬äº‹é …ï¼‰**
        1. å½“æ–¹ã¯ã€æœ¬ã‚¢ãƒ—ãƒªã«äº‹å®Ÿä¸Šã¾ãŸã¯æ³•å¾‹ä¸Šã®ç‘•ç–µï¼ˆå®‰å…¨æ€§ã€ä¿¡é ¼æ€§ã€æ­£ç¢ºæ€§ã€å®Œå…¨æ€§ã€æœ‰åŠ¹æ€§ã€ç‰¹å®šã®ç›®çš„ã¸ã®é©åˆæ€§ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãªã©ã«é–¢ã™ã‚‹æ¬ é™¥ã€ã‚¨ãƒ©ãƒ¼ã‚„ãƒã‚°ã€æ¨©åˆ©ä¾µå®³ãªã©ã‚’å«ã¿ã¾ã™ã€‚ï¼‰ãŒãªã„ã“ã¨ã‚’æ˜ç¤ºçš„ã«ã‚‚é»™ç¤ºçš„ã«ã‚‚ä¿è¨¼ã—ã¦ãŠã‚Šã¾ã›ã‚“ã€‚
        2. æœ¬ã‚¢ãƒ—ãƒªã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è‡ªå·±ç†è§£ã¨å†…çœã‚’æ”¯æ´ã™ã‚‹ãƒ„ãƒ¼ãƒ«ã§ã‚ã‚Šã€åŒ»ç™‚è¡Œç‚ºã€ã‚«ã‚¦ãƒ³ã‚»ãƒªãƒ³ã‚°ã€ã¾ãŸã¯å°‚é–€çš„ãªåŠ©è¨€ã‚’ä»£æ›¿ã™ã‚‹ã‚‚ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ç²¾ç¥çš„ãªä¸èª¿ã‚’æ„Ÿã˜ã‚‹å ´åˆã¯ã€å¿…ãšå°‚é–€ã®åŒ»ç™‚æ©Ÿé–¢ã«ã”ç›¸è«‡ãã ã•ã„ã€‚
        3. å½“æ–¹ã¯ã€æœ¬ã‚¢ãƒ—ãƒªã«èµ·å› ã—ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ç”Ÿã˜ãŸã‚ã‚‰ã‚†ã‚‹æå®³ã«ã¤ã„ã¦ä¸€åˆ‡ã®è²¬ä»»ã‚’è² ã„ã¾ã›ã‚“ã€‚
        
        **ç¬¬8æ¡ï¼ˆåˆ©ç”¨è¦ç´„ã®å¤‰æ›´ï¼‰**
        å½“æ–¹ã¯ã€å¿…è¦ã¨åˆ¤æ–­ã—ãŸå ´åˆã«ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é€šçŸ¥ã™ã‚‹ã“ã¨ãªãã„ã¤ã§ã‚‚æœ¬è¦ç´„ã‚’å¤‰æ›´ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã‚‚ã®ã¨ã—ã¾ã™ã€‚
        
        **ç¬¬9æ¡ï¼ˆæº–æ‹ æ³•ãƒ»è£åˆ¤ç®¡è½„ï¼‰**
        æœ¬è¦ç´„ã®è§£é‡ˆã«ã‚ãŸã£ã¦ã¯ã€æ—¥æœ¬æ³•ã‚’æº–æ‹ æ³•ã¨ã—ã¾ã™ã€‚æœ¬ã‚¢ãƒ—ãƒªã«é–¢ã—ã¦ç´›äº‰ãŒç”Ÿã˜ãŸå ´åˆã«ã¯ã€[æ±äº¬åœ°æ–¹è£åˆ¤æ‰€]ã‚’ç¬¬ä¸€å¯©ã®å°‚å±çš„åˆæ„ç®¡è½„è£åˆ¤æ‰€ã¨ã—ã¾ã™ã€‚
        
        ä»¥ä¸Š
        """)
    
    with st.expander("ğŸ“„ **ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼**ã‚’èª­ã‚€"):
        st.markdown("""
        **æœ€çµ‚æ›´æ–°æ—¥ï¼š2025å¹´9æœˆ11æ—¥**
        
        **1. ã¯ã˜ã‚ã«**
        æœ¬ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼ã¯ã€[ã‚ãªãŸã®æ°åã¾ãŸã¯äº‹æ¥­å]ï¼ˆä»¥ä¸‹ã€Œå½“æ–¹ã€ã¨ã„ã„ã¾ã™ï¼‰ãŒæä¾›ã™ã‚‹ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã€ŒHarmony Navigatorã€ï¼ˆä»¥ä¸‹ã€Œæœ¬ã‚¢ãƒ—ãƒªã€ã¨ã„ã„ã¾ã™ï¼‰ã«ãŠã‘ã‚‹ã€åˆ©ç”¨è€…ï¼ˆä»¥ä¸‹ã€Œãƒ¦ãƒ¼ã‚¶ãƒ¼ã€ã¨ã„ã„ã¾ã™ï¼‰ã®æƒ…å ±ã®å–ã‚Šæ‰±ã„ã«ã¤ã„ã¦èª¬æ˜ã™ã‚‹ã‚‚ã®ã§ã™ã€‚å½“æ–¹ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ã‚’æœ€å¤§é™å°Šé‡ã—ã€ãã®ä¿è­·ã«ä¸‡å…¨ã‚’å°½ãã—ã¾ã™ã€‚æœ¬ã‚¢ãƒ—ãƒªã¯ã€ãã®æ€æƒ³ã®ä¸­å¿ƒã«ã€Œãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒã‚¤ãƒ‡ã‚¶ã‚¤ãƒ³ã€ã‚’æ®ãˆã¦è¨­è¨ˆã•ã‚Œã¦ã„ã¾ã™ã€‚

        **2. å–å¾—ã™ã‚‹æƒ…å ±ã¨åˆ©ç”¨ç›®çš„**
        æœ¬ã‚¢ãƒ—ãƒªã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®çš†æ§˜ã‹ã‚‰ä»¥ä¸‹ã®æƒ…å ±ã‚’å–å¾—ã—ã€ãã‚Œãã‚Œã®ç›®çš„ã®ãŸã‚ã«åˆ©ç”¨ã—ã¾ã™ã€‚
        
        **(1) ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæƒ…å ±**
        - **å–å¾—ã™ã‚‹æƒ…å ±**:
            - **åŒ¿åãƒ¦ãƒ¼ã‚¶ãƒ¼ID**: æœ¬ã‚¢ãƒ—ãƒªãŒè‡ªå‹•ç”Ÿæˆã™ã‚‹ã€å€‹äººã¨ã¯ä¸€åˆ‡çµã³ã¤ã‹ãªã„ãƒ©ãƒ³ãƒ€ãƒ ãªè­˜åˆ¥å­ã€‚
            - **ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®ãƒãƒƒã‚·ãƒ¥å€¤**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¨­å®šã—ãŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ã€å¾©å…ƒä¸å¯èƒ½ãªå½¢å¼ï¼ˆbcryptï¼‰ã§æš—å·åŒ–ã—ãŸãƒ‡ãƒ¼ã‚¿ã€‚
            - **ç ”ç©¶å”åŠ›ã¸ã®åŒæ„çŠ¶æ³**: ç ”ç©¶å”åŠ›ã«é–¢ã™ã‚‹åŒæ„ã®æœ‰ç„¡ã€‚
            - **ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±ï¼ˆä»»æ„ï¼‰**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒä»»æ„ã§æä¾›ã™ã‚‹ã€å¹´ä»£ã€æ€§åˆ¥ã€è·æ¥­ã‚«ãƒ†ã‚´ãƒªã€å¹´åç¯„å›²ãªã©ã®äººå£çµ±è¨ˆå­¦çš„æƒ…å ±ã€‚ã“ã‚Œã‚‰ã®æƒ…å ±ã¯ã€å€‹äººã‚’ç‰¹å®šã—ãªã„ã‚«ãƒ†ã‚´ãƒªå½¢å¼ã§åé›†ã•ã‚Œã¾ã™ã€‚
        - **åˆ©ç”¨ç›®çš„**:
            - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’è­˜åˆ¥ã—ã€ãƒ­ã‚°ã‚¤ãƒ³æ©Ÿèƒ½ã‚’å®‰å…¨ã«æä¾›ã™ã‚‹ãŸã‚ã€‚
            - ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®ç…§åˆã«ã‚ˆã‚‹æœ¬äººç¢ºèªã®ãŸã‚ã€‚
            - ç ”ç©¶å”åŠ›ã¸ã®åŒæ„çŠ¶æ³ã‚’ç®¡ç†ã™ã‚‹ãŸã‚ã€‚
        - **ç‰¹è¨˜äº‹é …**: å½“æ–¹ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã€æ°åã€ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ãªã©ã€**å€‹äººã‚’ç‰¹å®šã§ãã‚‹æƒ…å ±ã‚’ä¸€åˆ‡å–å¾—ã—ã¾ã›ã‚“ã€‚** ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±ã®æä¾›ã¯å®Œå…¨ã«ä»»æ„ã§ã‚ã‚Šã€æä¾›ã—ãªã„å ´åˆã§ã‚‚ã‚¢ãƒ—ãƒªã®æ©Ÿèƒ½ã«ä¸€åˆ‡ã®åˆ¶é™ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚

        **(2) ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¨˜éŒ²ã™ã‚‹ãƒ‡ãƒ¼ã‚¿**
        - **å–å¾—ã™ã‚‹æƒ…å ±**:
            - **ä¾¡å€¤é‡ã¿ãƒ‡ãƒ¼ã‚¿ (q_t)**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¨­å®šã™ã‚‹ã€å¹¸ç¦ã®å„ãƒ‰ãƒ¡ã‚¤ãƒ³ã«å¯¾ã™ã‚‹é‡è¦åº¦ã®é…åˆ†ï¼ˆæ•°å€¤ãƒ‡ãƒ¼ã‚¿ï¼‰ã€‚
            - **å……è¶³åº¦ãƒ‡ãƒ¼ã‚¿ (s_t)**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ—¥ã€…è¨˜éŒ²ã™ã‚‹ã€å¹¸ç¦ã®å„è¦ç´ ã®å……è¶³åº¦ï¼ˆæ•°å€¤ãƒ‡ãƒ¼ã‚¿ï¼‰ã€‚
            - **ç·åˆçš„å¹¸ç¦æ„Ÿãƒ‡ãƒ¼ã‚¿ (g_t)**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ—¥ã€…è¨˜éŒ²ã™ã‚‹ã€å…¨ä½“çš„ãªå¹¸ç¦æ„Ÿï¼ˆæ•°å€¤ãƒ‡ãƒ¼ã‚¿ï¼‰ã€‚
            - **ã‚¤ãƒ™ãƒ³ãƒˆãƒ­ã‚°ï¼ˆæš—å·åŒ–æ¸ˆã¿ï¼‰**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¨˜éŒ²ã™ã‚‹æ—¥ã€…ã®å‡ºæ¥äº‹ã‚„å†…çœã€‚ã“ã®ãƒ‡ãƒ¼ã‚¿ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç«¯æœ«ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ï¼‰ä¸Šã§ã€**ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’éµã¨ã—ã¦æš—å·åŒ–ã•ã‚ŒãŸå¾Œ**ã«ã‚µãƒ¼ãƒãƒ¼ã¸é€ä¿¡ã•ã‚Œã¾ã™ã€‚
        - **åˆ©ç”¨ç›®çš„**:
            - æœ¬ã‚¢ãƒ—ãƒªã®æ ¸å¿ƒæ©Ÿèƒ½ã§ã‚ã‚‹ã€å¹¸ç¦åº¦ã®å¯è¦–åŒ–ï¼ˆèª¿å’Œåº¦Hã€RHIç­‰ã®è¨ˆç®—ï¼‰ã€ãƒ‘ã‚¿ãƒ¼ãƒ³åˆ†æã€ãŠã‚ˆã³ãƒ¦ãƒ¼ã‚¶ãƒ¼è‡ªèº«ã®è‡ªå·±ç†è§£ã¨å†…çœã‚’æ”¯æ´ã™ã‚‹ãŸã‚ã«åˆ©ç”¨ã—ã¾ã™ã€‚
        - **ç‰¹è¨˜äº‹é …**: å½“æ–¹ã¯ã€**æš—å·åŒ–ã•ã‚ŒãŸã‚¤ãƒ™ãƒ³ãƒˆãƒ­ã‚°ã‚’å¾©å·ã™ã‚‹æ‰‹æ®µã‚’æŒã¡ã¾ã›ã‚“ã€‚** ã—ãŸãŒã£ã¦ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¨˜éŒ²ã—ãŸæ—¥è¨˜ã®å†…å®¹ã‚’ã€å½“æ–¹ãŒé–²è¦§ã™ã‚‹ã“ã¨ã¯ç‰©ç†çš„ã«ä¸å¯èƒ½ã§ã™ï¼ˆã‚¼ãƒ­çŸ¥è­˜ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ï¼‰ã€‚

        **(3) ç ”ç©¶åˆ©ç”¨ã«é–¢ã™ã‚‹æƒ…å ±ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒç ”ç©¶å”åŠ›ã«åŒæ„ã—ãŸå ´åˆã®ã¿ï¼‰**
        - **å–å¾—ã™ã‚‹æƒ…å ±**:
            - ä¸Šè¨˜(1)ãŠã‚ˆã³(2)ã§å–å¾—ã™ã‚‹æƒ…å ±ã®ã†ã¡ã€**ã‚¤ãƒ™ãƒ³ãƒˆãƒ­ã‚°ã‚’é™¤ãã€å®Œå…¨ã«åŒ¿ååŒ–ã•ã‚ŒãŸæ•°å€¤ãƒ‡ãƒ¼ã‚¿ãŠã‚ˆã³ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±**ã€‚
        - **åˆ©ç”¨ç›®çš„**:
            - æœ¬ã‚¢ãƒ—ãƒªã®åŸºç›¤ã¨ãªã‚‹å¹¸ç¦è«–ã®ç§‘å­¦çš„å¦¥å½“æ€§ã‚’æ¤œè¨¼ã™ã‚‹ãŸã‚ã®ã€çµ±è¨ˆçš„ãªå­¦è¡“ç ”ç©¶ã«åˆ©ç”¨ã—ã¾ã™ã€‚ä¾‹ãˆã°ã€å¹´ä»£ã‚„è·æ¥­ã«ã‚ˆã£ã¦å¹¸ç¦ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã«é•ã„ãŒè¦‹ã‚‰ã‚Œã‚‹ã‹ã€ã¨ã„ã£ãŸåˆ†æã‚’è¡Œã„ã¾ã™ã€‚å€‹äººãŒç‰¹å®šã•ã‚Œã‚‹å½¢ã§ç ”ç©¶çµæœãŒå…¬è¡¨ã•ã‚Œã‚‹ã“ã¨ã¯ä¸€åˆ‡ã‚ã‚Šã¾ã›ã‚“ã€‚

        **3. æƒ…å ±ã®ç¬¬ä¸‰è€…æä¾›**
        å½“æ–¹ã¯ã€ä»¥ä¸‹ã®å ´åˆã‚’é™¤ãã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æƒ…å ±ã‚’ç¬¬ä¸‰è€…ã«æä¾›ã™ã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
        - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ˜ç¢ºãªåŒæ„ãŒã‚ã‚‹å ´åˆã€‚
        - æ³•ä»¤ã«åŸºã¥ãé–‹ç¤ºè«‹æ±‚ãŒã‚ã£ãŸå ´åˆã€‚
        - å­¦è¡“ç ”ç©¶ã®ç›®çš„ã§ã€å€‹äººã‚’ç‰¹å®šã§ããªã„çµ±è¨ˆæƒ…å ±ã¨ã—ã¦æä¾›ã™ã‚‹å ´åˆã€‚
        
        **4. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ¨©åˆ©**
        ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã€æœ¬ã‚¢ãƒ—ãƒªã«ãŠã„ã¦ã€è‡ªã‚‰ã®ãƒ‡ãƒ¼ã‚¿ã«å¯¾ã™ã‚‹ä»¥ä¸‹ã®æ¨©åˆ©ã‚’æœ‰ã—ã¾ã™ã€‚
        - **ã‚¢ã‚¯ã‚»ã‚¹æ¨©ãŠã‚ˆã³ãƒãƒ¼ã‚¿ãƒ“ãƒªãƒ†ã‚£æ¨©**: ã„ã¤ã§ã‚‚è‡ªèº«ã®å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ã€å¾©å·ã•ã‚ŒãŸçŠ¶æ…‹ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼ˆã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼‰ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
        - **è¨‚æ­£æ¨©**: ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é€šã˜ã¦ã€è‡ªèº«ã®è¨˜éŒ²ãƒ‡ãƒ¼ã‚¿ãŠã‚ˆã³ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±ã‚’ä¿®æ­£ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
        - **å‰Šé™¤æ¨©ï¼ˆå¿˜ã‚Œã‚‰ã‚Œã‚‹æ¨©åˆ©ï¼‰**: ã„ã¤ã§ã‚‚è‡ªèº«ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¨ã€ã‚µãƒ¼ãƒãƒ¼ã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹å…¨ã¦ã®é–¢é€£ãƒ‡ãƒ¼ã‚¿ã‚’å®Œå…¨ã«å‰Šé™¤ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

        **5. å®‰å…¨ç®¡ç†æªç½®**
        å½“æ–¹ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æƒ…å ±ã®æ¼æ´©ã€æ»…å¤±ã¾ãŸã¯æ¯€æã®é˜²æ­¢ãã®ä»–ã®å®‰å…¨ç®¡ç†ã®ãŸã‚ã«ã€ä»¥ä¸‹ã®é€šã‚Šå¿…è¦ã‹ã¤é©åˆ‡ãªæªç½®ã‚’è¬›ã˜ã¾ã™ã€‚
        - **åŒ¿ååŒ–**: å€‹äººã‚’ç‰¹å®šã§ãã‚‹æƒ…å ±ã‚’å–å¾—ã—ãªã„è¨­è¨ˆã‚’æ¡ç”¨ã—ã¦ã„ã¾ã™ã€‚
        - **æš—å·åŒ–**: ã‚¤ãƒ™ãƒ³ãƒˆãƒ­ã‚°ã¯ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã§æš—å·åŒ–ã•ã‚Œã€é€šä¿¡ãŠã‚ˆã³ä¿ç®¡æ™‚ã‚‚æš—å·åŒ–ã•ã‚ŒãŸçŠ¶æ…‹ã‚’ç¶­æŒã—ã¾ã™ã€‚ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯ãƒãƒƒã‚·ãƒ¥åŒ–ã—ã¦ä¿å­˜ã—ã¾ã™ã€‚
        - **ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡**: ãƒ‡ãƒ¼ã‚¿ãŒä¿ç®¡ã•ã‚Œã‚‹ã‚µãƒ¼ãƒãƒ¼ï¼ˆGoogle Cloud Platformï¼‰ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã¯ã€å½“æ–¹ã«é™å®šã•ã‚Œã¦ã„ã¾ã™ã€‚

        **6. ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼ã®å¤‰æ›´**
        å½“æ–¹ã¯ã€å¿…è¦ã«å¿œã˜ã¦ã€æœ¬ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼ã‚’å¤‰æ›´ã™ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚é‡è¦ãªå¤‰æ›´ã‚’è¡Œã†å ´åˆã«ã¯ã€æœ¬ã‚¢ãƒ—ãƒªå†…ã§ã®é€šçŸ¥ãªã©ã€åˆ†ã‹ã‚Šã‚„ã™ã„æ–¹æ³•ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ãŠçŸ¥ã‚‰ã›ã—ã¾ã™ã€‚

        **7. ãŠå•ã„åˆã‚ã›çª“å£**
        æœ¬ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼ã«é–¢ã™ã‚‹ã”è³ªå•ã‚„ã”æ‡¸å¿µãŒã‚ã‚‹å ´åˆã¯ã€ä»¥ä¸‹ã®é€£çµ¡å…ˆã¾ã§ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚
        - **äº‹æ¥­è€…å**: [ã‚ãªãŸã®æ°åã¾ãŸã¯äº‹æ¥­å]
        - **é€£çµ¡å…ˆ**: [ã‚ãªãŸã®é€£çµ¡å…ˆãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãªã©]
        """)

def get_safe_index(options, value):
    try:
        return options.index(value)
    except (ValueError, TypeError):
        return 0

def migrate_and_ensure_schema(df: pd.DataFrame, user_id: str, sheet_id: str) -> pd.DataFrame:
    EXPECTED_COLUMNS = ['user_id', 'date', 'record_timestamp', 'consent', 'mode'] + Q_COLS + S_COLS + ['g_happiness', 'event_log'] + ALL_ELEMENT_COLS
    
    missing_cols = [col for col in EXPECTED_COLUMNS if col not in df.columns]

    if not missing_cols:
        final_order = [col for col in EXPECTED_COLUMNS if col in df.columns] + [c for c in df.columns if c not in EXPECTED_COLUMNS]
        return df[final_order]

    st.info("å¤ã„ãƒ‡ãƒ¼ã‚¿å½¢å¼ã‚’æ¤œå‡ºã—ã¾ã—ãŸã€‚æœ€æ–°ã®å½¢å¼ã«è‡ªå‹•çš„ã«æ›´æ–°ã—ã¾ã™...")
    
    df_migrated = df.copy()
    for col in missing_cols:
        if col == 'record_timestamp':
            df_migrated[col] = pd.to_datetime(df_migrated['date']) + timedelta(hours=12)
        else:
            df_migrated[col] = pd.NA

    final_cols_order = [col for col in EXPECTED_COLUMNS if col in df_migrated.columns]
    df_migrated = df_migrated[final_cols_order]

    try:
        all_data_df = read_data('data', sheet_id)
        if not all_data_df.empty:
            other_users_data = all_data_df[all_data_df['user_id'] != user_id]
            all_data_df_updated = pd.concat([other_users_data, df_migrated], ignore_index=True)

            if write_data('data', sheet_id, all_data_df_updated):
                st.success("ãƒ‡ãƒ¼ã‚¿å½¢å¼ã®æ›´æ–°ãŒå®Œäº†ã—ã€æ°¸ç¶šçš„ã«ä¿å­˜ã—ã¾ã—ãŸã€‚")
                return df_migrated
            else:
                st.error("ã‚¹ã‚­ãƒ¼ãƒæ›´æ–°ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ä¸€æ™‚çš„ãªãƒ‡ãƒ¼ã‚¿ã§ç¶šè¡Œã—ã¾ã™ã€‚")
                return df_migrated
    except Exception as e:
        st.warning(f"ã‚¹ã‚­ãƒ¼ãƒæ›´æ–°ã®ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}")
    
    return df_migrated

def run_wizard_interface(container):
    """ä¾¡å€¤è¦³ç™ºè¦‹ã‚¦ã‚£ã‚¶ãƒ¼ãƒ‰ã®UIã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã™ã‚‹å†åˆ©ç”¨å¯èƒ½ãªé–¢æ•°"""
    pairs = list(itertools.combinations(DOMAINS, 2))
    
    with container:
        st.header("ã‚ˆã†ã“ãï¼ã‚ãªãŸã®ç¾…é‡ç›¤ã‚’è¨­å®šã—ã¾ã—ã‚‡ã†")
        st.info("ã‚ãªãŸã®äººç”Ÿã¨ã„ã†èˆªæµ·ã§ã€ä½•ã‚’å¤§åˆ‡ã«ã—ãŸã„ã‹ã‚’è¦‹ã¤ã‘ã‚‹ãŸã‚ã®ã€æœ€åˆã®ã‚¹ãƒ†ãƒƒãƒ—ã§ã™ã€‚21ã®ç°¡å˜ãªè³ªå•ã«ç­”ãˆã‚‹ã“ã¨ã§ã€ã‚ãªãŸã®ä¾¡å€¤è¦³ã®ã€ŒãŸãŸãå°ã€ã‚’ä¸€ç·’ã«æ¢ã—ã¾ã—ã‚‡ã†ã€‚")

        progress_value = (st.session_state.q_wizard_step - 1) / len(pairs) if st.session_state.q_wizard_step > 0 else 0
        st.progress(progress_value, text=f"é€²æ—: {st.session_state.q_wizard_step - 1} / {len(pairs)}")

        if 0 < st.session_state.q_wizard_step <= len(pairs):
            pair = pairs[st.session_state.q_wizard_step - 1]
            domain1, domain2 = pair
            st.subheader(f"è³ªå• {st.session_state.q_wizard_step}/{len(pairs)}")
            st.write("ã‚ãªãŸã®äººç”ŸãŒã‚ˆã‚Šå……å®Ÿã™ã‚‹ãŸã‚ã«ã€ä»Šã€ã‚ˆã‚Šé‡è¦ãªã®ã¯ã©ã¡ã‚‰ã§ã™ã‹ï¼Ÿ")
            
            col1, col2 = st.columns(2)
            with col1:
                if st.button(DOMAIN_NAMES_JP_DICT[domain1], key=f"btn_{domain1}", use_container_width=True):
                    st.session_state.q_comparisons[pair] = domain1
                    st.session_state.q_wizard_step += 1
                    st.rerun()
                with st.expander("â–¼ ã“ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã«ã¯ã€ã©ã‚“ãªã€Œææ–™ã€ãŒå«ã¾ã‚Œã‚‹ï¼Ÿ"):
                    for element in LONG_ELEMENTS[domain1]:
                        st.markdown(f"- **{element}**: {ELEMENT_DEFINITIONS.get(element, '')}")

            with col2:
                if st.button(DOMAIN_NAMES_JP_DICT[domain2], key=f"btn_{domain2}", use_container_width=True):
                    st.session_state.q_comparisons[pair] = domain2
                    st.session_state.q_wizard_step += 1
                    st.rerun()
                with st.expander("â–¼ ã“ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã«ã¯ã€ã©ã‚“ãªã€Œææ–™ã€ãŒå«ã¾ã‚Œã‚‹ï¼Ÿ"):
                    for element in LONG_ELEMENTS[domain2]:
                        st.markdown(f"- **{element}**: {ELEMENT_DEFINITIONS.get(element, '')}")
        else:
            if st.session_state.q_comparisons:
                st.success("è¨ºæ–­å®Œäº†ï¼ã‚ãªãŸã®ä¾¡å€¤è¦³ã®æ¨å®šå€¤ãŒè¨ˆç®—ã•ã‚Œã¾ã—ãŸã€‚")
                estimated_weights = calculate_ahp_weights(st.session_state.q_comparisons, DOMAINS)
                
                st.session_state.q_values = {domain: weight for domain, weight in zip(DOMAINS, estimated_weights)}
                
                st.write("æ¨å®šã•ã‚ŒãŸã‚ãªãŸã®ä¾¡å€¤è¦³:")
                st.bar_chart({DOMAIN_NAMES_JP_DICT[k]: v for k, v in st.session_state.q_values.items()})

                if st.button("ã“ã®ä¾¡å€¤è¦³ã§èˆªæµ·ã‚’å§‹ã‚ã‚‹"):
                    user_id = st.session_state.user_id
                    all_data_df = read_data('data', st.secrets["connections"]["gsheets"]["data_sheet_id"])
                    
                    new_record = {'user_id': user_id, 'date': date.today(), 'record_timestamp': datetime.now(JST)}
                    new_record.update({f'q_{d}': v for d, v in st.session_state.q_values.items()})
                    new_df_row = pd.DataFrame([new_record])

                    all_data_df_updated = pd.concat([all_data_df, new_df_row], ignore_index=True)
                    all_data_df_updated = all_data_df_updated.sort_values(by=['user_id', 'date', 'record_timestamp']).reset_index(drop=True)

                    if write_data('data', st.secrets["connections"]["gsheets"]["data_sheet_id"], all_data_df_updated):
                        st.session_state.auth_status = "INITIALIZING_SESSION"
                        st.success("ä¾¡å€¤è¦³ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚ãƒ¡ã‚¤ãƒ³ç”»é¢ã«ç§»å‹•ã—ã¾ã™ã€‚")
                        time.sleep(1)
                        st.rerun()
                    else:
                        st.error("ä¾¡å€¤è¦³ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚")

# --- F. ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ ---
def main():
    st.title('ğŸ§­ Harmony Navigator')
    st.caption('v7.0.47 - Final Cache Invalidation Fix & Complete Code')

    try:
        users_sheet_id = st.secrets["connections"]["gsheets"]["users_sheet_id"]
        data_sheet_id = st.secrets["connections"]["gsheets"]["data_sheet_id"]
    except KeyError:
        st.error("Secretsã«ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆID (`users_sheet_id`, `data_sheet_id`) ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚")
        st.stop()

    if 'auth_status' not in st.session_state: st.session_state.auth_status = "NOT_LOGGED_IN"
    if 'user_id' not in st.session_state: st.session_state.user_id = None
    if 'enc_manager' not in st.session_state: st.session_state.enc_manager = None
    if 'q_values' not in st.session_state:
        st.session_state.q_values = {domain: 100 // len(DOMAINS) for domain in DOMAINS}
        st.session_state.q_values[DOMAINS[0]] += 100 % len(DOMAINS)
    if 'q_wizard_step' not in st.session_state: st.session_state.q_wizard_step = 0
    if 'q_comparisons' not in st.session_state: st.session_state.q_comparisons = {}

    auth_status = st.session_state.auth_status

    if auth_status == "NOT_LOGGED_IN":
        show_welcome_and_guide()
        st.subheader("ã‚ãªãŸã®æ—…ã‚’ã€ã“ã“ã‹ã‚‰å§‹ã‚ã¾ã—ã‚‡ã†")
        show_legal_documents()
        door1, door2 = st.tabs(["**æ–°ã—ã„èˆ¹ã§æ—…ã‚’å§‹ã‚ã‚‹ (åˆã‚ã¦ã®æ–¹)**", "**ç§˜å¯†ã®åˆã„è¨€è‘‰ã§ä¹—èˆ¹ã™ã‚‹ (2å›ç›®ä»¥é™ã®æ–¹)**"])
        with door1:
            with st.form("register_form"):
                agreement = st.checkbox("ä¸Šè¨˜ã®åˆ©ç”¨è¦ç´„ã¨ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼ã«åŒæ„ã—ã¾ã™ã€‚")
                new_password = st.text_input("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆ8æ–‡å­—ä»¥ä¸Šï¼‰", type="password")
                new_password_confirm = st.text_input("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆç¢ºèªç”¨ï¼‰", type="password")
                consent = st.checkbox("ç ”ç©¶å”åŠ›ã«é–¢ã™ã‚‹èª¬æ˜ã‚’èª­ã¿ã€ãã®å†…å®¹ã«åŒæ„ã—ã¾ã™ã€‚")
                submitted = st.form_submit_button("åŒæ„ã—ã¦ç™»éŒ²ã—ã€ç§˜å¯†ã®åˆã„è¨€è‘‰ã‚’ç™ºè¡Œã™ã‚‹")
                if submitted:
                    if not agreement: st.error("æ—…ã‚’å§‹ã‚ã‚‹ã«ã¯ã€åˆ©ç”¨è¦ç´„ã¨ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼ã«åŒæ„ã—ã¦ã„ãŸã ãå¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚")
                    elif len(new_password) < 8: st.error("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯8æ–‡å­—ä»¥ä¸Šã§è¨­å®šã—ã¦ãã ã•ã„ã€‚")
                    elif new_password != new_password_confirm: st.error("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¾ã›ã‚“ã€‚")
                    else:
                        new_user_id = f"user_{uuid.uuid4().hex[:12]}"
                        hashed_pw = EncryptionManager.hash_password(new_password)
                        
                        users_df = read_data('users', users_sheet_id)
                        
                        new_user_data = {
                            'user_id': new_user_id,
                            'password_hash': hashed_pw,
                            'consent': consent
                        }
                        for key in DEMOGRAPHIC_OPTIONS.keys():
                            new_user_data[key] = 'æœªé¸æŠ'

                        new_user_df = pd.DataFrame([new_user_data])
                        updated_users_df = pd.concat([users_df, new_user_df], ignore_index=True)
                        if write_data('users', users_sheet_id, updated_users_df):
                            st.session_state.user_id = new_user_id
                            st.session_state.enc_manager = EncryptionManager(new_password)
                            st.session_state.auth_status = "AWAITING_ID"
                            st.rerun()

        with door2:
            with st.form("login_form"):
                user_id_input = st.text_input("ã‚ãªãŸã®ã€Œç§˜å¯†ã®åˆã„è¨€è‘‰ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼IDï¼‰ã€ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„")
                password_input = st.text_input("ã‚ãªãŸã®ã€Œãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã€ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„", type="password")
                submitted = st.form_submit_button("ä¹—èˆ¹ã™ã‚‹")
                if submitted:
                    if user_id_input and password_input:
                        users_df = read_data('users', users_sheet_id)
                        if not users_df.empty:
                            user_record = users_df[users_df['user_id'] == user_id_input]
                            if not user_record.empty and EncryptionManager.check_password(password_input, user_record.iloc[0]['password_hash']):
                                st.session_state.user_id = user_id_input
                                st.session_state.enc_manager = EncryptionManager(password_input)
                                st.session_state.auth_status = "CHECKING_USER_DATA"
                                st.success("ä¹—èˆ¹ã«æˆåŠŸã—ã¾ã—ãŸï¼ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...")
                                time.sleep(1)
                                st.rerun()
                            else:
                                st.error("åˆã„è¨€è‘‰ã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé–“é•ã£ã¦ã„ã¾ã™ã€‚")
                        else:
                            st.error("ãã®åˆã„è¨€è‘‰ã‚’æŒã¤èˆ¹ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚")
                    else:
                        st.warning("åˆã„è¨€è‘‰ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®ä¸¡æ–¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚")

    elif auth_status == "AWAITING_ID":
        st.header("ã€ã‚ãªãŸã®èˆ¹ãŒã€å®Œæˆã—ã¾ã—ãŸã€‘")
        st.success("ã‚ˆã†ã“ãã€èˆªæµ·å£«ã¸ã€‚")
        st.warning(f"""
            **âš ï¸ã€å¿…ãšã€ä»Šã™ãã€å®‰å…¨ãªå ´æ‰€ã«è¨˜éŒ²ã—ã¦ãã ã•ã„ã€‘**\n
            ã“ã‚ŒãŒã€ã‚ãªãŸã®èˆ¹ã«æˆ»ã‚‹ãŸã‚ã®ã€ä¸–ç•Œã§ãŸã£ãŸä¸€ã¤ã®ã€ã‚ãªãŸã ã‘ã®**ã€ç§˜å¯†ã®åˆã„è¨€è‘‰ã€**ã§ã™ã€‚\n
            ã“ã®åˆã„è¨€è‘‰ã¯ã€**äºŒåº¦ã¨è¡¨ç¤ºã•ã‚Œã¾ã›ã‚“ã€‚** ã‚‚ã—å¤±ãã—ã¦ã—ã¾ã†ã¨ã€ã‚ãªãŸã®èˆªæµ·æ—¥èªŒã¯ã€æ°¸é ã«å¤±ã‚ã‚Œã¾ã™ã€‚
            """)
        st.code(st.session_state.user_id)
        st.info("ä¸Šè¨˜ã®åˆã„è¨€è‘‰ã‚’ã‚³ãƒ”ãƒ¼ã—ã€ã‚ãªãŸã ã‘ãŒçŸ¥ã‚‹ã€æœ€ã‚‚å®‰å…¨ãªå ´æ‰€ã«ã€å¤§åˆ‡ã«ä¿ç®¡ã—ã¦ãã ã•ã„ã€‚")
        if st.button("ã¯ã„ã€å®‰å…¨ã«ä¿ç®¡ã—ã¾ã—ãŸã€‚æ—…ã‚’å§‹ã‚ã‚‹"):
            st.session_state.auth_status = "AWAITING_WIZARD"
            st.session_state.q_wizard_step = 1
            st.session_state.q_comparisons = {}
            st.rerun()
    
    elif auth_status == "AWAITING_WIZARD":
        run_wizard_interface(st.container())

    elif auth_status == "CHECKING_USER_DATA":
        user_id = st.session_state.user_id
        all_data_df = read_data('data', data_sheet_id)
        if not all_data_df.empty and 'user_id' in all_data_df.columns and user_id in all_data_df['user_id'].values:
            user_data_df = all_data_df[all_data_df['user_id'] == user_id].copy()
            user_data_df = migrate_and_ensure_schema(user_data_df, user_id, data_sheet_id)
            has_q_data = not user_data_df[Q_COLS].dropna(how='all').empty
            if not has_q_data:
                st.session_state.auth_status = "AWAITING_WIZARD"
                st.session_state.q_wizard_step = 1
                st.session_state.q_comparisons = {}
            else:
                st.session_state.auth_status = "INITIALIZING_SESSION"
        else:
            st.session_state.auth_status = "AWAITING_WIZARD"
            st.session_state.q_wizard_step = 1
            st.session_state.q_comparisons = {}
        st.rerun()

    elif auth_status == "INITIALIZING_SESSION":
        user_id = st.session_state.user_id
        all_data_df = read_data('data', data_sheet_id)
        user_data_df = all_data_df[all_data_df['user_id'] == user_id].copy()
        
        if 'record_timestamp' not in user_data_df.columns:
             user_data_df['record_timestamp'] = pd.to_datetime(user_data_df['date'])
        
        user_data_df['record_timestamp'] = pd.to_datetime(user_data_df['record_timestamp'], errors='coerce')

        q_data_rows = user_data_df.dropna(subset=Q_COLS, how='all')
        
        if not q_data_rows.empty:
            latest_q_row = q_data_rows.sort_values(by='record_timestamp', ascending=False).iloc[0]
            
            latest_q_dict = latest_q_row[Q_COLS].to_dict()
            st.session_state.q_values = {key.replace('q_', ''): int(val) for key, val in latest_q_dict.items() if isinstance(val, (int, float)) and pd.notna(val)}
        
        st.session_state.auth_status = "LOGGED_IN_UNLOCKED"
        st.rerun()

    elif auth_status == "LOGGED_IN_UNLOCKED":
        user_id = st.session_state.user_id
        
        all_data_df = read_data('data', data_sheet_id)
        user_data_df = all_data_df[all_data_df['user_id'] == user_id].copy()
            
        st.sidebar.header(f"ã‚ˆã†ã“ãã€{user_id} ã•ã‚“ï¼")
        if st.sidebar.button("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆï¼ˆä¸‹èˆ¹ã™ã‚‹ï¼‰"):
            for key in list(st.session_state.keys()):
                del st.session_state[key]
            st.rerun()
        
        st.sidebar.markdown("---")
        st.sidebar.header('âš™ï¸ ä¾¡å€¤è¦³ (q_t) ã®è¨­å®š')
        with st.sidebar.expander("â–¼ ã“ã‚Œã¯ã€ä½•ã®ãŸã‚ã«è¨­å®šã™ã‚‹ã®ï¼Ÿ"):
            st.markdown(EXPANDER_TEXTS['q_t'])
        
        for domain in DOMAINS:
            st.session_state.q_values[domain] = st.sidebar.slider(
                DOMAIN_NAMES_JP_DICT[domain], 0, 100, 
                st.session_state.q_values.get(domain, 14), 
                key=f"q_{domain}"
            )

        q_total = sum(st.session_state.q_values.values())
        st.sidebar.metric(label="ç¾åœ¨ã®åˆè¨ˆå€¤", value=q_total)
        if q_total != 100:
            st.sidebar.warning(f"åˆè¨ˆãŒ100ã«ãªã‚‹ã‚ˆã†ã«èª¿æ•´ã—ã¦ãã ã•ã„ã€‚ (ç¾åœ¨: {q_total})")
        else:
            st.sidebar.success("åˆè¨ˆã¯100ã§ã™ã€‚å…¥åŠ›æº–å‚™OKï¼")

        tab1, tab2, tab3 = st.tabs(["**âœï¸ ä»Šæ—¥ã®è¨˜éŒ²**", "**ğŸ“Š ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰**", "**ğŸ”§ è¨­å®šã¨ã‚¬ã‚¤ãƒ‰**"])

        with tab1:
            st.header(f"ä»Šæ—¥ã®èˆªæµ·æ—¥èªŒã‚’è¨˜éŒ²ã™ã‚‹")
            st.markdown("##### è¨˜éŒ²ã™ã‚‹æ—¥ä»˜")
            today = date.today()
            target_date = st.date_input("è¨˜éŒ²ã™ã‚‹æ—¥ä»˜:", value=today, min_value=today - timedelta(days=365), max_value=today, label_visibility="collapsed")
            
            is_already_recorded = False
            if not user_data_df.empty:
                date_match = user_data_df[user_data_df['date'] == target_date]
                if not date_match.empty and pd.notna(date_match.iloc[0].get('g_happiness')):
                    is_already_recorded = True
            
            if is_already_recorded:
                st.warning(f"âš ï¸ {target_date.strftime('%Y-%m-%d')} ã®ãƒ‡ãƒ¼ã‚¿ã¯æ—¢ã«è¨˜éŒ²ã•ã‚Œã¦ã„ã¾ã™ã€‚ä¿å­˜ã™ã‚‹ã¨ä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚")

            st.markdown("##### è¨˜éŒ²ãƒ¢ãƒ¼ãƒ‰")
            input_mode = st.radio("è¨˜éŒ²ãƒ¢ãƒ¼ãƒ‰:", ('ğŸš€ ã‚¯ã‚¤ãƒƒã‚¯ãƒ»ãƒ­ã‚° (ãƒ‰ãƒ¡ã‚¤ãƒ³åˆ¥è©•ä¾¡)', 'ğŸ”¬ ãƒ‡ã‚£ãƒ¼ãƒ—ãƒ»ãƒ€ã‚¤ãƒ– (è©³ç´°é …ç›®è©•ä¾¡)'), horizontal=True)
            
            with st.form(key='daily_input_form'):
                s_element_values = {}
                s_domain_values = {}
                
                caption_text = "0:å…¨ãå½“ã¦ã¯ã¾ã‚‰ãªã„ | 25:ã‚ã¾ã‚Š.. | 50:ã©ã¡ã‚‰ã¨ã‚‚.. | 75:ã‚„ã‚„.. | 100:å®Œå…¨ã«å½“ã¦ã¯ã¾ã‚‹"

                if 'ã‚¯ã‚¤ãƒƒã‚¯' in input_mode:
                    mode_string = 'quick'
                    st.info("ä»Šæ—¥ä¸€æ—¥ã‚’æŒ¯ã‚Šè¿”ã‚Šã€7ã¤ã®å¹¸ç¦ã®é ˜åŸŸãŒã€ãã‚Œãã‚Œã©ã‚Œãã‚‰ã„æº€ãŸã•ã‚Œã¦ã„ãŸã‹ã‚’è©•ä¾¡ã—ã¦ãã ã•ã„ã€‚")
                    for domain in DOMAINS:
                        st.markdown(f"**{DOMAIN_NAMES_JP_DICT[domain]}**")
                        with st.expander("â–¼ ã“ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã«ã¯ã€ã©ã‚“ãªã€Œææ–™ã€ãŒå«ã¾ã‚Œã‚‹ï¼Ÿ"):
                            for element in LONG_ELEMENTS[domain]:
                                st.markdown(f"- **{element}**: {ELEMENT_DEFINITIONS.get(element, '')}")
                        s_domain_values['s_' + domain] = st.slider(label=f"slider_{domain}", min_value=0, max_value=100, value=50, key=f"s_{domain}", label_visibility="collapsed")
                        st.caption(caption_text)

                else:
                    mode_string = 'deep'
                    col1, col2 = st.columns(2)
                    latest_s_elements = pd.Series(dtype=float)
                    if not user_data_df.empty:
                        sortable_df_deep = user_data_df.dropna(subset=['date']).sort_values(by='date', ascending=False)
                        if not sortable_df_deep.empty:
                            latest_s_elements = sortable_df_deep.iloc[0]

                    for i, domain in enumerate(DOMAINS):
                        container = col1 if i < 4 else col2
                        with container:
                            with st.expander(f"**{DOMAIN_NAMES_JP_DICT[domain]}**", expanded=True):
                                for element in LONG_ELEMENTS[domain]:
                                    col_name = f's_element_{element}'
                                    val = latest_s_elements.get(col_name, 50)
                                    default_val = 50 if pd.isna(val) else int(val)
                                    
                                    st.markdown(f"**{element}**")
                                    st.caption(ELEMENT_DEFINITIONS.get(element, ""))
                                    score = st.slider(label=f"slider_{col_name}", min_value=0, max_value=100, value=default_val, key=col_name, label_visibility="collapsed")
                                    st.caption(caption_text)
                                    s_element_values[col_name] = int(score)

                st.markdown('**ç·åˆçš„ãªå¹¸ç¦æ„Ÿ (Gt)**')
                with st.expander("â–¼ ã“ã‚Œã¯ãªãœå¿…è¦ï¼Ÿ"): st.markdown(EXPANDER_TEXTS['g_t'])
                g_happiness = st.slider(label="slider_g_happiness", min_value=0, max_value=100, value=50, label_visibility="collapsed")
                st.caption(caption_text)
                
                st.markdown('**ä»Šæ—¥ã®å‡ºæ¥äº‹ã‚„æ°—ã¥ãã¯ï¼Ÿï¼ˆã‚ãªãŸã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§æš—å·åŒ–ã•ã‚Œã¾ã™ï¼‰**')
                with st.expander("â–¼ ãªãœæ›¸ãã®ãŒãŠã™ã™ã‚ï¼Ÿ"): st.markdown(EXPANDER_TEXTS['event_log'])
                event_log = st.text_area('', height=100, label_visibility="collapsed")
                
                submitted = st.form_submit_button('ä»Šæ—¥ã®è¨˜éŒ²ã‚’ä¿å­˜ã™ã‚‹')
                
                if submitted:
                    if sum(st.session_state.q_values.values()) != 100:
                        st.error('ä¾¡å€¤è¦³ (q_t) ã®åˆè¨ˆãŒ100ã«ãªã£ã¦ã„ã¾ã›ã‚“ã€‚ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚')
                    else:
                        new_record = {}
                        if mode_string == 'deep':
                            new_record.update({col: pd.NA for col in ALL_ELEMENT_COLS})
                            new_record.update(s_element_values)
                            s_domain_scores = calculate_s_domains_from_row(pd.Series(new_record))
                            new_record.update(s_domain_scores.to_dict())
                        else: # quick
                            new_record.update(s_domain_values)

                        encrypted_log = st.session_state.enc_manager.encrypt_log(event_log)
                        
                        users_df_in_form = read_data('users', users_sheet_id)
                        user_info_in_form = users_df_in_form[users_df_in_form['user_id'] == user_id]
                        consent_status = user_info_in_form['consent'].iloc[0] if not user_info_in_form.empty and 'consent' in user_info_in_form.columns else False

                        new_record.update({
                            'user_id': user_id, 
                            'date': target_date,
                            'record_timestamp': datetime.now(JST),
                            'mode': mode_string,
                            'consent': consent_status,
                            'g_happiness': int(g_happiness), 
                            'event_log': encrypted_log
                        })
                        new_record.update({f'q_{d}': v for d, v in st.session_state.q_values.items()})

                        new_df_row = pd.DataFrame([new_record])
                        
                        all_data_df_to_update = read_data('data', data_sheet_id)
                        if not all_data_df_to_update.empty:
                            condition = (all_data_df_to_update['user_id'] == user_id) & (pd.to_datetime(all_data_df_to_update['date']).dt.date == target_date)
                            all_data_df_to_update = all_data_df_to_update[~condition]

                        all_data_df_updated = pd.concat([all_data_df_to_update, new_df_row], ignore_index=True)
                        all_data_df_updated = all_data_df_updated.sort_values(by=['user_id', 'date', 'record_timestamp']).reset_index(drop=True)
                        
                        if write_data('data', data_sheet_id, all_data_df_updated):
                            st.success(f'{target_date.strftime("%Y-%m-%d")} ã®è¨˜éŒ²ã‚’æ°¸ç¶šçš„ã«ä¿å­˜ã—ã¾ã—ãŸï¼')
                            st.balloons()
                            time.sleep(1)
                            st.rerun()
                        else:
                             st.error("ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚å¾Œã§ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚")
        with tab2:
            st.header('ğŸ“Š ã‚ãªãŸã®èˆªæµ·ãƒãƒ£ãƒ¼ãƒˆ')
            with st.expander("â–¼ ã“ã®ãƒãƒ£ãƒ¼ãƒˆã®è¦‹æ–¹", expanded=True):
                st.markdown(EXPANDER_TEXTS['dashboard'])

            df_to_process = user_data_df.copy()
            if df_to_process.dropna(subset=Q_COLS, how='all').empty:
                st.info('ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã¾ãšã¯ã€Œä»Šæ—¥ã®è¨˜éŒ²ã€ã‚¿ãƒ–ã‹ã‚‰ã€æœ€åˆã®æ—¥èªŒã‚’è¨˜éŒ²ã—ã¦ã¿ã¾ã—ã‚‡ã†ï¼')
            else:
                df_processed = calculate_metrics(df_to_process, alpha=0.6)
                if 'date' in df_processed.columns:
                    df_processed['date'] = pd.to_datetime(df_processed['date'])
                    df_processed = df_processed.sort_values('date')
                
                st.subheader("ğŸ“ˆ æœŸé–“åˆ†æã¨ãƒªã‚¹ã‚¯è©•ä¾¡ (RHI)")
                
                period_options = [7, 30, 90]
                
                df_period = df_processed
                if len(df_processed.dropna(subset=['H'])) >= 7:
                    valid_periods = [p for p in period_options if len(df_processed.dropna(subset=['H'])) >= p]
                    default_index = len(valid_periods) - 1 if valid_periods else 0
                    selected_period = st.selectbox("åˆ†ææœŸé–“ã‚’é¸æŠã—ã¦ãã ã•ã„ï¼ˆæ—¥ï¼‰:", valid_periods, index=default_index)
                    df_period = df_processed.dropna(subset=['H']).tail(selected_period)

                    st.markdown("##### ã‚ãªãŸã®ãƒªã‚¹ã‚¯è¨±å®¹åº¦ã‚’è¨­å®š")
                    col1, col2, col3 = st.columns(3)
                    lambda_param = col1.slider("å¤‰å‹•(ä¸å®‰å®šã•)ã¸ã®ãƒšãƒŠãƒ«ãƒ†ã‚£(Î»)", 0.0, 2.0, 0.5, 0.1, help="å€¤ãŒå¤§ãã„ã»ã©ã€æ—¥ã€…ã®å¹¸ç¦åº¦ã®æµ®ãæ²ˆã¿ãŒæ¿€ã—ã„ã“ã¨ã‚’ã€ã‚ˆã‚Šé‡ãè©•ä¾¡ã—ã¾ã™ã€‚")
                    gamma_param = col2.slider("ä¸‹æŒ¯ã‚Œ(ä¸èª¿)ã¸ã®ãƒšãƒŠãƒ«ãƒ†ã‚£(Î³)", 0.0, 2.0, 1.0, 0.1, help="å€¤ãŒå¤§ãã„ã»ã©ã€å¹¸ç¦åº¦ãŒä½ã„æ—¥ãŒç¶šãã“ã¨ã‚’ã€ã‚ˆã‚Šæ·±åˆ»ãªå•é¡Œã¨ã—ã¦è©•ä¾¡ã—ã¾ã™ã€‚")
                    tau_param = col3.slider("ã€Œä¸èª¿ã€ã¨è¦‹ãªã™é–¾å€¤(Ï„)", 0.0, 1.0, 0.5, 0.05, help="ã“ã®å€¤ã‚’ä¸‹å›ã‚‹æ—¥ã‚’ã€Œä¸èª¿ãªæ—¥ã€ã¨ã—ã¦ã‚«ã‚¦ãƒ³ãƒˆã—ã¾ã™ã€‚")

                    rhi_results = calculate_rhi_metrics(df_period, lambda_param, gamma_param, tau_param)

                    st.markdown("##### åˆ†æçµæœ")
                    col1a, col2a, col3a, col4a = st.columns(4)
                    col1a.metric("å¹³å‡èª¿å’Œåº¦ (HÌ„)", f"{rhi_results['mean_H']:.3f}")
                    col2a.metric("å¤‰å‹•ãƒªã‚¹ã‚¯ (Ïƒ)", f"{rhi_results['std_H']:.3f}")
                    col3a.metric("ä¸èª¿æ—¥æ•°å‰²åˆ", f"{rhi_results['frac_below']:.1%}")
                    col4a.metric("ãƒªã‚¹ã‚¯èª¿æ•´æ¸ˆãƒ»å¹¸ç¦æŒ‡æ•° (RHI)", f"{rhi_results['RHI']:.3f}", delta=f"{rhi_results['RHI'] - rhi_results['mean_H']:.3f} (å¹³å‡ã¨ã®å·®)")
                else:
                    st.info(f"ç¾åœ¨{len(df_processed.dropna(subset=['H']))}æ—¥åˆ†ã®æœ‰åŠ¹ãªãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã™ã€‚æœŸé–“åˆ†æï¼ˆRHIãªã©ï¼‰ã«ã¯æœ€ä½7æ—¥åˆ†ã®ãƒ‡ãƒ¼ã‚¿ãŒå¿…è¦ã§ã™ã€‚")

                if not df_processed.empty:
                    analyze_discrepancy(df_processed)
                    st.subheader('èª¿å’Œåº¦ (H) ã®æ¨ç§»')
                    st.line_chart(df_processed.set_index('date')['H'])

                    st.subheader("ğŸ” æ§‹é€ åˆ†æï¼šã‚ãªãŸã®ä¾¡å€¤è¦³ã¨çµŒé¨“")
                    col_chart1, col_chart2 = st.columns(2)
                    
                    with col_chart1:
                        st.markdown("##### ä¾¡å€¤è¦³ vs çµŒé¨“ ãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒãƒ£ãƒ¼ãƒˆ")
                        
                        latest_q_values = np.array([st.session_state.q_values[d] for d in DOMAINS])
                        avg_q = latest_q_values
                        avg_s = df_period[S_COLS].mean().values
                        
                        s_achieved_ratio = avg_s / 100.0 
                        s_plot = avg_q * s_achieved_ratio

                        fig = go.Figure()

                        fig.add_trace(go.Scatterpolar(
                              r=np.append(s_plot, s_plot[0]),
                              theta=np.append(DOMAIN_NAMES_JP_VALUES, DOMAIN_NAMES_JP_VALUES[0]),
                              fill='toself',
                              name='ã‚ãªãŸã®çµŒé¨“ (ç¾å®Ÿã®å½¢)'
                        ))
                        fig.add_trace(go.Scatterpolar(
                              r=np.append(avg_q, avg_q[0]),
                              theta=np.append(DOMAIN_NAMES_JP_VALUES, DOMAIN_NAMES_JP_VALUES[0]),
                              fill='none',
                              name='ã‚ãªãŸã®ä¾¡å€¤è¦³ (ç†æƒ³ã®å½¢)'
                        ))

                        dynamic_range_max = max(40, int(avg_q.max()) + 10) if avg_q.any() and avg_q.max() > 0 else 40
                        fig.update_layout(
                          polar=dict(
                            radialaxis=dict(
                              visible=True,
                              range=[0, dynamic_range_max]
                            )),
                          showlegend=True,
                          legend=dict(yanchor="top", y=1.15, xanchor="left", x=0.01)
                        )
                        st.plotly_chart(fig, use_container_width=True)

                    with col_chart2:
                        st.markdown("##### ä¾¡å€¤è¦³-çµŒé¨“ ã‚®ãƒ£ãƒƒãƒ—åˆ†æ")
                        st.caption("ç®—å‡ºæ–¹æ³•: ã‚®ãƒ£ãƒƒãƒ—(%) = ã‚ãªãŸã®ä¾¡å€¤è¦³ã®æ§‹æˆæ¯” - ã‚ãªãŸã®çµŒé¨“ã®æ§‹æˆæ¯”")
                        
                        q_norm = avg_q / avg_q.sum() * 100 if avg_q.sum() > 0 else avg_q
                        s_norm = avg_s / avg_s.sum() * 100 if avg_s.sum() > 0 else avg_s

                        gap_data = pd.DataFrame({
                            'domain': DOMAIN_NAMES_JP_VALUES,
                            'gap': q_norm - s_norm
                        }).sort_values('gap', ascending=False)
                        
                        fig_bar = px.bar(gap_data, x='gap', y='domain', orientation='h',
                                     color='gap',
                                     color_continuous_scale='RdBu',
                                     color_continuous_midpoint=0,
                                     labels={'gap':'ã‚®ãƒ£ãƒƒãƒ— (%ãƒã‚¤ãƒ³ãƒˆ)', 'domain':'ãƒ‰ãƒ¡ã‚¤ãƒ³'},
                                     title="+: ä¾¡å€¤è¦³ > çµŒé¨“ (èª²é¡Œ), -: çµŒé¨“ > ä¾¡å€¤è¦³ (å¼·ã¿)")
                        fig_bar.update_layout(yaxis={'categoryorder':'total ascending'})
                        st.plotly_chart(fig_bar, use_container_width=True)

                    st.subheader('å…¨è¨˜éŒ²ãƒ‡ãƒ¼ã‚¿')
                    df_display = user_data_df.copy()
                    if 'event_log' in df_display.columns:
                        df_display['event_log'] = df_display['event_log'].apply(st.session_state.enc_manager.decrypt_log)
                        df_display.rename(columns={'event_log': 'ã‚¤ãƒ™ãƒ³ãƒˆãƒ­ã‚°ï¼ˆå¾©å·æ¸ˆï¼‰'}, inplace=True)
                    st.dataframe(df_display.drop(columns=['user_id'], errors='ignore').sort_values(by='date', ascending=False).round(3))
        
        with tab3:
            st.header("ğŸ”§ è¨­å®šã¨ã‚¬ã‚¤ãƒ‰")
            
            st.subheader("ä¾¡å€¤è¦³ã®å†ç™ºè¦‹")
            st.info("ç¾åœ¨ã®ä¾¡å€¤è¦³ã‚’è¦‹ç›´ã—ãŸã„å ´åˆã¯ã€ã„ã¤ã§ã‚‚ã“ã“ã‹ã‚‰ã‚¦ã‚£ã‚¶ãƒ¼ãƒ‰ã‚’å†å®Ÿè¡Œã§ãã¾ã™ã€‚")
            if st.button("ä¾¡å€¤è¦³ç™ºè¦‹ã‚¦ã‚£ã‚¶ãƒ¼ãƒ‰ã‚’å§‹ã‚ã‚‹"):
                st.session_state.auth_status = "AWAITING_WIZARD"
                st.session_state.q_wizard_step = 1
                st.session_state.q_comparisons = {}
                st.rerun()

            st.markdown('---')
            st.subheader("ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±ï¼ˆç ”ç©¶å”åŠ›ç”¨ï¼‰")
            with st.form("profile_form"):
                users_df_for_profile = read_data('users', users_sheet_id)
                user_info = users_df_for_profile[users_df_for_profile['user_id'] == user_id]
                current_profile = user_info.iloc[0] if not user_info.empty else pd.Series()
                
                age_group = st.selectbox("å¹´ä»£", options=DEMOGRAPHIC_OPTIONS['age_group'], index=get_safe_index(DEMOGRAPHIC_OPTIONS['age_group'], current_profile.get('age_group')))
                gender = st.selectbox("æ€§åˆ¥", options=DEMOGRAPHIC_OPTIONS['gender'], index=get_safe_index(DEMOGRAPHIC_OPTIONS['gender'], current_profile.get('gender')))
                occupation_category = st.selectbox("è·æ¥­", options=DEMOGRAPHIC_OPTIONS['occupation_category'], index=get_safe_index(DEMOGRAPHIC_OPTIONS['occupation_category'], current_profile.get('occupation_category')))
                income_range = st.selectbox("å¹´å", options=DEMOGRAPHIC_OPTIONS['income_range'], index=get_safe_index(DEMOGRAPHIC_OPTIONS['income_range'], current_profile.get('income_range')))
                marital_status = st.selectbox("å©šå§»çŠ¶æ³", options=DEMOGRAPHIC_OPTIONS['marital_status'], index=get_safe_index(DEMOGRAPHIC_OPTIONS['marital_status'], current_profile.get('marital_status')))
                has_children = st.selectbox("å­ä¾›ã®æœ‰ç„¡", options=DEMOGRAPHIC_OPTIONS['has_children'], index=get_safe_index(DEMOGRAPHIC_OPTIONS['has_children'], current_profile.get('has_children')))
                living_situation = st.selectbox("å±…ä½å½¢æ…‹", options=DEMOGRAPHIC_OPTIONS['living_situation'], index=get_safe_index(DEMOGRAPHIC_OPTIONS['living_situation'], current_profile.get('living_situation')))
                chronic_illness = st.selectbox("æ…¢æ€§ç–¾æ‚£", options=DEMOGRAPHIC_OPTIONS['chronic_illness'], index=get_safe_index(DEMOGRAPHIC_OPTIONS['chronic_illness'], current_profile.get('chronic_illness')))
                country = st.selectbox("å›½", options=DEMOGRAPHIC_OPTIONS['country'], index=get_safe_index(DEMOGRAPHIC_OPTIONS['country'], current_profile.get('country')))
                
                profile_submitted = st.form_submit_button("ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’ä¿å­˜ã™ã‚‹")

                if profile_submitted:
                    users_df_update = read_data('users', users_sheet_id)
                    users_df_update.loc[users_df_update['user_id'] == user_id, 'age_group'] = age_group
                    users_df_update.loc[users_df_update['user_id'] == user_id, 'gender'] = gender
                    users_df_update.loc[users_df_update['user_id'] == user_id, 'occupation_category'] = occupation_category
                    users_df_update.loc[users_df_update['user_id'] == user_id, 'income_range'] = income_range
                    users_df_update.loc[users_df_update['user_id'] == user_id, 'marital_status'] = marital_status
                    users_df_update.loc[users_df_update['user_id'] == user_id, 'has_children'] = has_children
                    users_df_update.loc[users_df_update['user_id'] == user_id, 'living_situation'] = living_situation
                    users_df_update.loc[users_df_update['user_id'] == user_id, 'chronic_illness'] = chronic_illness
                    users_df_update.loc[users_df_update['user_id'] == user_id, 'country'] = country
                    
                    if write_data('users', users_sheet_id, users_df_update):
                        st.success("ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±ã‚’æ›´æ–°ã—ã¾ã—ãŸï¼")
                        time.sleep(1)
                        st.rerun()
                    else:
                        st.error("ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚")

            st.markdown('---')
            st.subheader("ãƒ‡ãƒ¼ã‚¿ã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ")
            if not user_data_df.empty:
                df_export = user_data_df.copy()
                if 'event_log' in df_export.columns:
                    df_export['event_log_decrypted'] = df_export['event_log'].apply(st.session_state.enc_manager.decrypt_log)
                
                csv_export = df_export.to_csv(index=False).encode('utf-8')
                st.download_button(label="ğŸ“¥ å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰", data=csv_export, file_name=f'harmony_data_{user_id}.csv')

            st.markdown('---')
            st.subheader("ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤")
            with st.form("delete_form"):
                st.warning("ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚")
                password_for_delete = st.text_input("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„", type="password")
                delete_submitted = st.form_submit_button("ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¨å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å®Œå…¨ã«å‰Šé™¤ã™ã‚‹")

                if delete_submitted:
                    users_df_to_delete = read_data('users', users_sheet_id)
                    user_record = users_df_to_delete[users_df_to_delete['user_id'] == user_id]
                    if not user_record.empty and EncryptionManager.check_password(password_for_delete, user_record.iloc[0]['password_hash']):
                        users_df_updated = users_df_to_delete[users_df_to_delete['user_id'] != user_id]
                        if write_data('users', users_sheet_id, users_df_updated):
                            all_data_df_to_delete = read_data('data', data_sheet_id)
                            all_data_df_updated = all_data_df_to_delete[all_data_df_to_delete['user_id'] != user_id]
                            if write_data('data', data_sheet_id, all_data_df_updated):
                                for key in list(st.session_state.keys()):
                                    del st.session_state[key]
                                st.success("ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¨é–¢é€£ã™ã‚‹å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚")
                                time.sleep(2)
                                st.rerun()
                            else:
                                st.error("ãƒ‡ãƒ¼ã‚¿ã‚·ãƒ¼ãƒˆã‹ã‚‰ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚")
                        else:
                             st.error("ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚·ãƒ¼ãƒˆã‹ã‚‰ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚")
                    else:
                        st.error("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé–“é•ã£ã¦ã„ã¾ã™ã€‚")
            
            st.markdown("---")
            st.subheader("ã“ã®ã‚¢ãƒ—ãƒªã«ã¤ã„ã¦")
            show_welcome_and_guide()
        
    else: # NOT_LOGGED_IN
        show_welcome_and_guide()
        st.subheader("ã‚ãªãŸã®æ—…ã‚’ã€ã“ã“ã‹ã‚‰å§‹ã‚ã¾ã—ã‚‡ã†")
        show_legal_documents()
        door1, door2 = st.tabs(["**æ–°ã—ã„èˆ¹ã§æ—…ã‚’å§‹ã‚ã‚‹ (åˆã‚ã¦ã®æ–¹)**", "**ç§˜å¯†ã®åˆã„è¨€è‘‰ã§ä¹—èˆ¹ã™ã‚‹ (2å›ç›®ä»¥é™ã®æ–¹)**"])

        with door1:
            with st.form("register_form"):
                agreement = st.checkbox("ä¸Šè¨˜ã®åˆ©ç”¨è¦ç´„ã¨ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼ã«åŒæ„ã—ã¾ã™ã€‚")
                new_password = st.text_input("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆ8æ–‡å­—ä»¥ä¸Šï¼‰", type="password")
                new_password_confirm = st.text_input("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆç¢ºèªç”¨ï¼‰", type="password")
                consent = st.checkbox("ç ”ç©¶å”åŠ›ã«é–¢ã™ã‚‹èª¬æ˜ã‚’èª­ã¿ã€ãã®å†…å®¹ã«åŒæ„ã—ã¾ã™ã€‚")
                submitted = st.form_submit_button("åŒæ„ã—ã¦ç™»éŒ²ã—ã€ç§˜å¯†ã®åˆã„è¨€è‘‰ã‚’ç™ºè¡Œã™ã‚‹")
                if submitted:
                    if not agreement: st.error("æ—…ã‚’å§‹ã‚ã‚‹ã«ã¯ã€åˆ©ç”¨è¦ç´„ã¨ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼ã«åŒæ„ã—ã¦ã„ãŸã ãå¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚")
                    elif len(new_password) < 8: st.error("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯8æ–‡å­—ä»¥ä¸Šã§è¨­å®šã—ã¦ãã ã•ã„ã€‚")
                    elif new_password != new_password_confirm: st.error("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¾ã›ã‚“ã€‚")
                    else:
                        new_user_id = f"user_{uuid.uuid4().hex[:12]}"
                        hashed_pw = EncryptionManager.hash_password(new_password)
                        
                        users_df = read_data('users', users_sheet_id)
                        
                        new_user_data = {
                            'user_id': new_user_id,
                            'password_hash': hashed_pw,
                            'consent': consent
                        }
                        for key in DEMOGRAPHIC_OPTIONS.keys():
                            new_user_data[key] = 'æœªé¸æŠ'

                        new_user_df = pd.DataFrame([new_user_data])
                        updated_users_df = pd.concat([users_df, new_user_df], ignore_index=True)
                        if write_data('users', users_sheet_id, updated_users_df):
                            st.session_state.user_id = new_user_id
                            st.session_state.enc_manager = EncryptionManager(new_password)
                            st.session_state.auth_status = "AWAITING_ID"
                            st.rerun()

        with door2:
            with st.form("login_form"):
                user_id_input = st.text_input("ã‚ãªãŸã®ã€Œç§˜å¯†ã®åˆã„è¨€è‘‰ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼IDï¼‰ã€ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„")
                password_input = st.text_input("ã‚ãªãŸã®ã€Œãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã€ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„", type="password")
                submitted = st.form_submit_button("ä¹—èˆ¹ã™ã‚‹")
                if submitted:
                    if user_id_input and password_input:
                        users_df = read_data('users', users_sheet_id)
                        if not users_df.empty:
                            user_record = users_df[users_df['user_id'] == user_id_input]
                            if not user_record.empty and EncryptionManager.check_password(password_input, user_record.iloc[0]['password_hash']):
                                st.session_state.user_id = user_id_input
                                st.session_state.enc_manager = EncryptionManager(password_input)
                                st.session_state.auth_status = "CHECKING_USER_DATA"
                                st.success("ä¹—èˆ¹ã«æˆåŠŸã—ã¾ã—ãŸï¼ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...")
                                time.sleep(1)
                                st.rerun()
                            else:
                                st.error("åˆã„è¨€è‘‰ã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé–“é•ã£ã¦ã„ã¾ã™ã€‚")
                        else:
                            st.error("ãã®åˆã„è¨€è‘‰ã‚’æŒã¤èˆ¹ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚")
                    else:
                        st.warning("åˆã„è¨€è‘‰ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®ä¸¡æ–¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚")

if __name__ == '__main__':
    main()
