import streamlit as st
import pandas as pd
import numpy as np
from scipy.spatial.distance import jensenshannon
import os
from datetime import datetime, date, timedelta
import re
import glob

# --- 0. å®šæ•°ã¨åŸºæœ¬è¨­å®š ---
st.set_page_config(layout="wide", page_title="Harmony Navigator")
# ... (v1.2.2ã®å®šæ•°å®šç¾©ã‚’å…¨ã¦ã“ã“ã«ã‚³ãƒ”ãƒ¼)
DOMAINS = ['health', 'relationships', 'meaning', 'autonomy', 'finance', 'leisure', 'competition']
DOMAIN_NAMES_JP = {
    'health': '1. å¥åº·', 'relationships': '2. äººé–“é–¢ä¿‚', 'meaning': '3. æ„å‘³ãƒ»è²¢çŒ®',
    'autonomy': '4. è‡ªå¾‹ãƒ»æˆé•·', 'finance': '5. çµŒæ¸ˆ', 'leisure': '6. ä½™æš‡ãƒ»å¿ƒç†', 'competition': '7. ç«¶äº‰'
}
SHORT_ELEMENTS = {
    'health': ['ç¡çœ ã¨ä¼‘æ¯', 'èº«ä½“çš„ãªå¿«èª¿ã•'], 'relationships': ['è¦ªå¯†ãªé–¢ä¿‚', 'åˆ©ä»–æ€§ãƒ»è²¢çŒ®'],
    'meaning': ['ä»•äº‹ãƒ»å­¦æ¥­ã®å……å®Ÿæ„Ÿ', 'ä¾¡å€¤ã¨ã®ä¸€è‡´'], 'autonomy': ['è‡ªå·±æ±ºå®šæ„Ÿ', 'è‡ªå·±æˆé•·ã®å®Ÿæ„Ÿ'],
    'finance': ['çµŒæ¸ˆçš„ãªå®‰å¿ƒæ„Ÿ', 'è·æ¥­çš„ãªé”æˆæ„Ÿ'], 'leisure': ['å¿ƒã®å¹³ç©', 'æ¥½ã—ã•ãƒ»å–œã³'],
    'competition': ['å„ªè¶Šæ„Ÿãƒ»å‹åˆ©']
}
LONG_ELEMENTS = {
    'health': ['ç¡çœ ', 'é£Ÿäº‹', 'é‹å‹•', 'èº«ä½“çš„å¿«é©ã•', 'æ„Ÿè¦šçš„å¿«æ¥½', 'æ€§çš„æº€è¶³'],
    'relationships': ['å®¶æ—', 'ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ãƒ»æ‹æ„›', 'å‹äºº', 'ç¤¾ä¼šçš„æ‰¿èª', 'åˆ©ä»–æ€§ãƒ»è²¢çŒ®', 'å…±æ„Ÿãƒ»ç¹‹ãŒã‚Š'],
    'meaning': ['ã‚„ã‚ŠãŒã„', 'é”æˆæ„Ÿ', 'ä¿¡å¿µã¨ã®ä¸€è‡´', 'ã‚­ãƒ£ãƒªã‚¢ã®å±•æœ›', 'ç¤¾ä¼šã¸ã®è²¢çŒ®', 'æœ‰èƒ½æ„Ÿ'],
    'autonomy': ['è‡ªç”±ãƒ»è‡ªå·±æ±ºå®š', 'æŒ‘æˆ¦ãƒ»å†’é™º', 'è‡ªå·±æˆé•·ã®å®Ÿæ„Ÿ', 'å¤‰åŒ–ã®äº«å—', 'ç‹¬ç«‹ãƒ»è‡ªå·±ä¿¡é ¼', 'å¥½å¥‡å¿ƒ'],
    'finance': ['çµŒæ¸ˆçš„å®‰å®š', 'çµŒæ¸ˆçš„ä½™è£•', 'åŠ´åƒç’°å¢ƒ', 'ãƒ¯ãƒ¼ã‚¯ãƒ©ã‚¤ãƒ•ãƒãƒ©ãƒ³ã‚¹', 'å…¬æ­£ãªè©•ä¾¡', 'è·æ¥­çš„å®‰å®šæ€§'],
    'leisure': ['å¿ƒã®å¹³ç©', 'è‡ªå·±è‚¯å®šæ„Ÿ', 'å‰µé€ æ€§ã®ç™ºæ®', 'æ„Ÿè¬', 'å¨¯æ¥½ãƒ»æ¥½ã—ã•', 'èŠ¸è¡“ãƒ»è‡ªç„¶'],
    'competition': ['å„ªè¶Šæ„Ÿãƒ»å‹åˆ©']
}
Q_COLS = ['q_' + d for d in DOMAINS]
S_COLS = ['s_' + d for d in DOMAINS]
CSV_FILE_TEMPLATE = 'harmony_data_{}.csv'
SLIDER_HELP_TEXT = "0: å…¨ãå½“ã¦ã¯ã¾ã‚‰ãªã„\n\n25: ã‚ã¾ã‚Šå½“ã¦ã¯ã¾ã‚‰ãªã„\n\n50: ã©ã¡ã‚‰ã¨ã‚‚è¨€ãˆãªã„\n\n75: ã‚„ã‚„å½“ã¦ã¯ã¾ã‚‹\n\n100: å®Œå…¨ã«å½“ã¦ã¯ã¾ã‚‹"
ELEMENT_DEFINITIONS = {
    # ... (v1.2.2ã®å…¨ã¦ã®ææ–™å®šç¾©)
    'ç¡çœ ã¨ä¼‘æ¯': 'å¿ƒèº«ã¨ã‚‚ã«ã€ååˆ†ãªä¼‘æ¯ãŒå–ã‚ŒãŸã¨æ„Ÿã˜ã‚‹åº¦åˆã„ã€‚ä¾‹ï¼šæœã€ã™ã£ãã‚Šã¨ç›®è¦šã‚ã‚‰ã‚ŒãŸã‹ã€‚', 'èº«ä½“çš„ãªå¿«èª¿ã•': 'æ´»åŠ›ã‚’æ„Ÿã˜ã€èº«ä½“çš„ãªä¸èª¿ï¼ˆç—›ã¿ã€ç–²ã‚Œãªã©ï¼‰ãŒãªã‹ã£ãŸåº¦åˆã„ã€‚',
    'ç¡çœ ': 'è³ªã®è‰¯ã„ç¡çœ ãŒã¨ã‚Œã€æœã€ã™ã£ãã‚Šã¨ç›®è¦šã‚ã‚‰ã‚ŒãŸåº¦åˆã„ã€‚', 'é£Ÿäº‹': 'æ „é¤Šãƒãƒ©ãƒ³ã‚¹ã®å–ã‚ŒãŸã€ç¾å‘³ã—ã„é£Ÿäº‹ã«æº€è¶³ã§ããŸåº¦åˆã„ã€‚',
    'é‹å‹•': 'ä½“ã‚’å‹•ã‹ã™ç¿’æ…£ãŒã‚ã‚Šã€ãã‚ŒãŒå¿ƒèº«ã®å¿«èª¿ã•ã«ç¹‹ãŒã£ã¦ã„ãŸåº¦åˆã„ã€‚', 'èº«ä½“çš„å¿«é©ã•': 'æ…¢æ€§çš„ãªç—›ã¿ã‚„ã€æ°—ã«ãªã‚‹ä¸èª¿ãŒãªãã€å¿«é©ã«éã”ã›ãŸåº¦åˆã„ã€‚',
    'æ„Ÿè¦šçš„å¿«æ¥½': 'äº”æ„Ÿã‚’é€šã˜ã¦ã€å¿ƒåœ°ã‚ˆã„ã¨æ„Ÿã˜ã‚‹ç¬é–“ãŒã‚ã£ãŸåº¦åˆã„ã€‚ä¾‹ï¼šæ¸©ã‹ã„ãŠé¢¨å‘‚ã€å¿ƒåœ°ã‚ˆã„éŸ³æ¥½ã€‚', 'æ€§çš„æº€è¶³': 'è‡ªèº«ã®æ€§çš„ãªæ¬²æ±‚ã‚„ã€ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã¨ã®è¦ªë°€ã•ã«å¯¾ã—ã¦ã€æº€è¶³æ„ŸãŒã‚ã£ãŸåº¦åˆã„ã€‚',
    'è¦ªå¯†ãªé–¢ä¿‚': 'å®¶æ—ã‚„ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã€è¦ªã—ã„å‹äººã¨ã®ã€æ¸©ã‹ã„ã€ã‚ã‚‹ã„ã¯å®‰å¿ƒã§ãã‚‹ç¹‹ãŒã‚Šã‚’æ„Ÿã˜ãŸåº¦åˆã„ã€‚', 'åˆ©ä»–æ€§ãƒ»è²¢çŒ®': 'è‡ªåˆ†ã®è¡Œå‹•ãŒã€èª°ã‹ã®å½¹ã«ç«‹ã£ãŸã€ã‚ã‚‹ã„ã¯å–œã°ã‚ŒãŸã¨æ„Ÿã˜ãŸåº¦åˆã„ã€‚ä¾‹ï¼šã€Œã‚ã‚ŠãŒã¨ã†ã€ã¨è¨€ã‚ã‚ŒãŸã€‚',
    'å®¶æ—': 'å®¶æ—ã¨ã®é–“ã«ã€å®‰å®šã—ãŸã€ã‚ã‚‹ã„ã¯æ¸©ã‹ã„é–¢ä¿‚ãŒã‚ã£ãŸåº¦åˆã„ã€‚', 'ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ãƒ»æ‹æ„›': 'ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã¨ã®é–“ã«ã€æ„›æƒ…ã‚„æ·±ã„ç†è§£ã€ä¿¡é ¼ãŒã‚ã£ãŸåº¦åˆã„ã€‚',
    'å‹äºº': 'æ°—è»½ã«è©±ã›ãŸã‚Šã€æ”¯ãˆåˆãˆãŸã‚Šã™ã‚‹å‹äººãŒãŠã‚Šã€è‰¯ã„é–¢ä¿‚ã‚’ç¯‰ã‘ã¦ã„ãŸåº¦åˆã„ã€‚', 'ç¤¾ä¼šçš„æ‰¿èª': 'å‘¨å›²ã®äººã€…ï¼ˆè·å ´ã€åœ°åŸŸãªã©ï¼‰ã‹ã‚‰ã€ä¸€å“¡ã¨ã—ã¦èªã‚ã‚‰ã‚Œã€å°Šé‡ã•ã‚Œã¦ã„ã‚‹ã¨æ„Ÿã˜ãŸåº¦åˆã„ã€‚',
    'å…±æ„Ÿãƒ»ç¹‹ãŒã‚Š': 'ä»–è€…ã®æ°—æŒã¡ã«å¯„ã‚Šæ·»ã£ãŸã‚Šã€é€†ã«å¯„ã‚Šæ·»ã£ã¦ã‚‚ã‚‰ã£ãŸã‚Šã—ã¦ã€äººã¨ã®æ·±ã„ç¹‹ãŒã‚Šã‚’æ„Ÿã˜ãŸåº¦åˆã„ã€‚', 'ä»•äº‹ãƒ»å­¦æ¥­ã®å……å®Ÿæ„Ÿ': 'è‡ªåˆ†ã®ä»•äº‹ã‚„å­¦ã³ã«ã€ã‚„ã‚ŠãŒã„ã‚„é”æˆæ„Ÿã‚’æ„Ÿã˜ãŸåº¦åˆã„ã€‚',
    'ä¾¡å€¤ã¨ã®ä¸€è‡´': 'è‡ªåˆ†ã®å¤§åˆ‡ã«ã—ã¦ã„ã‚‹ä¾¡å€¤è¦³ã‚„ä¿¡å¿µã«æ²¿ã£ã¦ã€è¡Œå‹•ã§ããŸã¨æ„Ÿã˜ã‚‰ã‚Œã‚‹åº¦åˆã„ã€‚', 'ã‚„ã‚ŠãŒã„': 'è‡ªåˆ†ã®ä»•äº‹ã‚„æ´»å‹•ï¼ˆå­¦æ¥­ã€å®¶äº‹ã€è¶£å‘³ãªã©ï¼‰ã«ã€æ„ç¾©ã‚„ç›®çš„ã‚’æ„Ÿã˜ã€å¤¢ä¸­ã«ãªã‚ŒãŸåº¦åˆã„ã€‚',
    'é”æˆæ„Ÿ': 'ä½•ã‹å…·ä½“çš„ãªç›®æ¨™ã‚’é”æˆã—ãŸã‚Šã€ç‰©äº‹ã‚’æœ€å¾Œã¾ã§ã‚„ã‚Šé‚ã’ãŸã‚Šã™ã‚‹çµŒé¨“ãŒã‚ã£ãŸåº¦åˆã„ã€‚', 'ä¿¡å¿µã¨ã®ä¸€è‡´': 'è‡ªåˆ†ã®ã€Œã“ã†ã‚ã‚ŠãŸã„ã€ã¨ã„ã†ä¾¡å€¤è¦³ã‚„ã€å€«ç†è¦³ã«æ²¿ã£ãŸè¡Œå‹•ãŒã§ããŸåº¦åˆã„ã€‚',
    'ã‚­ãƒ£ãƒªã‚¢ã®å±•æœ›': 'è‡ªåˆ†ã®å°†æ¥ã®ã‚­ãƒ£ãƒªã‚¢ã«å¯¾ã—ã¦ã€å¸Œæœ›ã‚„å‰å‘ããªè¦‹é€šã—ã‚’æŒã¦ã¦ã„ãŸåº¦åˆã„ã€‚', 'ç¤¾ä¼šã¸ã®è²¢çŒ®': 'è‡ªåˆ†ã®æ´»å‹•ãŒã€æ‰€å±ã™ã‚‹ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã‚„ã€ã‚ˆã‚Šå¤§ããªç¤¾ä¼šã«å¯¾ã—ã¦ã€è‰¯ã„å½±éŸ¿ã‚’ä¸ãˆã¦ã„ã‚‹ã¨æ„Ÿã˜ã‚‰ã‚ŒãŸåº¦åˆã„ã€‚',
    'æœ‰èƒ½æ„Ÿ': 'è‡ªåˆ†ã®ã‚¹ã‚­ãƒ«ã‚„èƒ½åŠ›ã‚’ã€ã†ã¾ãç™ºæ®ã§ãã¦ã„ã‚‹ã¨ã„ã†æ„Ÿè¦šãŒã‚ã£ãŸåº¦åˆã„ã€‚', 'è‡ªå·±æ±ºå®šæ„Ÿ': 'ä»Šæ—¥ã®è‡ªåˆ†ã®è¡Œå‹•ã¯ã€è‡ªåˆ†ã§æ±ºã‚ãŸã¨æ„Ÿã˜ã‚‰ã‚Œã‚‹åº¦åˆã„ã€‚',
    'è‡ªå·±æˆé•·ã®å®Ÿæ„Ÿ': 'ä½•ã‹ã‚’ä¹—ã‚Šè¶Šãˆã€è‡ªåˆ†ãŒæˆé•·ã—ãŸã€ã‚ã‚‹ã„ã¯æ–°ã—ã„ã“ã¨ã‚’å­¦ã‚“ã ã¨æ„Ÿã˜ãŸåº¦åˆã„ã€‚', 'è‡ªç”±ãƒ»è‡ªå·±æ±ºå®š': 'è‡ªåˆ†ã®äººç”Ÿã«ãŠã‘ã‚‹é‡è¦ãªäº‹æŸ„ã‚’ã€ä»–è€…ã®åœ§åŠ›ã§ã¯ãªãã€è‡ªåˆ†è‡ªèº«ã®æ„å¿—ã§é¸æŠãƒ»æ±ºå®šã§ãã¦ã„ã‚‹ã¨æ„Ÿã˜ãŸåº¦åˆã„ã€‚',
    'æŒ‘æˆ¦ãƒ»å†’é™º': 'æ–°ã—ã„ã“ã¨ã«æŒ‘æˆ¦ã—ãŸã‚Šã€æœªçŸ¥ã®çµŒé¨“ã‚’ã—ãŸã‚Šã—ã¦ã€åˆºæ¿€ã‚„èˆˆå¥®ã‚’æ„Ÿã˜ãŸåº¦åˆã„ã€‚', 'å¤‰åŒ–ã®äº«å—': 'ç’°å¢ƒã®å¤‰åŒ–ã‚„ã€æ–°ã—ã„è€ƒãˆæ–¹ã‚’ã€ãƒã‚¸ãƒ†ã‚£ãƒ–ã«å—ã‘å…¥ã‚Œã€æ¥½ã—ã‚€ã“ã¨ãŒã§ããŸåº¦åˆã„ã€‚',
    'ç‹¬ç«‹ãƒ»è‡ªå·±ä¿¡é ¼': 'è‡ªåˆ†ã®åŠ›ã§ç‰©äº‹ã«å¯¾å‡¦ã§ãã‚‹ã¨ã„ã†ã€è‡ªåˆ†è‡ªèº«ã¸ã®ä¿¡é ¼æ„ŸãŒã‚ã£ãŸåº¦åˆã„ã€‚', 'å¥½å¥‡å¿ƒ': 'æ§˜ã€…ãªç‰©äº‹ã«å¯¾ã—ã¦ã€çŸ¥çš„ãªå¥½å¥‡å¿ƒã‚’æŒã¡ã€æ¢æ±‚ã™ã‚‹ã“ã¨ã«å–œã³ã‚’æ„Ÿã˜ãŸåº¦åˆã„ã€‚',
    'çµŒæ¸ˆçš„ãªå®‰å¿ƒæ„Ÿ': 'æ—¥ã€…ã®ç”Ÿæ´»ã‚„å°†æ¥ã®ãŠé‡‘ã«ã¤ã„ã¦ã€éåº¦ãªå¿ƒé…ã‚’ã›ãšã€å®‰å¿ƒã—ã¦éã”ã›ãŸåº¦åˆã„ã€‚', 'è·æ¥­çš„ãªé”æˆæ„Ÿ': 'ä»•äº‹ã‚„å­¦æ¥­ã«ãŠã„ã¦ã€ç‰©äº‹ã‚’ã†ã¾ãã‚„ã‚Šé‚ã’ãŸã€ã‚ã‚‹ã„ã¯ç›®æ¨™ã«è¿‘ã¥ã„ãŸã¨æ„Ÿã˜ãŸåº¦åˆã„ã€‚',
    'çµŒæ¸ˆçš„å®‰å®š': 'ã€Œæ¥æœˆã®æ”¯æ‰•ã„ã¯å¤§ä¸ˆå¤«ã‹ãªâ€¦ã€ã¨ã„ã£ãŸã€çŸ­æœŸçš„ãªãŠé‡‘ã®å¿ƒé…ãŒãªã„çŠ¶æ…‹ã€‚', 'çµŒæ¸ˆçš„ä½™è£•': 'ç”Ÿæ´»å¿…éœ€å“ã ã‘ã§ãªãã€è¶£å‘³ã‚„è‡ªå·±æŠ•è³‡ãªã©ã€äººç”Ÿã‚’è±Šã‹ã«ã™ã‚‹ã“ã¨ã«ã‚‚ãŠé‡‘ã‚’ä½¿ãˆã‚‹çŠ¶æ…‹ã€‚',
    'åŠ´åƒç’°å¢ƒ': 'ç‰©ç†çš„ã«ã‚‚ã€ç²¾ç¥çš„ã«ã‚‚ã€å®‰å…¨ã§ã€å¥åº·çš„ã«åƒã‘ã‚‹ç’°å¢ƒãŒã‚ã£ãŸåº¦åˆã„ã€‚', 'ãƒ¯ãƒ¼ã‚¯ãƒ©ã‚¤ãƒ•ãƒãƒ©ãƒ³ã‚¹': 'ä»•äº‹ï¼ˆã‚ã‚‹ã„ã¯å­¦æ¥­ï¼‰ã¨ã€ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãªç”Ÿæ´»ã¨ã®é–“ã§ã€è‡ªåˆ†ãŒæœ›ã‚€ãƒãƒ©ãƒ³ã‚¹ãŒå–ã‚Œã¦ã„ãŸåº¦åˆã„ã€‚',
    'å…¬æ­£ãªè©•ä¾¡': 'è‡ªåˆ†ã®åƒãã‚„æˆæœãŒã€æ­£å½“ã«è©•ä¾¡ã•ã‚Œã€å ±é…¬ã«åæ˜ ã•ã‚Œã¦ã„ã‚‹ã¨æ„Ÿã˜ã‚‰ã‚ŒãŸåº¦åˆã„ã€‚', 'è·æ¥­çš„å®‰å®šæ€§': 'ã€Œã“ã®å…ˆã‚‚ã€ã“ã®ä»•äº‹ã‚’ç¶šã‘ã¦ã„ã‘ã‚‹ã ã‚ã†ã‹ã€ã¨ã„ã£ãŸã€é•·æœŸçš„ãªã‚­ãƒ£ãƒªã‚¢ã‚„åå…¥ã«å¯¾ã™ã‚‹ä¸å®‰ãŒãªã„çŠ¶æ…‹ã€‚',
    'å¿ƒã®å¹³ç©': 'éåº¦ãªä¸å®‰ã‚„ã‚¹ãƒˆãƒ¬ã‚¹ãªãã€ç²¾ç¥çš„ã«å®‰å®šã—ã¦ã„ãŸåº¦åˆã„ã€‚', 'æ¥½ã—ã•ãƒ»å–œã³': 'ç´”ç²‹ã«ã€Œæ¥½ã—ã„ã€ã¨æ„Ÿã˜ãŸã‚Šã€ç¬‘ã£ãŸã‚Šã™ã‚‹ç¬é–“ãŒã‚ã£ãŸåº¦åˆã„ã€‚',
    'è‡ªå·±è‚¯å®šæ„Ÿ': 'è‡ªåˆ†ã®é•·æ‰€ã‚‚çŸ­æ‰€ã‚‚å«ã‚ã¦ã€ã‚ã‚Šã®ã¾ã¾ã®è‡ªåˆ†ã‚’ã€è‚¯å®šçš„ã«å—ã‘å…¥ã‚Œã‚‹ã“ã¨ãŒã§ããŸåº¦åˆã„ã€‚', 'å‰µé€ æ€§ã®ç™ºæ®': 'ä½•ã‹ã‚’å‰µä½œã—ãŸã‚Šã€æ–°ã—ã„ã‚¢ã‚¤ãƒ‡ã‚¢ã‚’æ€ã„ã¤ã„ãŸã‚Šã—ã¦ã€å‰µé€ çš„ãªå–œã³ã‚’æ„Ÿã˜ãŸåº¦åˆã„ã€‚',
    'æ„Ÿè¬': 'æ—¥å¸¸ã®å°ã•ãªå‡ºæ¥äº‹ã‚„ã€å‘¨ã‚Šã®äººã€…ã«å¯¾ã—ã¦ã€è‡ªç„¶ã¨ã€Œã‚ã‚ŠãŒãŸã„ã€ã¨ã„ã†æ°—æŒã¡ãŒæ¹§ã„ãŸåº¦åˆã„ã€‚', 'å¨¯æ¥½ãƒ»æ¥½ã—ã•': 'è¶£å‘³ã«æ²¡é ­ã—ãŸã‚Šã€å‹äººã¨ç¬‘ã„åˆã£ãŸã‚Šã€ç´”ç²‹ã«ã€Œæ¥½ã—ã„ã€ã¨æ„Ÿã˜ã‚‹æ™‚é–“ãŒã‚ã£ãŸåº¦åˆã„ã€‚',
    'èŠ¸è¡“ãƒ»è‡ªç„¶': 'ç¾ã—ã„éŸ³æ¥½ã‚„èŠ¸è¡“ã€ã‚ã‚‹ã„ã¯é›„å¤§ãªè‡ªç„¶ã«è§¦ã‚Œã¦ã€å¿ƒãŒå‹•ã‹ã•ã‚ŒãŸã‚Šã€è±Šã‹ã«ãªã£ãŸã‚Šã™ã‚‹çµŒé¨“ãŒã‚ã£ãŸåº¦åˆã„ã€‚', 'å„ªè¶Šæ„Ÿãƒ»å‹åˆ©': 'ä»–è€…ã¨ã®æ¯”è¼ƒã‚„ã€ã‚¹ãƒãƒ¼ãƒ„ã€ä»•äº‹ã€å­¦æ¥­ãªã©ã«ãŠã‘ã‚‹ç«¶äº‰ã«ãŠã„ã¦ã€å„ªä½ã«ç«‹ã¦ãŸã¨æ„Ÿã˜ãŸåº¦åˆã„ã€‚'
}
EXPANDER_TEXTS = {
    # ... (v1.2.2ã®å…¨ã¦ã®è§£èª¬æ–‡)
    'q_t': """
        ã“ã“ã§ã¯ã€ã‚ãªãŸãŒäººç”Ÿã§**ä½•ã‚’å¤§åˆ‡ã«ã—ãŸã„ã‹ï¼ˆç†æƒ³ï¼æƒ…å ±ç§©åºï¼‰**ã‚’æ•°å€¤ã§è¡¨ç¾ã—ã¾ã™ã€‚
        
        **ã©ã†å…¥åŠ›ã™ã‚‹ï¼Ÿ**
        åˆè¨ˆ100ç‚¹ã¨ãªã‚‹ã‚ˆã†ã€7ã¤ã®ãƒ†ãƒ¼ãƒï¼ˆãƒ‰ãƒ¡ã‚¤ãƒ³ï¼‰ã«ã€ã‚ãªãŸã«ã¨ã£ã¦ã®é‡è¦åº¦ã‚’ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã§é…åˆ†ã—ã¦ãã ã•ã„ã€‚æ­£è§£ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ã‚ãªãŸã®ç›´æ„ŸãŒã€ä»Šã®ã‚ãªãŸã«ã¨ã£ã¦ã®ç­”ãˆã§ã™ã€‚
        
        **ãªãœå…¥åŠ›ã™ã‚‹ï¼Ÿ**
        ã“ã®è¨­å®šãŒã€ã‚ãªãŸã®æ—¥ã€…ã®çµŒé¨“ã‚’è©•ä¾¡ã™ã‚‹ãŸã‚ã®**å€‹äººçš„ãªã€ã‚‚ã®ã•ã—ã€**ã¨ãªã‚Šã¾ã™ã€‚ã“ã®ã€Œã‚‚ã®ã•ã—ã€ãŒãªã‘ã‚Œã°ã€è‡ªåˆ†ã®èˆªæµ·ãŒé †èª¿ãªã®ã‹ã€èˆªè·¯ã‹ã‚‰å¤–ã‚Œã¦ã„ã‚‹ã®ã‹ã‚’çŸ¥ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚
        
        ï¼ˆé€±ã«ä¸€åº¦ãªã©ã€å®šæœŸçš„ã«è¦‹ç›´ã™ã®ãŒãŠã™ã™ã‚ã§ã™ï¼‰
        """,
    's_t': """
        ã“ã“ã§ã¯ã€ã‚ãªãŸã®**ç¾å®Ÿã®çµŒé¨“ï¼ˆå®Ÿè·µç§©åºï¼‰**ã‚’è¨˜éŒ²ã—ã¾ã™ã€‚
        
        **ã©ã†å…¥åŠ›ã™ã‚‹ï¼Ÿ**
        é ­ã§è€ƒãˆã‚‹ç†æƒ³ã§ã¯ãªãã€**ä»Šæ—¥ä¸€æ—¥ã‚’æŒ¯ã‚Šè¿”ã£ã¦ã€å®Ÿéš›ã«ã©ã†æ„Ÿã˜ãŸã‹**ã‚’ã€å„é …ç›®ã®ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã§ç›´æ„Ÿçš„ã«è©•ä¾¡ã—ã¦ãã ã•ã„ã€‚
        
        **ãªãœå…¥åŠ›ã™ã‚‹ï¼Ÿ**
        ã“ã®ã€Œç¾å®Ÿã€ã®è¨˜éŒ²ã¨ã€å…ˆã»ã©è¨­å®šã—ãŸã€Œç†æƒ³ã€ã®ç¾…é‡ç›¤ã¨ã‚’æ¯”ã¹ã‚‹ã“ã¨ã§ã€ä¸¡è€…ã®é–“ã«å­˜åœ¨ã™ã‚‹**ã€ã‚ºãƒ¬ã€**ã‚’åˆã‚ã¦ç™ºè¦‹ã§ãã¾ã™ã€‚ã“ã®ã€ã‚ºãƒ¬ã€ã«æ°—ã¥ãã“ã¨ã“ããŒã€è‡ªå·±ç†è§£ã¨æˆé•·ã®ç¬¬ä¸€æ­©ã§ã™ã€‚
        """,
    'g_t': """
        ã“ã®é …ç›®ã¯ã€**ã‚ãªãŸã®ç›´æ„Ÿçš„ãªå…¨ä½“è©•ä¾¡**ã§ã™ã€‚
        
        **ã©ã†å…¥åŠ›ã™ã‚‹ï¼Ÿ**
        ç´°ã‹ã„ã“ã¨ã¯ä¸€åº¦å¿˜ã‚Œã¦ã€ã€Œã§ã€è‰²ã€…ã‚ã£ãŸã‘ã©ã€ä»Šæ—¥ã®è‡ªåˆ†ã€å…¨ä½“ã¨ã—ã¦ã¯ä½•ç‚¹ã ã£ãŸã‹ãªï¼Ÿã€ã¨ã„ã†æ„Ÿè¦šã‚’ã€ä¸€ã¤ã®ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã§è¡¨ç¾ã—ã¦ãã ã•ã„ã€‚
        
        **ãªãœå…¥åŠ›ã™ã‚‹ï¼Ÿ**
        ã‚¢ãƒ—ãƒªãŒè¨ˆç®—ã—ãŸã‚¹ã‚³ã‚¢ï¼ˆHï¼‰ã¨ã€ã‚ãªãŸã®ç›´æ„Ÿï¼ˆGï¼‰ãŒã©ã‚Œã ã‘ä¸€è‡´ã—ã¦ã„ã‚‹ã‹ã€ã‚ã‚‹ã„ã¯**ã‚ºãƒ¬ã¦ã„ã‚‹ã‹**ã‚’çŸ¥ã‚‹ãŸã‚ã®ã€éå¸¸ã«é‡è¦ãªæ‰‹ãŒã‹ã‚Šã¨ãªã‚Šã¾ã™ã€‚
        
        **ã€è¨ˆç®—ä¸Šã¯è‰¯ã„ã¯ãšãªã®ã«ã€ãªãœã‹æ°—åˆ†ãŒæ™´ã‚Œãªã„ã€**ã¨ã„ã£ãŸã€è¨€è‘‰ã«ãªã‚‰ãªã„é•å’Œæ„Ÿã‚„ã€**ã€äºˆæƒ³å¤–ã«æ¥½ã—ã‹ã£ãŸï¼ã€**ã¨ã„ã†å¬‰ã—ã„ç™ºè¦‹ãªã©ã€è²´é‡ãªè‡ªå·±ç™ºè¦‹ã®ãã£ã‹ã‘ã«ãªã‚Šã¾ã™ã€‚
        """,
    'event_log': """
        ã“ã‚Œã¯ã€ã‚ãªãŸã®èˆªæµ·ã®**ç‰©èª**ã‚’è¨˜éŒ²ã™ã‚‹å ´æ‰€ã§ã™ã€‚
        
        **ã©ã†å…¥åŠ›ã™ã‚‹ã®ãŒãŠã™ã™ã‚ï¼Ÿ**
        **ã€èª°ã¨ä¼šã£ãŸã€ã€ä½•ã‚’ã—ãŸã€ã€ä½•ã‚’æ„Ÿã˜ãŸã€**ã¨ã„ã£ãŸå…·ä½“çš„ãªå‡ºæ¥äº‹ã‚„æ„Ÿæƒ…ã‚’ã€ä¸€è¨€ã§ã‚‚è‰¯ã„ã®ã§æ›¸ãç•™ã‚ã¦ã¿ã¾ã—ã‚‡ã†ã€‚
        
        **ãªãœæ›¸ãã®ãŒãŠã™ã™ã‚ï¼Ÿ**
        å¾Œã§ã‚°ãƒ©ãƒ•ã‚’è¦‹ãŸã¨ãã«ã€æ•°å€¤ã ã‘ã§ã¯åˆ†ã‹ã‚‰ãªã„ã€**å¹¸ç¦åº¦ã®æµ®ãæ²ˆã¿ã®ã€ãªãœï¼Ÿã€**ã‚’è§£ãæ˜ã‹ã™éµã¨ãªã‚Šã¾ã™ã€‚ã‚°ãƒ©ãƒ•ã®ã€Œå±±ã€ã‚„ã€Œè°·ã€ã¨ã€ã“ã®è¨˜éŒ²ã‚’çµã³ã¤ã‘ã‚‹ã“ã¨ã§ã€ã‚ãªãŸã®å¹¸ç¦ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒã‚ˆã‚Šé®®æ˜ã«è¦‹ãˆã¦ãã¾ã™ã€‚
        """,
    'dashboard': """
        ã“ã“ã§ã¯ã€è¨˜éŒ²ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ã€ã‚ãªãŸã®å¹¸ç¦ã®**ãƒ‘ã‚¿ãƒ¼ãƒ³ã¨æ§‹é€ **ã‚’å¯è¦–åŒ–ã—ã¾ã™ã€‚
        - **ğŸ’¡ ã‚¤ãƒ³ã‚µã‚¤ãƒˆãƒ»ã‚¨ãƒ³ã‚¸ãƒ³:** ãƒ¢ãƒ‡ãƒ«ã®è¨ˆç®—å€¤(H)ã¨ã‚ãªãŸã®å®Ÿæ„Ÿ(G)ã®ã‚ºãƒ¬ã‹ã‚‰ã€è‡ªå·±ç™ºè¦‹ã®ãƒ’ãƒ³ãƒˆã‚’æç¤ºã—ã¾ã™ã€‚
        - **ğŸ“ˆ æœŸé–“åˆ†æã¨ãƒªã‚¹ã‚¯è©•ä¾¡ (RHI):** ã‚ãªãŸã®å¹¸ç¦ã®**å¹³å‡ç‚¹**ã ã‘ã§ãªãã€ãã®**å®‰å®šæ€§ã‚„æŒç¶šå¯èƒ½æ€§ï¼ˆãƒªã‚¹ã‚¯ï¼‰**ã‚’è©•ä¾¡ã—ã¾ã™ã€‚
        - **ğŸ“Š èª¿å’Œåº¦ã®æ¨ç§»:** ã‚ãªãŸã®å¹¸ç¦åº¦ã®æ™‚é–“çš„ãª**ã€ç‰©èªã€**ã§ã™ã€‚ã‚°ãƒ©ãƒ•ã®å±±ã‚„è°·ãŒã€ã„ã¤ã€ãªãœèµ·ããŸã®ã‹ã‚’æ¢ã£ã¦ã¿ã¾ã—ã‚‡ã†ã€‚
        - **ğŸ“‹ å…¨è¨˜éŒ²ãƒ‡ãƒ¼ã‚¿:** ã‚ãªãŸã®èˆªæµ·ã®**ã€è©³ç´°ãªèˆªæµ·æ—¥èªŒã€**ã§ã™ã€‚
        """
}

# --- 1. è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ ---
def calculate_metrics(df: pd.DataFrame, alpha: float = 0.6) -> pd.DataFrame:
    df_copy = df.copy()
    if df_copy.empty: return df_copy
    
    # ... (v1.2.2ã®ã‚³ãƒ¼ãƒ‰)
    for col in Q_COLS + S_COLS:
        if col in df_copy.columns:
            df_copy[col] = pd.to_numeric(df_copy[col], errors='coerce').fillna(0)
    
    s_vectors_normalized = df_copy[S_COLS].values / 100.0
    q_vectors = df_copy[Q_COLS].values
    df_copy['S'] = np.sum(q_vectors * s_vectors_normalized, axis=1)
    
    def calculate_unity(row):
        q_vec = row[Q_COLS].values
        s_vec_raw = row[S_COLS].values
        s_sum = np.sum(s_vec_raw)
        if s_sum == 0: return 0.0
        s_tilde = s_vec_raw / s_sum
        jsd_sqrt = jensenshannon(q_vec, s_tilde)
        jsd = jsd_sqrt**2
        return 1 - jsd
    
    df_copy['U'] = df_copy.apply(calculate_unity, axis=1)
    df_copy['H'] = alpha * df_copy['S'] + (1 - alpha) * df_copy['U']
    return df_copy

# (ä»¥é™ã®é–¢æ•°ã¯ã€v1.2.2ã‹ã‚‰å¤‰æ›´ãªã—)
# ...
def analyze_discrepancy(df_processed: pd.DataFrame, threshold: int = 20):
    if df_processed.empty: return
    latest_record = df_processed.iloc[-1]
    latest_h_normalized = latest_record['H']
    latest_g = latest_record['g_happiness']
    latest_h = latest_h_normalized * 100
    gap = latest_g - latest_h
    st.subheader("ğŸ’¡ ã‚¤ãƒ³ã‚µã‚¤ãƒˆãƒ»ã‚¨ãƒ³ã‚¸ãƒ³")
    with st.expander("â–¼ ã“ã‚Œã¯ã€ãƒ¢ãƒ‡ãƒ«ã®è¨ˆç®—å€¤(H)ã¨ã‚ãªãŸã®å®Ÿæ„Ÿ(G)ã®ã€ã‚ºãƒ¬ã€ã«é–¢ã™ã‚‹åˆ†æã§ã™", expanded=True):
        if gap > threshold:
            st.info(f"""
                **ã€å¹¸ç¦ãªã‚µãƒ—ãƒ©ã‚¤ã‚ºï¼ğŸ‰ã€‘**

                ã‚ãªãŸã®**å®Ÿæ„Ÿï¼ˆG = {int(latest_g)}ç‚¹ï¼‰**ã¯ã€ãƒ¢ãƒ‡ãƒ«ã®è¨ˆç®—å€¤ï¼ˆH = {int(latest_h)}ç‚¹ï¼‰ã‚’å¤§ããä¸Šå›ã‚Šã¾ã—ãŸã€‚
                
                ã“ã‚Œã¯ã€ã‚ãªãŸãŒ**ã¾ã è¨€è‘‰ã«ã§ãã¦ã„ãªã„ã€æ–°ã—ã„ä¾¡å€¤è¦³**ã‚’ç™ºè¦‹ã—ãŸã‚µã‚¤ãƒ³ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚
                
                **å•ã„ï¼š** ä»Šæ—¥ã®è¨˜éŒ²ã‚’æŒ¯ã‚Šè¿”ã‚Šã€ã‚ãªãŸãŒè¨­å®šã—ãŸä¾¡å€¤è¦³ï¼ˆq_tï¼‰ã§ã¯æ‰ãˆãã‚Œã¦ã„ãªã„ã€äºˆæœŸã›ã¬å–œã³ã®æºæ³‰ã¯ä½•ã ã£ãŸã§ã—ã‚‡ã†ã‹ï¼Ÿ
                """)
        elif gap < -threshold:
            st.warning(f"""
                **ã€éš ã‚ŒãŸä¸æº€ï¼ŸğŸ¤”ã€‘**

                ã‚ãªãŸã®**å®Ÿæ„Ÿï¼ˆG = {int(latest_g)}ç‚¹ï¼‰**ã¯ã€ãƒ¢ãƒ‡ãƒ«ã®è¨ˆç®—å€¤ï¼ˆH = {int(latest_h)}ç‚¹ï¼‰ã‚’å¤§ããä¸‹å›ã‚Šã¾ã—ãŸã€‚

                ä¾¡å€¤è¦³ã«æ²¿ã£ãŸç”Ÿæ´»ã®ã¯ãšãªã®ã«ã€ä½•ã‹ãŒæº€ãŸã•ã‚Œã¦ã„ãªã„ã‚ˆã†ã§ã™ã€‚è¦‹éã”ã—ã¦ã„ã‚‹**ã‚¹ãƒˆãƒ¬ã‚¹è¦å› ã‚„ã€ç†æƒ³ã¨ç¾å®Ÿã®å°ã•ãªã‚ºãƒ¬**ãŒã‚ã‚‹ã®ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

                **å•ã„ï¼š** ä»Šæ—¥ã®è¨˜éŒ²ã‚’æŒ¯ã‚Šè¿”ã‚Šã€ã‚ãªãŸã®å¹¸ç¦æ„Ÿã‚’é™ã‹ã«è•ã‚“ã§ã„ãŸã€Œè¦‹ãˆãªã„é‡ã‚Šã€ã¯ä½•ã ã£ãŸã§ã—ã‚‡ã†ã‹ï¼Ÿ
                """)
        else:
            st.success(f"""
                **ã€é †èª¿ãªèˆªæµ·ã§ã™ï¼âœ¨ã€‘**

                ã‚ãªãŸã®**å®Ÿæ„Ÿï¼ˆG = {int(latest_g)}ç‚¹ï¼‰**ã¨ã€ãƒ¢ãƒ‡ãƒ«ã®è¨ˆç®—å€¤ï¼ˆH = {int(latest_h)}ç‚¹ï¼‰ã¯ã€ã‚ˆãä¸€è‡´ã—ã¦ã„ã¾ã™ã€‚
                
                ã‚ãªãŸã®è‡ªå·±èªè­˜ã¨ã€ç¾å®Ÿã®çµŒé¨“ãŒã€ã†ã¾ãèª¿å’Œã—ã¦ã„ã‚‹çŠ¶æ…‹ã§ã™ã€‚ç´ æ™´ã‚‰ã—ã„ï¼
                """)

def calculate_rhi_metrics(df_period: pd.DataFrame, lambda_rhi: float, gamma_rhi: float, tau_rhi: float) -> dict:
    if df_period.empty: return {}
    mean_H = df_period['H'].mean()
    std_H = df_period['H'].std(ddof=0)
    frac_below = (df_period['H'] < tau_rhi).mean()
    rhi = mean_H - (lambda_rhi * std_H) - (gamma_rhi * frac_below)
    return {'mean_H': mean_H, 'std_H': std_H, 'frac_below': frac_below, 'RHI': rhi}

def safe_filename(name): return re.sub(r'[^a-zA-Z0-9_-]', '_', name)
def get_existing_users():
    files = glob.glob("harmony_data_*.csv")
    users = [f.replace("harmony_data_", "").replace(".csv", "") for f in files]
    return users

def show_welcome_and_guide():
    st.header("ã‚ˆã†ã“ãã€æœ€åˆã®èˆªæµ·å£«ã¸ï¼ã€ŒHarmony Navigatorã€å–æ‰±èª¬æ˜æ›¸")
    st.markdown("---")
    st.subheader("1. ã“ã®ã‚¢ãƒ—ãƒªã¯ã€ã‚ãªãŸã®äººç”Ÿã®ã€Œèˆªæµ·æ—¥èªŒã€ã§ã™")
    st.markdown("""
    ã€Œã‚‚ã£ã¨å¹¸ã›ã«ãªã‚ŠãŸã„ã€ã¨é¡˜ã„ãªãŒã‚‰ã‚‚ã€æ¼ ç„¶ã¨ã—ãŸä¸å®‰ã‚„ã€**ã€Œç†æƒ³ï¼ˆã“ã†ã‚ã‚ŠãŸã„è‡ªåˆ†ï¼‰ã€**ã¨**ã€Œç¾å®Ÿï¼ˆå®Ÿéš›ã«çµŒé¨“ã—ãŸä¸€æ—¥ï¼‰ã€**ã®é–“ã®ã€è¨€è‘‰ã«ãªã‚‰ãªã„ã€ã‚ºãƒ¬ã€ã«ã€ç§ãŸã¡ã¯ã—ã°ã—ã°æ‚©ã¾ã•ã‚Œã¾ã™ã€‚
    
    ã“ã®ã‚¢ãƒ—ãƒªã¯ã€ãã®ã€ã‚ºãƒ¬ã€ã®æ­£ä½“ã‚’å¯è¦–åŒ–ã—ã€ã‚ãªãŸè‡ªèº«ãŒäººç”Ÿã®èˆµã‚’å–ã‚‹ãŸã‚ã®ã€**å®Ÿè·µçš„ãªã€Œèˆªæµ·è¡“ã€**ã‚’æä¾›ã™ã‚‹ç›®çš„ã§é–‹ç™ºã•ã‚Œã¾ã—ãŸã€‚
    
    ã“ã‚Œã¯ã€ã‚ãªãŸã ã‘ã®**ã€Œæµ·å›³ï¼ˆãƒãƒ£ãƒ¼ãƒˆï¼‰ã€**ã§ã™ã€‚ã“ã®æµ·å›³ã‚’ä½¿ãˆã°ã€
    - **è‡ªåˆ†ã®ç¾åœ¨åœ°**ï¼ˆä»Šã®å¿ƒã®çŠ¶æ…‹ã€ã¤ã¾ã‚Šã€å®Ÿè·µç§©åºã€ï¼‰ã‚’å®¢è¦³çš„ã«çŸ¥ã‚Šã€
    - **ç›®çš„åœ°**ï¼ˆè‡ªåˆ†ãŒæœ¬å½“ã«å¤§åˆ‡ã«ã—ãŸã„ã“ã¨ã€ã¤ã¾ã‚Šã€æƒ…å ±ç§©åºã€ï¼‰ã‚’æ˜ç¢ºã«ã—ã€
    - **èˆªè·¯**ï¼ˆæ—¥ã€…ã®é¸æŠï¼‰ã‚’ã€ã‚ãªãŸè‡ªèº«ã§è³¢æ˜ã«èª¿æ•´ã—ã¦ã„ãã“ã¨ãŒã§ãã¾ã™ã€‚
    
    ã‚ãªãŸã®äººç”Ÿã¨ã„ã†ã€å”¯ä¸€ç„¡äºŒã®èˆªæµ·ã€‚ãã®å†’é™ºã®ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã¨ã—ã¦ã€ã“ã®ã‚¢ãƒ—ãƒªã¯ç”Ÿã¾ã‚Œã¾ã—ãŸã€‚
    """)
    st.markdown("---")
    st.subheader("2. æœ€åˆã®èˆªæµ·ã®é€²ã‚æ–¹ï¼ˆã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆï¼‰")
    st.markdown("""
    1.  **ä¹—èˆ¹æ‰‹ç¶šãï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ² / ãƒ­ã‚°ã‚¤ãƒ³ï¼‰:**
        - ã‚µã‚¤ãƒ‰ãƒãƒ¼ã§ã€ã‚ãªãŸã®**ã€Œèˆ¹é•·åï¼ˆãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ï¼‰ã€**ã‚’æ±ºã‚ã€ä¹—èˆ¹ã—ã¦ãã ã•ã„ã€‚äºŒå›ç›®ä»¥é™ã¯ã€Œãƒ­ã‚°ã‚¤ãƒ³ã€ã‹ã‚‰ã€ã‚ãªãŸã®èˆ¹ã‚’é¸ã³ã¾ã™ã€‚
    2.  **ç¾…é‡ç›¤ã®ã‚»ãƒƒãƒˆï¼ˆä¾¡å€¤è¦³ `q_t` ã®è¨­å®šï¼‰:**
        - ã‚µã‚¤ãƒ‰ãƒãƒ¼ã§ã€ã‚ãªãŸãŒäººç”Ÿã§**ã€Œä½•ã‚’å¤§åˆ‡ã«ã—ãŸã„ã‹ã€**ã‚’ã€åˆè¨ˆ100ç‚¹ã«ãªã‚‹ã‚ˆã†é…åˆ†ã—ã¾ã™ã€‚ã“ã‚ŒãŒã‚ãªãŸã®èˆªæµ·ã®**ç›®çš„åœ°**ã‚’ç¤ºã™ã€æœ€ã‚‚é‡è¦ãªç¾…é‡ç›¤ã§ã™ã€‚
    3.  **èˆªæµ·æ—¥èªŒã®è¨˜éŒ²ï¼ˆå……è¶³åº¦ `s_t` ã®è¨˜éŒ²ï¼‰:**
        - ãƒ¡ã‚¤ãƒ³ç”»é¢ã§ã€ä»Šæ—¥ä¸€æ—¥ã‚’æŒ¯ã‚Šè¿”ã‚Šã€**ã€Œå®Ÿéš›ã«ã©ã†æ„Ÿã˜ãŸã‹ã€**ã‚’è¨˜éŒ²ã—ã¾ã™ã€‚æ—¥ã€…ã®**ç¾åœ¨åœ°**ã‚’ç¢ºèªã™ã‚‹ä½œæ¥­ã§ã™ã€‚
    4.  **æµ·å›³ã®åˆ†æï¼ˆãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ï¼‰:**
        - è¨˜éŒ²ã‚’ç¶šã‘ã‚‹ã¨ã€ã‚ãªãŸã®å¹¸ç¦åº¦ã®**ç‰©èªï¼ˆã‚°ãƒ©ãƒ•ï¼‰**ãŒè¦‹ãˆã¦ãã¾ã™ã€‚ç¾…é‡ç›¤ï¼ˆç†æƒ³ï¼‰ã¨ã€æ—¥ã€…ã®èˆªè·¯ï¼ˆç¾å®Ÿï¼‰ã®**ã‚ºãƒ¬**ã‹ã‚‰ã€æ¬¡ã®ä¸€æ‰‹ã‚’è¦‹ã¤ã‘å‡ºã—ã¾ã—ã‚‡ã†ã€‚
    """)
    st.markdown("---")
    st.subheader("ğŸ›¡ï¸ã€æœ€é‡è¦ã€‘ã‚ãªãŸã®ãƒ‡ãƒ¼ã‚¿ã¨ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ã¯ã€çµ¶å¯¾çš„ã«ä¿è­·ã•ã‚Œã¾ã™")
    with st.expander("â–¼ è§£èª¬ï¼šã‚¯ãƒ©ã‚¦ãƒ‰ä¸Šã®ã€Œé­”æ³•ã®ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ã€ã®ã€å°‘ã—è©³ã—ã„ãŠè©±"):
        st.markdown("""
        ã€Œç§ã®å€‹äººçš„ãªè¨˜éŒ²ãŒã€é–‹ç™ºè€…ã«è¦‹ã‚‰ã‚Œã¦ã—ã¾ã†ã®ã§ã¯ï¼Ÿã€ã¨ã„ã†ä¸å®‰ã¯ã€å½“ç„¶ã®ã‚‚ã®ã§ã™ã€‚ãã®ä¸å®‰ã‚’å®Œå…¨ã«å–ã‚Šé™¤ããŸã‚ã«ã€ã“ã®ã‚¢ãƒ—ãƒªãŒã©ã†ã„ã†ä»•çµ„ã¿ã§å‹•ã„ã¦ã„ã‚‹ã®ã‹ã€å°‘ã—è©³ã—ããŠè©±ã—ã•ã›ã¦ãã ã•ã„ã€‚
        
        ã“ã®ã‚¢ãƒ—ãƒªã‚’ã€**ã€Œé­”æ³•ã®ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ã€**ã«ä¾‹ãˆã¦ã¿ã¾ã—ã‚‡ã†ã€‚
        
        - **ã‚ãªãŸï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼‰ã¯ã€ŒãŠå®¢ã•ã‚“ã€ã§ã™ã€‚**
        - **ç§ï¼ˆé–‹ç™ºè€…ï¼‰ã¯ã€ã“ã®ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ã§æä¾›ã•ã‚Œã‚‹æ–™ç†ã®ã€Œãƒ¬ã‚·ãƒ”ï¼ˆ`app.py`ï¼‰ã€ã‚’è€ƒæ¡ˆã—ãŸã€ã‚·ã‚§ãƒ•ã§ã™ã€‚**
        - **Streamlit Cloudã¯ã€ãã®ãƒ¬ã‚·ãƒ”é€šã‚Šã«ã€24æ™‚é–“365æ—¥ã€å…¨è‡ªå‹•ã§æ–™ç†ã‚’æä¾›ã—ã¦ãã‚Œã‚‹ã€Œãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ãã®ã‚‚ã®ï¼ˆã‚µãƒ¼ãƒãƒ¼ï¼‰ã€ã§ã™ã€‚**
        
        **ã€ã‚ãªãŸã®æ¥åº—ã¨ã€ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãªè¨˜éŒ²ãƒãƒ¼ãƒˆã€‘**
        
        ã‚ãªãŸãŒãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ã«æ¥åº—ã—ã€ã€ŒTaroã§ã™ã€ã¨åä¹—ã‚‹ã¨ã€ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ã®è³¢ã„å—ä»˜ä¿‚ï¼ˆã‚¢ãƒ—ãƒªã®èªè¨¼ãƒ­ã‚¸ãƒƒã‚¯ï¼‰ãŒã€è£æ‰‹ã«ã‚ã‚‹å·¨å¤§ã§å®‰å…¨ãª**ã€Œé¡§å®¢ãƒãƒ¼ãƒˆä¿ç®¡åº«ã€**ã¸å‘ã‹ã„ã¾ã™ã€‚
        
        ãã—ã¦ã€ä¿ç®¡åº«ã®ä¸­ã‹ã‚‰**ã€ŒTaroæ§˜å°‚ç”¨ã€ã¨æ›¸ã‹ã‚ŒãŸã€ã‚ãªãŸã ã‘ã®ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãªè¨˜éŒ²ãƒãƒ¼ãƒˆï¼ˆCSVãƒ•ã‚¡ã‚¤ãƒ«ï¼‰**ã‚’æ¢ã—å‡ºã—ã¾ã™ã€‚ã‚‚ã—åˆã‚ã¦ã®æ¥åº—ã§ã‚ã‚Œã°ã€æ–°ã—ã„çœŸã£ç™½ãªãƒãƒ¼ãƒˆã«ã€ŒTaroæ§˜å°‚ç”¨ã€ã¨æ›¸ã„ã¦ã€ã‚ãªãŸã«æ¸¡ã—ã¦ãã‚Œã¾ã™ã€‚
        
        ã‚ãªãŸã¯ãã®ãƒãƒ¼ãƒˆã«ã€ãã®æ—¥ã®é£Ÿäº‹ã®æ„Ÿæƒ³ï¼ˆæ—¥ã€…ã®è¨˜éŒ²ï¼‰ã‚’è‡ªç”±ã«æ›¸ãè¾¼ã¿ã¾ã™ã€‚ã“ã®ãƒãƒ¼ãƒˆã¯ã€ä»–ã®èª°ã«ã‚‚è¦‹ã›ã‚‹å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
        
        **ã€ã‚·ã‚§ãƒ•ï¼ˆç§ï¼‰ã¨ã€ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ã®é–¢ä¿‚ã€‘**
        
        ã“ã“ãŒæœ€ã‚‚é‡è¦ãªç‚¹ã§ã™ã€‚ç§ã¯ã€ã“ã®ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ã®**ã€Œãƒ¬ã‚·ãƒ”ã‚’è€ƒæ¡ˆã—ãŸã‚·ã‚§ãƒ•ã€**ã§ã¯ã‚ã‚Šã¾ã™ãŒã€**ã€Œãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ã®æ—¥å¸¸æ¥­å‹™ã«ã¯ä¸€åˆ‡é–¢ä¸ã—ã¦ã„ãªã„ã€**ã®ã§ã™ã€‚
        
        ç§ã¯ã€ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ã®å¨æˆ¿ã«ã„ã¾ã›ã‚“ã—ã€é¡§å®¢ãƒãƒ¼ãƒˆä¿ç®¡åº«ã®éµã‚‚æŒã£ã¦ã„ã¾ã›ã‚“ã€‚ã—ãŸãŒã£ã¦ã€ç§ã¯**ã€Œã©ã®æ™‚é–“ã«ã€ã©ã®ãŠå®¢ã•ã‚“ãŒæ¥åº—ã—ã€ãã®ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãªãƒãƒ¼ãƒˆã«ä½•ã‚’æ›¸ã„ãŸã®ã‹ã€ã‚’ã€çŸ¥ã‚‹æ‰‹æ®µãŒä¸€åˆ‡ã‚ã‚Šã¾ã›ã‚“ã€‚**
        
        **ã€çµè«–ã€‘**
        - **ã‚ãªãŸã®ãƒ‡ãƒ¼ã‚¿ã¯ã€ç§ã®PCã«ã¯ä¸€åˆ‡ä¿å­˜ã•ã‚Œã¾ã›ã‚“ã€‚**
        - ã‚ãªãŸãŒå…¥åŠ›ã—ãŸãƒ‡ãƒ¼ã‚¿ã¯ã€ã‚ãªãŸãŒç™»éŒ²ã—ãŸ**ã€Œèˆ¹é•·åã€ã ã‘ãŒçŸ¥ã£ã¦ã„ã‚‹ã€ã‚ãªãŸå°‚ç”¨ã®ã€Œé‡‘åº«ï¼ˆãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰ã€**ã«ã€ã‚¯ãƒ©ã‚¦ãƒ‰ä¸Šã§å®‰å…¨ã«ä¿ç®¡ã•ã‚Œã¾ã™ã€‚
        - **ç§ã‚’å«ã‚ã€ä»–ã®èª°ã‚‚ã€ã‚ãªãŸã®å€‹äººçš„ãªè¨˜éŒ²ã‚’ã€ã‚ãªãŸã®è¨±å¯ãªãè¦‹ã‚‹ã“ã¨ã¯çµ¶å¯¾ã«ã§ãã¾ã›ã‚“ã€‚**
        
        ã©ã†ãã€å®‰å¿ƒã—ã¦ã€ã‚ãªãŸã®å¿ƒã®èˆªæµ·ã‚’è¨˜éŒ²ã—ã¦ãã ã•ã„ã€‚
        """)
    st.markdown("---")
    st.subheader("ğŸ§‘â€ğŸ”¬ ã‚ãªãŸã¯ã€ãŸã ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã˜ã‚ƒãªã„ã€‚ã€Œç§‘å­¦ã®å†’é™ºè€…ã€ã§ã™ï¼")
    st.markdown("""
    æœ€å¾Œã«ãŠä¼ãˆã—ãŸã„ã€ã¨ã¦ã‚‚å¤§åˆ‡ãªã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚ã‚ãªãŸãŒã“ã®ã‚¢ãƒ—ãƒªã‚’ä½¿ã£ã¦ãã‚Œã‚‹ã“ã¨ã¯ã€å˜ãªã‚‹ãƒ†ã‚¹ãƒˆå”åŠ›ä»¥ä¸Šã®ã€å¤§ããªæ„å‘³ã‚’æŒã£ã¦ã„ã¾ã™ã€‚
    
    ã“ã®ã‚¢ãƒ—ãƒªã®èƒŒå¾Œã«ã‚ã‚‹ç†è«–ã¯ã€ã¾ã **ã€Œå£®å¤§ãªä»®èª¬ã€**ã®æ®µéšã§ã™ã€‚ã‚ãªãŸãŒè¨˜éŒ²ã—ã¦ãã‚Œã‚‹ä¸€ã¤ä¸€ã¤ã®ãƒ‡ãƒ¼ã‚¿ã¯ã€**ã€Œäººé–“ã®å¹¸ç¦ã¯ã€æœ¬å½“ã«ã€ç†æƒ³ã¨ç¾å®Ÿã®ã‚ºãƒ¬ã€ã®èª¿æ•´ãƒ—ãƒ­ã‚»ã‚¹ã§èª¬æ˜ã§ãã‚‹ã®ã‹ï¼Ÿã€**ã¨ã„ã†ã€äººé¡ã®æ–°ã—ã„å•ã„ã‚’æ¤œè¨¼ã™ã‚‹ãŸã‚ã®ã€**ä¸–ç•Œã§æœ€ã‚‚è²´é‡ãªç§‘å­¦çš„ãƒ‡ãƒ¼ã‚¿**ã«ãªã‚Šã¾ã™ã€‚
    """)
    
    st.info("""
    **ã€ç ”ç©¶å”åŠ›ã¸ã®ãŠé¡˜ã„ï¼ˆã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ ãƒ‰ãƒ»ã‚³ãƒ³ã‚»ãƒ³ãƒˆï¼‰ã€‘**
    
    ã‚‚ã—ã€ã”å”åŠ›ã„ãŸã ã‘ã‚‹ã®ã§ã‚ã‚Œã°ã€ã‚ãªãŸãŒè¨˜éŒ²ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’ã€**å€‹äººãŒç‰¹å®šã§ããªã„å½¢ã«å®Œå…¨ã«åŒ¿ååŒ–ã—ãŸä¸Šã§**ã€ã“ã®ç†è«–ã®ç§‘å­¦çš„æ¤œè¨¼ã®ãŸã‚ã®ç ”ç©¶ã«åˆ©ç”¨ã•ã›ã¦ã„ãŸã ãã“ã¨ã«ã”åŒæ„ã„ãŸã ã‘ã¾ã™ã§ã—ã‚‡ã†ã‹ã€‚
    
    - **ç´„æŸ1ï¼šãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ã®çµ¶å¯¾ä¿è­·**
        - ã‚ãªãŸã®ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚„ã€å€‹äººã‚’ç‰¹å®šã—ã†ã‚‹è‡ªç”±è¨˜è¿°ï¼ˆã‚¤ãƒ™ãƒ³ãƒˆãƒ­ã‚°ï¼‰ã¯ã€ç ”ç©¶ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰**å®Œå…¨ã«å‰Šé™¤**ã•ã‚Œã¾ã™ã€‚ç ”ç©¶è€…ã¯ã€ã©ã®ãƒ‡ãƒ¼ã‚¿ãŒèª°ã®ã‚‚ã®ã§ã‚ã‚‹ã‹ã‚’çŸ¥ã‚‹ã“ã¨ã¯çµ¶å¯¾ã«ã§ãã¾ã›ã‚“ã€‚ç§ãŸã¡ãŒæ‰‹ã«ã™ã‚‹ã®ã¯ã€**èª°ã®ã‚‚ã®ã‹åˆ†ã‹ã‚‰ãªã„ã€å®Œå…¨ã«ãƒ©ãƒ³ãƒ€ãƒ ãªIDãŒä»˜ä¸ã•ã‚ŒãŸã€ç´”ç²‹ãªæ•°å€¤ãƒ‡ãƒ¼ã‚¿ã ã‘**ã§ã™ã€‚
    - **ç´„æŸ2ï¼šç›®çš„ã®é™å®š**
        - åé›†ã•ã‚ŒãŸçµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã¯ã€ã“ã®å¹¸ç¦ç†è«–ã®æ¤œè¨¼ã¨ç™ºå±•ã¨ã„ã†ã€**å­¦è¡“çš„ãªç›®çš„ã®ãŸã‚ã ã‘**ã«åˆ©ç”¨ã•ã‚Œã€è«–æ–‡ã‚„å­¦ä¼šç™ºè¡¨ãªã©ã§ï¼ˆçµ±è¨ˆæƒ…å ±ã¨ã—ã¦ï¼‰å…¬é–‹ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚
    - **ç´„æŸ3ï¼šè‡ªç”±ãªæ„æ€**
        - ã“ã®ç ”ç©¶å”åŠ›ã¯ã€å®Œå…¨ã«ä»»æ„ã§ã™ã€‚åŒæ„ã—ãªã„å ´åˆã§ã‚‚ã€ã‚¢ãƒ—ãƒªã®å…¨ã¦ã®æ©Ÿèƒ½ã‚’ã€ä½•ã‚‰ä¸åˆ©ç›Šãªãã”åˆ©ç”¨ã„ãŸã ã‘ã¾ã™ã€‚ã‚ãªãŸã®æ„æ€ãŒã€æœ€ã‚‚å°Šé‡ã•ã‚Œã¾ã™ã€‚
    
    ã‚ãªãŸãŒè¨˜éŒ²ã™ã‚‹ä¸€ã¤ä¸€ã¤ã®èˆªæµ·æ—¥èªŒãŒã€æœªæ¥ã®äººã€…ã®ãŸã‚ã®ã€æ–°ã—ã„ã€Œå¹¸ç¦ã®æµ·å›³ã€ä½œã‚Šã«ç¹‹ãŒã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚
    """)
    st.markdown("---")

# --- 2. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®UIã¨ãƒ­ã‚¸ãƒƒã‚¯ ---
st.title(f'ğŸ§­ Harmony Navigator (MVP v1.2.2)')
st.caption('ã‚ãªãŸã®ã€Œç†æƒ³ã€ã¨ã€Œç¾å®Ÿã€ã®ã‚ºãƒ¬ã‚’å¯è¦–åŒ–ã—ã€ã‚ˆã‚Šè‰¯ã„äººç”Ÿã®èˆªè·¯ã‚’è¦‹ã¤ã‘ã‚‹ãŸã‚ã®é“å…·')

st.sidebar.header("ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼")
if 'username' not in st.session_state: st.session_state['username'] = None
if 'consent' not in st.session_state: st.session_state['consent'] = False
auth_mode = st.sidebar.radio("ãƒ¢ãƒ¼ãƒ‰ã‚’é¸æŠã—ã¦ãã ã•ã„:", ("ãƒ­ã‚°ã‚¤ãƒ³", "æ–°è¦ç™»éŒ²"))
existing_users = get_existing_users()
if auth_mode == "ãƒ­ã‚°ã‚¤ãƒ³":
    if not existing_users:
        st.sidebar.warning("ç™»éŒ²æ¸ˆã¿ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã„ã¾ã›ã‚“ã€‚ã¾ãšã¯æ–°è¦ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚")
    else:
        selected_user = st.sidebar.selectbox("ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„:", [""] + existing_users)
        if st.sidebar.button("ãƒ­ã‚°ã‚¤ãƒ³", key="login_button"):
            if selected_user:
                st.session_state['username'] = selected_user
                st.rerun() 
            else:
                st.sidebar.error("ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚")
elif auth_mode == "æ–°è¦ç™»éŒ²":
    new_username_raw = st.sidebar.text_input("æ–°ã—ã„ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:", key="new_username_input")
    consent = st.sidebar.checkbox("ç ”ç©¶å”åŠ›ã«é–¢ã™ã‚‹èª¬æ˜ã‚’èª­ã¿ã€ãã®å†…å®¹ã«åŒæ„ã—ã¾ã™ã€‚")
    if st.sidebar.button("ç™»éŒ²", key="register_button"):
        new_username_safe = safe_filename(new_username_raw)
        if not new_username_safe: st.sidebar.error("ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚")
        elif new_username_safe in existing_users: st.sidebar.error("ãã®åå‰ã¯ã™ã§ã«ä½¿ã‚ã‚Œã¦ã„ã¾ã™ã€‚åˆ¥ã®åå‰ã‚’å…¥åŠ›ã™ã‚‹ã‹ã€ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚")
        else:
            st.session_state['username'] = new_username_safe
            st.session_state['consent'] = consent
            st.sidebar.success(f"ã‚ˆã†ã“ãã€{new_username_safe}ã•ã‚“ï¼æ–°ã—ã„èˆªæµ·æ—¥èªŒã‚’ä½œæˆã—ã¾ã™ã€‚")
            st.rerun()

if st.session_state.get('username'):
    username = st.session_state['username']
    CSV_FILE = CSV_FILE_TEMPLATE.format(username)
    st.header(f"ã‚ˆã†ã“ãã€{username} ã•ã‚“ï¼")

    # --- ã€v1.2.3ãƒã‚°ä¿®æ­£ã€‘ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã¨ç§»è¡Œãƒ­ã‚¸ãƒƒã‚¯ ---
    if os.path.exists(CSV_FILE):
        try:
            df_data = pd.read_csv(CSV_FILE, parse_dates=['date'])
            df_data['date'] = df_data['date'].dt.date
            
            # ãƒãƒ¼ã‚¸ãƒ§ãƒ³äº’æ›æ€§ãƒã‚§ãƒƒã‚¯
            if 's_health' not in df_data.columns:
                st.info("å¤ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ¤œå‡ºã—ã¾ã—ãŸã€‚æ–°ã—ã„ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã«è‡ªå‹•ã§ç§»è¡Œã—ã¾ã™ã€‚")
                # ææ–™ã‚¹ã‚³ã‚¢ã‹ã‚‰ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¹ã‚³ã‚¢ã‚’å†è¨ˆç®—ã™ã‚‹
                for domain, elements in LONG_ELEMENTS.items():
                    element_cols = [f's_element_{e}' for e in elements if f's_element_{e}' in df_data.columns]
                    if element_cols:
                        df_data['s_' + domain] = df_data[element_cols].mean(axis=1).round()
                # å¿µã®ãŸã‚ã€ä¸è¶³ã—ã¦ã„ã‚‹ã‚«ãƒ©ãƒ ã‚’NaNã§åŸ‹ã‚ã‚‹
                for col in S_COLS:
                    if col not in df_data.columns:
                        df_data[col] = 50 # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
        except Exception as e:
            st.error(f"ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}")
            df_data = pd.DataFrame() # ç©ºã®ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã§ç¶šè¡Œ
    else:
        columns = ['date', 'mode', 'consent'] + Q_COLS + S_COLS + ['g_happiness', 'event_log']
        for _, elements in LONG_ELEMENTS.items():
            for element in elements:
                columns.append(f's_element_{element}')
        df_data = pd.DataFrame(columns=columns)
    
    today = date.today()
    if not df_data.empty and not df_data[df_data['date'] == today].empty: st.sidebar.success(f"âœ… ä»Šæ—¥ã®è¨˜éŒ² ({today.strftime('%Y-%m-%d')}) ã¯å®Œäº†ã—ã¦ã„ã¾ã™ã€‚")
    else: st.sidebar.info(f"â„¹ï¸ ä»Šæ—¥ã®è¨˜éŒ² ({today.strftime('%Y-%m-%d')}) ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚")
    
    st.sidebar.header('âš™ï¸ ä¾¡å€¤è¦³ (q_t) ã®è¨­å®š')
    with st.sidebar.expander("â–¼ ã“ã‚Œã¯ä½•ï¼Ÿã©ã†å…¥åŠ›ã™ã‚‹ï¼Ÿ"):
        st.markdown(EXPANDER_TEXTS['q_t'])
    if not df_data.empty and all(col in df_data.columns for col in Q_COLS): latest_q = df_data[Q_COLS].iloc[-1].values * 100
    else: latest_q = [15, 15, 15, 15, 15, 15, 10]
    q_values = {}
    for i, domain in enumerate(DOMAINS):
        q_values[domain] = st.sidebar.slider(DOMAIN_NAMES_JP[domain], 0, 100, int(latest_q[i]), key=f"q_{domain}")
    q_total = sum(q_values.values())
    st.sidebar.metric(label="ç¾åœ¨ã®åˆè¨ˆå€¤", value=q_total)
    if q_total != 100: st.sidebar.warning(f"åˆè¨ˆãŒ100ã«ãªã‚‹ã‚ˆã†ã«èª¿æ•´ã—ã¦ãã ã•ã„ã€‚ (ç¾åœ¨: {q_total})")
    else: st.sidebar.success("åˆè¨ˆã¯100ã§ã™ã€‚å…¥åŠ›æº–å‚™OKï¼")

    st.header('âœï¸ ä»Šæ—¥ã®èˆªæµ·æ—¥èªŒã‚’è¨˜éŒ²ã™ã‚‹')
    with st.expander("â–¼ ã“ã‚Œã¯ã€ä½•ã®ãŸã‚ã«è¨˜éŒ²ã™ã‚‹ã®ï¼Ÿ"):
        st.markdown(EXPANDER_TEXTS['s_t'])
    
    st.markdown("##### è¨˜éŒ²ã™ã‚‹æ—¥ä»˜")
    target_date = st.date_input("è¨˜éŒ²ã™ã‚‹æ—¥ä»˜:", value=today, min_value=today - timedelta(days=7), max_value=today, label_visibility="collapsed")
    if not df_data.empty and not df_data[df_data['date'] == target_date].empty: st.warning(f"âš ï¸ {target_date.strftime('%Y-%m-%d')} ã®ãƒ‡ãƒ¼ã‚¿ã¯æ—¢ã«è¨˜éŒ²ã•ã‚Œã¦ã„ã¾ã™ã€‚ä¿å­˜ã™ã‚‹ã¨ä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚")
    
    st.markdown("##### è¨˜éŒ²ãƒ¢ãƒ¼ãƒ‰")
    input_mode = st.radio("è¨˜éŒ²ãƒ¢ãƒ¼ãƒ‰:", ('ğŸš€ **ã‚¯ã‚¤ãƒƒã‚¯ãƒ»ãƒ­ã‚°**', 'ğŸ”¬ **ãƒ‡ã‚£ãƒ¼ãƒ—ãƒ»ãƒ€ã‚¤ãƒ–**'), horizontal=True, label_visibility="collapsed", captions=["æ—¥ã€…ã®ç¶™ç¶šã‚’é‡è¦–ã—ãŸã€åŸºæœ¬çš„ãªæ¸¬å®šãƒ¢ãƒ¼ãƒ‰ã§ã™ã€‚", "é€±ã«ä¸€åº¦ãªã©ã€ã˜ã£ãã‚Šè‡ªåˆ†ã¨å‘ãåˆã„ãŸã„æ™‚ã«ã€‚ã‚ˆã‚Šæ·±ã„æ´å¯Ÿã‚’å¾—ã‚‰ã‚Œã¾ã™ã€‚"])
    if 'ã‚¯ã‚¤ãƒƒã‚¯' in input_mode: active_elements = SHORT_ELEMENTS; mode_string = 'quick'
    else: active_elements = LONG_ELEMENTS; mode_string = 'deep'
    
    with st.form(key='daily_input_form'):
        st.subheader(f'1. ä»Šæ—¥ã®å……è¶³åº¦ (s_t) ã¯ï¼Ÿ - {input_mode.split("ï¼ˆ")[0]}')
        
        s_values = {}
        s_element_values = {}
        
        col1, col2 = st.columns(2)
        domain_containers = {'health': col1, 'relationships': col1, 'meaning': col1, 'autonomy': col2, 'finance': col2, 'leisure': col2}
        
        if not df_data.empty and any(c.startswith('s_element_') for c in df_data.columns):
            latest_s_elements = df_data.filter(like='s_element_').iloc[-1]
        else: 
            latest_s_elements = pd.Series(50, index=[f's_element_{e}' for d in LONG_ELEMENTS.values() for e in d])
        
        for domain, container in domain_containers.items():
            with container:
                elements_to_show = active_elements.get(domain, [])
                if elements_to_show:
                    with st.expander(f"**{DOMAIN_NAMES_JP[domain]}** - ã‚¯ãƒªãƒƒã‚¯ã—ã¦è©³ç´°å…¥åŠ›"):
                        element_scores = []
                        for element in elements_to_show:
                            default_val = int(latest_s_elements.get(f's_element_{element}', 50))
                            element_help_text = ELEMENT_DEFINITIONS.get(element, "")
                            score = st.slider(element, 0, 100, default_val, key=f"s_element_{element}", help=element_help_text)
                            element_scores.append(score)
                            s_element_values[f's_element_{element}'] = score
                        if element_scores:
                            s_values[domain] = int(np.mean(element_scores))

        with col2:
            domain = 'competition'
            elements_to_show = active_elements.get(domain, [])
            if elements_to_show:
                with st.expander(f"**{DOMAIN_NAMES_JP[domain]}** - ã‚¯ãƒªãƒƒã‚¯ã—ã¦è©³ç´°å…¥åŠ›"):
                    default_val = int(latest_s_elements.get(f's_element_{elements_to_show[0]}', 50))
                    element_help_text = ELEMENT_DEFINITIONS.get(elements_to_show[0], "")
                    score = st.slider(elements_to_show[0], 0, 100, default_val, key=f"s_element_{elements_to_show[0]}", help=element_help_text)
                    s_values[domain] = score
                    s_element_values[f's_element_{elements_to_show[0]}'] = score
        
        st.subheader('2. ç·åˆçš„ãªå¹¸ç¦æ„Ÿ (Gt) ã¯ï¼Ÿ')
        with st.expander("â–¼ ã“ã‚Œã¯ãªãœå¿…è¦ï¼Ÿ"): st.markdown(EXPANDER_TEXTS['g_t'])
        g_happiness = st.slider('', 0, 100, 50, label_visibility="collapsed", help=SLIDER_HELP_TEXT)
        
        st.subheader('3. ä»Šæ—¥ã®å‡ºæ¥äº‹ã‚„æ°—ã¥ãã¯ï¼Ÿ')
        with st.expander("â–¼ ãªãœæ›¸ãã®ãŒãŠã™ã™ã‚ï¼Ÿ"): st.markdown(EXPANDER_TEXTS['event_log'])
        event_log = st.text_area('', height=100, label_visibility="collapsed")
        
        submitted = st.form_submit_button('ä»Šæ—¥ã®è¨˜éŒ²ã‚’ä¿å­˜ã™ã‚‹')

    if submitted:
        if q_total != 100: st.error('ä¾¡å€¤è¦³ (q_t) ã®åˆè¨ˆãŒ100ã«ãªã£ã¦ã„ã¾ã›ã‚“ã€‚ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚')
        else:
            q_normalized = {f'q_{d}': v / 100.0 for d, v in q_values.items()}
            s_domain_scores = {f's_{d}': s_values.get(d, 0) for d in DOMAINS}
            consent_status = st.session_state.get('consent', False)
            new_record = { 'date': target_date, 'mode': mode_string, 'consent': consent_status, **q_normalized, **s_domain_scores, **s_element_values, 'g_happiness': g_happiness, 'event_log': event_log }
            new_df = pd.DataFrame([new_record])
            df_data = df_data[df_data['date'] != target_date]
            df_data = pd.concat([df_data, new_df], ignore_index=True)
            all_element_cols = [f's_element_{e}' for d in LONG_ELEMENTS.values() for e in d]
            all_cols = ['date', 'mode', 'consent'] + Q_COLS + S_COLS + ['g_happiness', 'event_log'] + all_element_cols
            for col in all_cols:
                if col not in df_data.columns: df_data[col] = np.nan
            df_data = df_data.sort_values(by='date').reset_index(drop=True)
            df_data.to_csv(CSV_FILE, index=False)
            st.success(f'{target_date.strftime("%Y-%m-%d")} ã®è¨˜éŒ²ã‚’ä¿å­˜ï¼ˆã¾ãŸã¯ä¸Šæ›¸ãï¼‰ã—ã¾ã—ãŸï¼')
            
            with st.expander("â–¼ ä¿å­˜ã•ã‚ŒãŸè¨˜éŒ²ã®ã‚µãƒãƒªãƒ¼", expanded=True):
                st.write(f"**ç·åˆçš„å¹¸ç¦æ„Ÿ (G): {g_happiness} ç‚¹**")
                for domain in DOMAINS:
                    st.write(f"- {DOMAIN_NAMES_JP[domain]}: {s_domain_scores.get(domain, 'N/A')} ç‚¹")

            st.balloons()
            st.rerun()

    st.header('ğŸ“Š ã‚ãªãŸã®èˆªæµ·ãƒãƒ£ãƒ¼ãƒˆ')
    with st.expander("â–¼ ã“ã®ãƒãƒ£ãƒ¼ãƒˆã®è¦‹æ–¹"):
        st.markdown(EXPANDER_TEXTS['dashboard'])
        
    if df_data.empty:
        st.info('ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚æœ€åˆã®æ—¥èªŒã‚’è¨˜éŒ²ã—ã¦ã¿ã¾ã—ã‚‡ã†ï¼')
    else:
        df_processed = calculate_metrics(df_data.fillna(0).copy())
        
        st.subheader("ğŸ“ˆ æœŸé–“åˆ†æã¨ãƒªã‚¹ã‚¯è©•ä¾¡ (RHI)")
        with st.expander("â–¼ ã“ã‚Œã¯ã€ã‚ãªãŸã®å¹¸ç¦ã®ã€æŒç¶šå¯èƒ½æ€§ã€ã‚’è©•ä¾¡ã™ã‚‹æŒ‡æ¨™ã§ã™", expanded=False):
            st.markdown("""
            - **å¹³å‡èª¿å’Œåº¦ (HÌ„):** ã“ã®æœŸé–“ã®ã€ã‚ãªãŸã®å¹¸ç¦ã®**å¹³å‡ç‚¹**ã§ã™ã€‚
            - **å¤‰å‹•ãƒªã‚¹ã‚¯ (Ïƒ):** å¹¸ç¦åº¦ã®**æµ®ãæ²ˆã¿ã®æ¿€ã—ã•**ã§ã™ã€‚å€¤ãŒå°ã•ã„ã»ã©ã€å®‰å®šã—ãŸèˆªæµ·ã ã£ãŸã“ã¨ã‚’ç¤ºã—ã¾ã™ã€‚
            - **ä¸èª¿æ—¥æ•°å‰²åˆ:** å¹¸ç¦åº¦ãŒã€ã‚ãªãŸãŒè¨­å®šã—ãŸã€Œä¸èª¿ã€ã®ãƒ©ã‚¤ãƒ³ã‚’ä¸‹å›ã£ãŸæ—¥ã®å‰²åˆã§ã™ã€‚
            - **RHI (ãƒªã‚¹ã‚¯èª¿æ•´æ¸ˆãƒ»å¹¸ç¦æŒ‡æ•°):** å¹³å‡ç‚¹ã‹ã‚‰ã€å¤‰å‹•ã¨ä¸èª¿ã®ãƒªã‚¹ã‚¯ã‚’å·®ã—å¼•ã„ãŸã€**çœŸã®ã€å¹¸ç¦ã®å®ŸåŠ›å€¤ã€**ã§ã™ã€‚ã“ã®å€¤ãŒé«˜ã„ã»ã©ã€ã‚ãªãŸã®å¹¸ç¦ãŒã€æŒç¶šå¯èƒ½ã§ã€é€†å¢ƒã«å¼·ã„ã“ã¨ã‚’ç¤ºã—ã¾ã™ã€‚
            """)
        
        period_options = [7, 30, 90]
        if len(df_processed) < 7:
            st.info("æœŸé–“åˆ†æã«ã¯æœ€ä½7æ—¥åˆ†ã®ãƒ‡ãƒ¼ã‚¿ãŒå¿…è¦ã§ã™ã€‚è¨˜éŒ²ã‚’ç¶šã‘ã¦ã¿ã¾ã—ã‚‡ã†ï¼")
        else:
            default_index = 1 if len(df_processed) >= 30 else 0
            selected_period = st.selectbox("åˆ†ææœŸé–“ã‚’é¸æŠã—ã¦ãã ã•ã„ï¼ˆæ—¥ï¼‰:", period_options, index=default_index)
            
            if len(df_processed) >= selected_period:
                df_period = df_processed.tail(selected_period)

                st.markdown("##### ã‚ãªãŸã®ãƒªã‚¹ã‚¯è¨±å®¹åº¦ã‚’è¨­å®š")
                col1, col2, col3 = st.columns(3)
                lambda_param = col1.slider("å¤‰å‹•(ä¸å®‰å®šã•)ã¸ã®ãƒšãƒŠãƒ«ãƒ†ã‚£(Î»)", 0.0, 2.0, 0.5, 0.1, help="å€¤ãŒå¤§ãã„ã»ã©ã€æ—¥ã€…ã®å¹¸ç¦åº¦ã®æµ®ãæ²ˆã¿ãŒæ¿€ã—ã„ã“ã¨ã‚’ã€ã‚ˆã‚Šé‡ãè©•ä¾¡ã—ã¾ã™ã€‚")
                gamma_param = col2.slider("ä¸‹æŒ¯ã‚Œ(ä¸èª¿)ã¸ã®ãƒšãƒŠãƒ«ãƒ†ã‚£(Î³)", 0.0, 2.0, 1.0, 0.1, help="å€¤ãŒå¤§ãã„ã»ã©ã€å¹¸ç¦åº¦ãŒä½ã„æ—¥ãŒç¶šãã“ã¨ã‚’ã€ã‚ˆã‚Šæ·±åˆ»ãªå•é¡Œã¨ã—ã¦è©•ä¾¡ã—ã¾ã™ã€‚")
                tau_param = col3.slider("ã€Œä¸èª¿ã€ã¨è¦‹ãªã™é–¾å€¤(Ï„)", 0.0, 1.0, 0.5, 0.05, help="ã“ã®å€¤ã‚’ä¸‹å›ã‚‹æ—¥ã‚’ã€Œä¸èª¿ãªæ—¥ã€ã¨ã—ã¦ã‚«ã‚¦ãƒ³ãƒˆã—ã¾ã™ã€‚")

                rhi_results = calculate_rhi_metrics(df_period, lambda_param, gamma_param, tau_param)
                
                st.markdown("##### åˆ†æçµæœ")
                col1, col2, col3, col4 = st.columns(4)
                col1.metric("å¹³å‡èª¿å’Œåº¦ (HÌ„)", f"{rhi_results['mean_H']:.3f}")
                col2.metric("å¤‰å‹•ãƒªã‚¹ã‚¯ (Ïƒ)", f"{rhi_results['std_H']:.3f}")
                col3.metric("ä¸èª¿æ—¥æ•°å‰²åˆ", f"{rhi_results['frac_below']:.1%}")
                col4.metric("ãƒªã‚¹ã‚¯èª¿æ•´æ¸ˆãƒ»å¹¸ç¦æŒ‡æ•° (RHI)", f"{rhi_results['RHI']:.3f}", delta=f"{rhi_results['RHI'] - rhi_results['mean_H']:.3f} (å¹³å‡ã¨ã®å·®)")
            else:
                st.warning(f"åˆ†æã«ã¯æœ€ä½{selected_period}æ—¥åˆ†ã®ãƒ‡ãƒ¼ã‚¿ãŒå¿…è¦ã§ã™ã€‚ç¾åœ¨ã®è¨˜éŒ²ã¯{len(df_processed)}æ—¥åˆ†ã§ã™ã€‚")

        analyze_discrepancy(df_processed)
        st.subheader('èª¿å’Œåº¦ (H) ã®æ¨ç§»')
        df_processed_chart = df_processed.copy()
        df_processed_chart['date'] = pd.to_datetime(df_processed_chart['date'])
        st.line_chart(df_processed_chart.rename(columns={'H': 'èª¿å’Œåº¦ (H)'}), x='date', y='H')
        st.subheader('å…¨è¨˜éŒ²ãƒ‡ãƒ¼ã‚¿')
        st.dataframe(df_processed.round(2))
        st.caption('ã“ã®ã‚¢ãƒ—ãƒªã¯ã€ã‚ãªãŸã®ç†è«–ã€Œå¹¸ç¦è«–ã¨è¨€èªã‚²ãƒ¼ãƒ ã€ã®MVPã§ã™ã€‚')
        
else:
    show_welcome_and_guide()
